<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consolida Torre | Mapeamento de Contatos</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230045B5'/%3E%3Cstop offset='100%25' stop-color='%230068FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ccircle cx='30' cy='30' r='12' fill='%23FFD100'/%3E%3Ccircle cx='70' cy='30' r='12' fill='%23FFD100'/%3E%3Ccircle cx='30' cy='70' r='12' fill='%23FFD100'/%3E%3Ccircle cx='70' cy='70' r='12' fill='%23FFD100'/%3E%3Ccircle cx='50' cy='50' r='18' fill='white'/%3E%3Cpath d='M30 30 L50 50 M70 30 L50 50 M30 70 L50 50 M70 70 L50 50' stroke='%23FFD100' stroke-width='4' stroke-linecap='round'/%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>


<script>
moment.locale('pt-br', {
    weekdaysShort : ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"]
});
</script>
<style>
/* ===== CSS REFATORADO - Design Premium 2025 ===== */
/* ===== VARIÁVEIS E RESET ===== */
:root {
    /* Cores da marca - Versão Dark Modern */
    --brand-blue: #3D8DFF;
    --brand-blue-light: #6CABFF;
    --brand-blue-dark: #1A5CE0;
    --brand-yellow: #FFD166;
    --brand-yellow-light: #FFE4A1;
    --brand-orange: #FF7A45;
    --brand-orange-light: #FF9E76;
    --success-green: #00C9A7;
    --success-green-light: #4CE4C9;
    --error-red: #FF4757;
    --warning: #FFA93D;
    --purple: #9D4EDD;
    --purple-light: #BB86FC;
    --purple-dark: #7B2CBF;
    
    /* Gradientes Premium */
    --gradient-primary: linear-gradient(135deg, #3D8DFF 0%, #1A5CE0 100%);
    --gradient-secondary: linear-gradient(135deg, #FF7A45 0%, #FF3E00 100%);
    --gradient-success: linear-gradient(135deg, #00C9A7 0%, #008B74 100%);
    --gradient-warning: linear-gradient(135deg, #FFD166 0%, #FFB347 100%);
    --gradient-purple: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);
    --gradient-dark: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
    --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
    
    /* Backgrounds */
    --bg-primary: #0F0F1A;
    --bg-card: #1A1B2E;
    --bg-card-hover: #212238;
    --bg-sidebar: #151626;
    --bg-header: var(--gradient-dark);
    --bg-overlay: rgba(15, 15, 26, 0.95);
    
    /* Textos */
    --text-primary: #FFFFFF;
    --text-secondary: #B8B9C7;
    --text-muted: #8B8D9E;
    --text-light: #A0AEC0;
    
    /* Bordas */
    --border-primary: rgba(255, 255, 255, 0.08);
    --border-light: rgba(255, 255, 255, 0.12);
    --border-accent: rgba(61, 141, 255, 0.25);
    --border-glass: rgba(255, 255, 255, 0.1);
    
    /* Sombras */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.5);
    --shadow-xl: 0 15px 50px rgba(0, 0, 0, 0.6);
    --shadow-glow: 0 0 20px rgba(61, 141, 255, 0.3);
    --shadow-card: 0 8px 25px rgba(0, 0, 0, 0.4);
    
    /* Glassmorphism */
    --glass-bg: rgba(26, 27, 46, 0.7);
    --glass-border: rgba(255, 255, 255, 0.15);
    --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
    
    /* Layout */
    --sidebar-collapsed: 80px;
    --sidebar-expanded: 320px;
    --header-height: 70px;
    --kpi-sticky-height: 190px;
    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 20px;
    --radius-xl: 24px;
    --radius-full: 999px;
    
    /* Transições */
    --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Tipografia */
    --font-primary: 'Inter', sans-serif;
    --font-secondary: 'Montserrat', sans-serif;
}

/* TEMA CLARO - CORRIGIDO PARA FICAR TOTALMENTE CLARO */
.light-theme {
    --bg-primary: #F8FAFF;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F8FAFF;
    --bg-sidebar: #FFFFFF;
    --bg-header: var(--gradient-primary);
    --bg-overlay: rgba(255, 255, 255, 0.95);
    --text-primary: #1A1B2E;
    --text-secondary: #5A5D72;
    --text-muted: #8B8D9E;
    --text-light: #6B7280;
    --border-primary: rgba(0, 0, 0, 0.08);
    --border-light: rgba(0, 0, 0, 0.12);
    --border-accent: rgba(0, 69, 181, 0.25);
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(0, 0, 0, 0.1);
    --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.2);
    --shadow-xl: 0 15px 50px rgba(0, 0, 0, 0.25);
    --shadow-card: 0 8px 25px rgba(0, 0, 0, 0.1);
    --shadow-glow: 0 0 20px rgba(0, 69, 181, 0.2);
}

/* Reset e estilos base */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    scroll-behavior: smooth;
    scroll-padding-top: 80px;
}

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-primary);
    font-weight: 400;
    line-height: 1.6;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-width: 1000px;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(61, 141, 255, 0.05) 0%, transparent 55%),
        radial-gradient(circle at 85% 30%, rgba(157, 78, 221, 0.05) 0%, transparent 55%);
    transition: var(--transition-normal);
}

.light-theme body {
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(0, 69, 181, 0.03) 0%, transparent 55%),
        radial-gradient(circle at 85% 30%, rgba(255, 209, 0, 0.03) 0%, transparent 55%);
}

/* ===== UTILITÁRIOS ===== */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-xs { gap: 8px; }
.gap-sm { gap: 16px; }
.gap-md { gap: 24px; }
.gap-lg { gap: 32px; }
.w-full { width: 100%; }
.h-full { height: 100%; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }
.text-sm { font-size: 13px; }
.text-xs { font-size: 11px; }
.mb-sm { margin-bottom: 16px; }
.mb-md { margin-bottom: 24px; }
.mb-lg { margin-bottom: 32px; }
.p-sm { padding: 16px; }
.p-md { padding: 24px; }
.rounded-sm { border-radius: var(--radius-sm); }
.rounded-md { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.shadow-card { box-shadow: var(--shadow-card); }
.glass {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
}

/* ===== LAYOUT ===== */
.layout {
    display: flex;
    min-height: 100vh;
    position: relative;
    padding-top: var(--header-height);
}

/* ===== HEADER MODERNO 2025 ===== */
.header {
    height: var(--header-height);
    background: var(--bg-header);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-blue), var(--brand-orange), var(--purple));
    background-size: 200% 100%;
    animation: gradientShift 3s ease infinite;
    z-index: 1;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-logo {
    background: var(--gradient-primary);
    color: white;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 20px;
    position: relative;
    overflow: hidden;
    z-index: 2;
    box-shadow: var(--shadow-glow);
    transition: var(--transition-normal);
}

.header-logo:hover {
    transform: rotate(15deg) scale(1.1);
}

.header-logo::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
}

.header-titles {
    display: flex;
    flex-direction: column;
}

.header-title {
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.5px;
    background: linear-gradient(90deg, #fff, var(--brand-blue-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: var(--font-secondary);
}

.header-subtitle {
    font-size: 11px;
    opacity: 0.7;
    font-weight: 500;
    margin-top: 2px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.header-stats {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 255, 255, 0.1);
    min-width: 80px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.stat-value {
    font-weight: 800;
    font-size: 16px;
    line-height: 1;
    font-family: var(--font-secondary);
}

.stat-label {
    font-size: 10px;
    opacity: 0.7;
    font-weight: 500;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.header-actions {
    display: flex;
    gap: 10px;
}
.header-logo-img {
    height: 42px;
    width: auto;
    border-radius: 10px;
    object-fit: contain;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: none;
    background-color: transparent;
    padding: 0;
    transition: var(--transition-normal);
}

.header-logo-img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 69, 181, 0.4);
}

/* ALERTA DE CASOS CRÍTICOS NO HEADER */
.critical-alert {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.9), rgba(255, 122, 69, 0.9));
    border-radius: var(--radius-sm);
    color: white;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-fast);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

.critical-alert:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
}

.critical-alert i {
    font-size: 14px;
}

.critical-alert-count {
    background: white;
    color: var(--error-red);
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 800;
    font-size: 10px;
    min-width: 20px;
    text-align: center;
}

/* ===== SIDEBAR MODERNA ===== */
.sidebar {
    width: var(--sidebar-collapsed);
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-primary);
    position: fixed;
    left: 0;
    top: var(--header-height);
    bottom: 0;
    z-index: 900;
    overflow-y: auto;
    overflow-x: hidden;
    transition: var(--transition-normal);
    padding-top: 25px;
    backdrop-filter: blur(20px);
}

.sidebar:hover {
    width: var(--sidebar-expanded);
    box-shadow: 10px 0 40px rgba(0, 0, 0, 0.3);
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(to bottom, transparent, var(--brand-blue), transparent);
    opacity: 0.3;
}

.sb-icons {
    position: absolute;
    left: 0;
    top: 25px;
    width: var(--sidebar-collapsed);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
    pointer-events: none;
    transition: opacity var(--transition-fast);
}

.sb-icon {
    font-size: 24px;
    color: var(--brand-blue);
    opacity: 0.6;
    transition: var(--transition-fast);
    padding: 12px;
    background: rgba(61, 141, 255, 0.1);
    border-radius: var(--radius-sm);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar:hover .sb-icons {
    opacity: 0;
}

.sb-content {
    width: var(--sidebar-expanded);
    padding: 0 24px;
    opacity: 0;
    transform: translateX(-15px);
    transition: opacity 0.3s 0.1s, transform 0.3s 0.1s;
}

.sidebar:hover .sb-content {
    opacity: 1;
    transform: translateX(0);
}

.section-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--brand-blue);
    font-weight: 700;
    margin-bottom: 18px;
    position: relative;
    padding-bottom: 12px;
    font-family: var(--font-secondary);
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 30px;
    height: 2px;
    background: linear-gradient(90deg, var(--brand-blue), var(--purple));
    border-radius: 2px;
}

/* ===== MAIN CONTENT ===== */
.main {
    flex: 1;
    padding: 35px;
    margin-left: var(--sidebar-collapsed);
    overflow-y: auto;
    position: relative;
    transition: var(--transition-normal);
}

.main::-webkit-scrollbar {
    width: 8px;
}

.main::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.main::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 4px;
}

.main::-webkit-scrollbar-thumb:hover {
    background: var(--brand-blue-light);
}

/* ===== CONTEXT BAR MODERNA ===== */
.context-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 16px 24px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--glass-border);
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.context-text {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
    flex: 1;
    min-width: 200px;
}

.context-text span {
    font-weight: 700;
    color: var(--text-primary);
    background: rgba(61, 141, 255, 0.15);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    margin: 0 4px;
    border: 1px solid rgba(61, 141, 255, 0.3);
}

.context-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.context-hint {
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(61, 141, 255, 0.1);
    border-radius: var(--radius-sm);
    font-weight: 500;
    border: 1px solid rgba(61, 141, 255, 0.2);
}

.context-hint i {
    color: var(--brand-blue);
}

/* ===== KPI GRID STICKY ===== */
.kpi-sticky-container {
    position: sticky;
    top: 20px;
    z-index: 800;
    margin-bottom: 25px;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 16px;
}

.kpi-card {
    border-radius: var(--radius-lg);
    padding: 20px;
    background: var(--bg-card);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    min-height: 120px;
    height: 100%;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light));
    opacity: 0;
    transition: opacity 0.3s;
}

.kpi-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    border-color: var(--brand-blue);
    background: var(--bg-card-hover);
}

.kpi-card:hover::before {
    opacity: 1;
}

.kpi-card.active-filter {
    border: 1px solid var(--brand-orange);
    box-shadow: 0 0 0 3px rgba(255, 122, 69, 0.3), 0 12px 40px rgba(0, 0, 0, 0.4);
}

.kpi-card.active-filter::before {
    background: linear-gradient(90deg, var(--brand-orange), var(--brand-orange-light));
    opacity: 1;
}

.kpi-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    z-index: 1;
    min-width: 0;
}

.kpi-val {
    font-size: clamp(20px, 3.5vw, 28px);
    font-weight: 900;
    color: var(--text-primary);
    line-height: 1.2;
    margin-bottom: 8px;
    font-family: var(--font-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 2.4em;
    word-break: break-word;
    hyphens: auto;
}

.kpi-val .unit {
    font-size: 16px;
    font-weight: 600;
    margin-left: 4px;
    color: var(--text-secondary);
}

.kpi-lbl {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.kpi-helper {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 400;
    line-height: 1.3;
}

/* === KPI TRENDS === */
.kpi-trend {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
    width: fit-content;
}

.kpi-trend.up {
    background: rgba(0, 201, 167, 0.15);
    color: var(--success-green);
}

.kpi-trend.down {
    background: rgba(255, 71, 87, 0.15);
    color: var(--error-red);
}

.kpi-trend.neutral {
    background: rgba(139, 141, 158, 0.15);
    color: var(--text-muted);
}

/* === SEPARADOR TRANSPARENTE NO CARD TOTAL === */
.total-card-separator {
    width: 100%;
    height: 1px;
    background: rgba(255, 255, 255, 0.08);
    margin: 8px 0;
}

.demanda-interna-indicator {
    font-size: 0.75em;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
}

.kpi-icon {
    font-size: 36px;
    opacity: 0.2;
    color: var(--brand-blue);
    margin-left: 15px;
    transition: var(--transition-normal);
    z-index: 0;
}

.kpi-card:hover .kpi-icon {
    opacity: 0.3;
    transform: scale(1.1);
}

/* ===== FILTER TAGS MODERNAS ===== */
#activeFilters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    min-height: 0;
    padding: 5px 0;
}

.filter-tag {
    background: var(--gradient-primary);
    color: #fff;
    padding: 8px 16px;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: var(--transition-fast);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideUp 0.3s ease-out forwards;
    transform: translateY(10px);
    opacity: 0;
}

@keyframes slideUp {
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.filter-tag:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-glow);
    border-color: rgba(255, 255, 255, 0.3);
}

.filter-tag i {
    font-size: 13px;
}

.filter-tag .fa-xmark {
    margin-left: 4px;
    color: rgba(255, 255, 255, 0.9);
    opacity: 0.8;
    transition: var(--transition-fast);
}

.filter-tag .fa-xmark:hover {
    opacity: 1;
    transform: rotate(90deg);
}

/* ===== CARDS E GRÁFICOS PREMIUM ===== */
.card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-primary);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.card:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--border-light);
    transform: translateY(-2px);
}

.card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.05) 0%, transparent 100%);
    opacity: 0;
    transition: var(--transition-normal);
}

.card:hover::before {
    opacity: 1;
}

.card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
}

.card-title {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--font-secondary);
}

.card-title i {
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.card-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 5px;
    font-weight: 500;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.wide-chart {
    grid-column: span 2;
}

@media (max-width: 1200px) {
    .wide-chart {
        grid-column: span 1;
    }
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    padding: 15px;
    flex: 1;
}

.chart-scroll-container {
    overflow-y: auto;
    max-height: 500px;
    height: auto;
    min-height: 300px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    flex: 1;
}

.chart-scroll-container::-webkit-scrollbar {
    width: 6px;
}

.chart-scroll-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.chart-scroll-container::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 3px;
}

/* Doughnut center info */
.doughnut-center-info {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none;
    width: 100%;
}

.doughnut-center-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 80%;
    margin: 0 auto;
}

.doughnut-center-value {
    font-size: 24px;
    font-weight: 900;
    color: var(--brand-blue);
    font-family: var(--font-secondary);
}

.bar-chart-mini-container {
    height: 200px;
    width: 100%;
    position: relative;
    margin-top: 10px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    padding: 15px;
}

/* ===== FORM CONTROLS COM GLASSMORPHISM ===== */
.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 13px;
    margin-bottom: 12px;
    outline: none;
    background: rgba(255, 255, 255, 0.05);
    transition: var(--transition-fast);
    color: var(--text-primary);
    backdrop-filter: blur(10px);
}

.form-control:focus {
    border-color: var(--brand-blue);
    box-shadow: 0 0 0 3px rgba(61, 141, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
}

.form-control::placeholder {
    color: var(--text-muted);
}

.select-wrapper {
    position: relative;
    margin-bottom: 12px;
}

.select-wrapper::after {
    content: '\f078';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    pointer-events: none;
    font-size: 12px;
}

.select-wrapper select {
    appearance: none;
    cursor: pointer;
    padding-right: 40px;
    background: rgba(255, 255, 255, 0.05);
}

/* ===== BOTÕES PREMIUM ===== */
.btn {
    border: none;
    border-radius: var(--radius-sm);
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition-normal);
    font-family: var(--font-primary);
    position: relative;
    overflow: hidden;
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.btn:hover::after {
    opacity: 1;
}

.btn-primary {
    background: var(--gradient-secondary);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(255, 122, 69, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 122, 69, 0.4);
}

.btn-secondary {
    background: var(--gradient-primary);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(61, 141, 255, 0.3);
}

.btn-secondary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(61, 141, 255, 0.4);
}

.btn-ghost {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    backdrop-filter: none;
}

.btn-ghost:hover {
    background: rgba(61, 141, 255, 0.1);
    color: var(--brand-blue);
    border-color: var(--brand-blue);
    transform: translateY(-2px);
}

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    justify-content: center;
    border-radius: var(--radius-sm);
}

.btn-purple {
    background: var(--gradient-purple);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(157, 78, 221, 0.3);
}

.btn-purple:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
}

/* Botão de automação */
.btn-automation {
    background: var(--gradient-purple);
    color: #fff;
    box-shadow: 0 5px 15px rgba(157, 78, 221, 0.3);
    border: none;
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition-normal);
    font-family: var(--font-primary);
    position: relative;
    overflow: hidden;
    outline: none;
    backdrop-filter: blur(10px);
}

.btn-automation:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
}

/* ===== POPUPS MODERNOS - CORRIGIDOS ===== */
.notification-popup,
.development-popup,
.automation-popup {
    position: fixed;
    z-index: 2000;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border-primary);
    backdrop-filter: blur(30px);
    overflow: hidden;
    display: none;
    max-width: 90vw;
}

.notification-popup.show,
.development-popup.show,
.automation-popup.show {
    display: block;
}

/* Notificações */
.notification-popup {
    top: calc(var(--header-height) + 20px);
    right: 30px;
    width: 380px;
    max-height: 80vh;
    overflow-y: auto;
}

.notification-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
}

.notification-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--font-secondary);
}

.notification-title i {
    color: var(--purple);
}

.notification-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 5px;
}

.notification-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.notification-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.notification-content {
    padding: 20px;
}

.notification-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid var(--border-primary);
    transition: var(--transition-fast);
}

.notification-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--border-light);
}

.notification-item-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-weight: 600;
    color: var(--text-primary);
}

.notification-item-date {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
}

.notification-item-content {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 15px;
}

.notification-item-stats {
    display: flex;
    gap: 15px;
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: var(--radius-sm);
}

.notification-item-stats > div {
    flex: 1;
    text-align: center;
}

.notification-item-stats .stat-number {
    font-size: 24px;
    font-weight: 800;
    font-family: var(--font-secondary);
    color: var(--text-primary);
}

.notification-item-stats .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.notification-empty i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.notification-empty h3 {
    font-size: 16px;
    margin-bottom: 10px;
    color: var(--text-secondary);
}

.notification-empty p {
    font-size: 13px;
}

.notification-footer {
    display: flex;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid var(--border-primary);
}

/* Desenvolvimento e Automação */
.development-popup,
.automation-popup {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
}

.development-header,
.automation-header {
    padding: 30px;
    text-align: center;
    border-bottom: 1px solid var(--border-primary);
}

.development-icon,
.automation-icon {
    font-size: 48px;
    margin-bottom: 20px;
    color: var(--brand-blue);
}

.development-title,
.automation-title {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 10px;
    font-family: var(--font-secondary);
}

.development-subtitle,
.automation-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
}

.development-content,
.automation-content {
    padding: 30px;
    text-align: center;
}

.development-text,
.automation-text {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 25px;
}

.development-close,
.automation-close-btn {
    min-width: 150px;
    justify-content: center;
}

.automation-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.automation-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

/* ===== TOAST MODERNO ===== */
.toast {
    position: fixed;
    top: 100px;
    right: 30px;
    background: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
    color: white;
    padding: 16px 20px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-xl);
    z-index: 3000;
    display: flex;
    align-items: center;
    gap: 12px;
    border-left: 4px solid var(--brand-blue);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    max-width: 350px;
    animation: slideInRight 0.3s ease-out forwards;
    transform: translateX(400px);
}

@keyframes slideInRight {
    to {
        transform: translateX(0);
    }
}

.toast.success { border-left-color: var(--success-green); }
.toast.error { border-left-color: var(--error-red); }
.toast.info { border-left-color: var(--brand-blue); }
.toast.warning { border-left-color: var(--warning); }
.toast.purple { border-left-color: var(--purple); }

/* ===== GRÁFICO COM EFEITOS PREMIUM ===== */
.chart-container canvas,
.bar-chart-mini-container canvas,
.chart-scroll-container canvas {
    filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
}

/* Estilização dos pontos do gráfico */
.chartjs-render-monitor .chartjs-tooltip {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-primary) !important;
    border-radius: var(--radius-sm) !important;
    box-shadow: var(--shadow-lg) !important;
    backdrop-filter: blur(20px);
}

.chartjs-render-monitor .chartjs-tooltip-key {
    background: var(--brand-blue) !important;
}

/* Pontos com glow no hover */
.chartjs-render-monitor .point {
    transition: all 0.3s ease;
}

.chartjs-render-monitor .point:hover {
    box-shadow: 0 0 15px var(--brand-blue);
    border: 2px solid white !important;
}

/* ===== TABELA MODERNA ===== */
.table-container {
    max-height: 400px;
    overflow: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: var(--brand-blue-light);
}

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px;
    min-width: 1200px;
}

.table thead {
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.1) 0%, rgba(157, 78, 221, 0.1) 100%);
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(20px);
}

.table th {
    color: var(--brand-blue);
    font-weight: 700;
    padding: 16px 14px;
    text-align: left;
    cursor: pointer;
    user-select: none;
    border-bottom: 2px solid var(--brand-blue);
    font-family: var(--font-secondary);
    font-size: 13px;
    white-space: nowrap;
    transition: var(--transition-fast);
}

.table th:hover {
    background: rgba(61, 141, 255, 0.15);
}

.table th span.sort-indicator {
    margin-left: 8px;
    font-size: 10px;
    opacity: 0.8;
}

.table td {
    padding: 14px;
    border-bottom: 1px solid var(--border-primary);
    transition: var(--transition-fast);
}

.table tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.02);
}

.table tr:hover {
    background-color: rgba(61, 141, 255, 0.1);
    cursor: pointer;
}

.table tr.active-filter {
    background-color: rgba(255, 122, 69, 0.1);
    box-shadow: inset 0 0 0 1px var(--brand-orange);
}

.table td.filterable {
    cursor: pointer;
}

/* Status pills */
.status-pill {
    padding: 6px 14px;
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.st-fechado {
    background: var(--gradient-success);
    color: #fff;
}

.st-aberto {
    background: var(--gradient-warning);
    color: #fff;
}

.truncated {
    max-width: 220px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: help;
}

.table td.icon-cell {
    font-weight: 600;
}

.table td.icon-cell i {
    font-size: 16px;
    margin-right: 8px;
    vertical-align: middle;
}

/* ===== PAGINAÇÃO ===== */
.pagination {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pagination-info {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.pagination-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-primary);
    background: rgba(255, 255, 255, 0.05);
    color: var(--brand-blue);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-fast);
    backdrop-filter: blur(10px);
}

.pagination-btn:hover {
    background: var(--brand-blue);
    color: white;
    border-color: var(--brand-blue);
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgba(255, 255, 255, 0.05);
    transform: none;
}

/* ===== LOADING ===== */
#loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 4000;
    display: flex;
    align-items: center;
    justify-content: center;
    display: none;
}

.loading-content {
    background: #1a1a2e;
    border-radius: 12px;
    padding: 30px 50px;
    text-align: center;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: #0045B5;
    border-radius: 50%;
    margin: 0 auto 15px;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 14px;
    font-weight: 500;
    color: #fff;
}

/* ===== ANIMAÇÕES ===== */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.fade-in { animation: fadeIn 0.5s ease-out forwards; }
.slide-in-left { animation: slideInLeft 0.4s ease-out forwards; }

/* ===== ESTILOS PARA O NOVO MODAL DE AUTOMAÇÃO ===== */
.automation-popup {
    width: 95% !important;
    max-width: 1400px !important;
    height: 90vh !important;
}

.automation-content {
    padding: 0 !important;
    overflow: hidden !important;
    height: calc(100% - 140px) !important;
}

/* Tabs de Navegação */
.tabs-container {
    padding: 0 20px;
    display: flex;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-card);
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    color: var(--brand-blue);
    background: rgba(61, 141, 255, 0.05);
}

.tab-btn.active {
    color: var(--brand-blue);
    border-bottom-color: var(--brand-blue);
    background: rgba(61, 141, 255, 0.1);
}

.tabs-content {
    height: calc(100% - 50px);
    overflow-y: auto;
    padding: 20px;
}

.tab-pane {
    display: none;
    height: 100%;
}

.tab-pane.active {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

/* Estilos específicos para o conteúdo das tabs */
.tab-pane h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
}

.tab-pane h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
}

.motivo-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: 15px;
    border: 1px solid var(--border-primary);
}

.stat-card h4 {
    color: var(--brand-blue);
    border-bottom: 2px solid var(--brand-blue);
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.btn-sm {
    padding: 6px 12px !important;
    font-size: 12px !important;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 1800px) {
    .kpi-grid { grid-template-columns: repeat(6, 1fr); }
}

@media (max-width: 1500px) {
    .kpi-grid { grid-template-columns: repeat(5, 1fr); }
}

@media (max-width: 1300px) {
    .kpi-grid { grid-template-columns: repeat(4, 1fr); }
}

@media (max-width: 1200px) {
    .charts-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    .wide-chart { grid-column: span 1; }
}

@media (max-width: 900px) {
    body { overflow: auto; min-width: auto; }
    .layout { flex-direction: column; height: auto; }
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        margin-top: 0;
        order: 2;
        box-shadow: none;
        border-right: none;
        border-top: 1px solid var(--border-primary);
        padding: 20px;
    }
    .sidebar:hover { width: 100%; }
    .sb-icons { display: none; }
    .sb-content {
        opacity: 1;
        transform: none;
        width: 100%;
        padding: 0;
    }
    .main {
        order: 1;
        padding: 20px;
        margin-left: 0;
    }
    .header { padding: 0 20px; height: 70px; }
    .header-stats { display: none; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .card { padding: 20px; }
    .notification-popup {
        top: 20px;
        right: 20px;
        left: 20px;
        width: auto;
    }
    .automation-popup {
        width: 95vw !important;
        height: 95vh !important;
    }
}

@media (max-width: 600px) {
    .header {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 15px;
        position: relative;
    }
    .header-left, .header-right { width: 100%; justify-content: center; }
    .header-actions { justify-content: center; flex-wrap: wrap; }
    .context-bar { flex-direction: column; align-items: stretch; gap: 15px; }
    .context-actions { width: 100%; flex-direction: column; }
    .context-hint { width: 100%; justify-content: center; text-align: center; }
    .btn-automation, .btn-ghost { width: 100%; justify-content: center; }
    .btn { padding: 10px 16px; font-size: 13px; }
    .kpi-grid { grid-template-columns: 1fr; gap: 12px; }
    .kpi-card { padding: 16px; min-height: 100px; }
    .kpi-val { font-size: 24px; }
    .kpi-sticky-container { position: relative; top: 0; }
    .development-popup,
    .automation-popup {
        width: 90vw;
        padding: 0;
    }
    .tabs-container {
        flex-wrap: wrap;
    }
    .tab-btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
        padding: 10px 12px;
    }
}

/* Adicionar efeito de ripple aos botões */
@keyframes ripple {
    to { transform: scale(4); opacity: 0; }
}

/* AJUSTES PARA LAYOUT DOS GRÁFICOS */
@media (min-width: 1400px) {
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .card:nth-child(5) {
        grid-column: 1;
    }
    .card:nth-child(6) {
        grid-column: 2;
    }
}

/* ===== NOVOS ESTILOS PARA MELHORIAS VISUAIS ===== */

/* Tooltip para Motivo Mais Tratado */
.motivo-tooltip {
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: 16px;
    box-shadow: var(--shadow-xl);
    z-index: 1000;
    display: none;
    width: 280px;
    font-size: 13px;
    backdrop-filter: blur(20px);
    animation: fadeIn 0.2s ease-out;
}

.motivo-tooltip.show {
    display: block;
}

.motivo-tooltip h4 {
    margin-top: 0;
    margin-bottom: 12px;
    color: var(--brand-blue);
    font-size: 14px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

.motivo-tooltip p {
    margin: 8px 0;
    color: var(--text-secondary);
    line-height: 1.4;
    display: flex;
    justify-content: space-between;
}

.motivo-tooltip p strong {
    color: var(--text-primary);
    font-weight: 600;
    min-width: 100px;
}

.motivo-tooltip p span {
    text-align: right;
    font-weight: 500;
}

/* Paleta de cores para gráficos de motivo */
.motivo-palette {
    --color-motivo-1: #0045B5;
    --color-motivo-2: #FFD100;
    --color-motivo-3: #0068FF;
    --color-motivo-4: #00ADFF;
    --color-motivo-5: #00266E;
    --color-motivo-6: #FFB206;
    --color-motivo-7: #00D9B8;
    --color-motivo-8: #939598;
    --color-motivo-9: #00C9A7;
    --color-motivo-10: #FFA93D;
    --color-motivo-11: #4CE4C9;
    --color-motivo-12: #3D8DFF;
    --color-motivo-13: #6CABFF;
    --color-motivo-14: #FFE4A1;
    --color-motivo-15: #FF9E76;
}

/* Legenda responsiva sem scroll */
.legend-container {
    width: 100%;
    max-height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 0;
    position: relative;
    z-index: 100;
    pointer-events: auto;
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
    font-size: 0.85em;
    min-height: 32px;

    position: relative;
    z-index: 101;
    pointer-events: auto !important;
}

.legend-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.legend-color {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
}

.legend-label {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
    color: var(--text-primary);
}

.legend-value {
    margin-left: 8px;
    font-weight: 600;
    color: var(--brand-blue);
    white-space: nowrap;
}

/* Ajustes de estabilidade para zoom */
.chart-container,
.bar-chart-mini-container,
.chart-scroll-container {
    transform-origin: 0 0;
    transform: scale(1);
    transition: transform 0.1s ease;
}

/* Ajustes responsivos para gráficos */
@media (min-width: 768px) {
    .chart-container {
        height: 320px;
    }
    
    .bar-chart-mini-container {
        height: 220px;
    }
}

/* Ajustes de texto responsivo */
@media (max-width: 1400px) {
    .kpi-val {
        font-size: clamp(18px, 2.5vw, 24px);
    }
    
    .legend-item {
        font-size: 0.8em;
    }
}

/* Prevenir quebra de layout em zoom */
@media (max-resolution: 192dpi) {
    .charts-grid {
        gap: 20px;
    }
    
    .kpi-grid {
        gap: 12px;
    }
}

/* Melhorias de acessibilidade em foco */
:focus-visible {
    outline: 2px solid var(--brand-blue);
    outline-offset: 2px;
}

/* Suporte a alto contraste */
@media (prefers-contrast: high) {
    .kpi-card {
        border: 2px solid var(--border-primary);
    }
    
    .legend-item {
        border: 1px solid var(--border-light);
    }
}

/* Styles for the Motivo Details Popup */
.motivo-info-icon {
    font-size: 14px;
    color: var(--brand-blue);
    cursor: pointer;
    margin-left: 6px;
    opacity: 0.7;
    transition: var(--transition-fast);
    vertical-align: middle;
}

.motivo-info-icon:hover {
    opacity: 1;
    transform: scale(1.2);
}

.motivo-details-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border-primary);
    width: 500px;
    max-width: 90vw;
    z-index: 3000;
    display: none;
    overflow: hidden;
}

.motivo-details-popup.show {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

.motivo-details-header {
    background: #00266E; /* Azul escuro do Ipiranga */
    color: white;
    padding: 24px;
    text-align: center;
    border-bottom: 1px solid var(--border-primary);
}

.motivo-details-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    font-family: var(--font-secondary);
}

.motivo-details-subtitle {
    font-size: 13px;
    opacity: 0.9;
}

.motivo-details-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.motivo-details-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.motivo-details-content {
    padding: 24px;
    color: var(--text-primary);
}

.motivo-details-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-light);
}

.motivo-details-row:last-child {
    border-bottom: none;
}

.motivo-details-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
}

.motivo-details-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    text-align: right;
    max-width: 60%;
}

.motivo-details-note {
    margin-top: 20px;
    padding: 12px;
    background: rgba(61, 141, 255, 0.05);
    border-radius: var(--radius-sm);
    font-size: 12px;
    color: var(--text-secondary);
    border: 1px solid rgba(61, 141, 255, 0.1);
}

.motivo-details-note i {
    color: var(--brand-blue);
    margin-right: 6px;
}

/* === HOVER EFFECT PARA LEGENDAS DAS ROSCAS === */
.legend-item-highlight {
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.35) 0%, rgba(61, 141, 255, 0.2) 100%) !important;
    transform: translateX(5px) scale(1.03);
    box-shadow: 0 0 15px rgba(61, 141, 255, 0.5), inset 0 0 10px rgba(61, 141, 255, 0.1);
    border-left: 3px solid var(--brand-blue) !important;
    border-radius: 8px !important;
}

.legend-item {
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border-left: 3px solid transparent;
}

/* Estilo para filtro de analistas com checkbox Todos */
.analista-filter-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.analista-todos-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-primary);
    transition: var(--transition-fast);
}
.analista-todos-label:hover {
    background: rgba(61, 141, 255, 0.1);
    border-color: var(--brand-blue);
}
.analista-todos-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--brand-blue);
    cursor: pointer;
}
.analista-todos-label span {
    font-weight: 500;
}
#analistaSelect {
    scrollbar-width: thin;
}
#analistaSelect option {
    padding: 6px 10px;
}
#analistaSelect option:checked {
    background: linear-gradient(0deg, var(--brand-blue) 0%, var(--brand-blue) 100%);
    color: white;
}

/* EFEITOS ESPECIAIS NOS CARDS DO GRID AO PASSAR O MOUSE */
.kpi-card {
    position: relative;
    isolation: isolate;
}

.kpi-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(61, 141, 255, 0.15) 0%, 
                transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: -1;
    border-radius: var(--radius-lg);
}

.kpi-card:hover::after {
    opacity: 1;
}

/* ===== RODAPÉ COM INFORMAÇÕES DE ATUALIZAÇÃO ===== */
.footer-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.02);
    border-top: 1px solid var(--border-primary);
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 30px;
    border-radius: var(--radius-md);
    flex-wrap: wrap;
    gap: 15px;
}

.update-timestamp {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.update-timestamp i {
    color: var(--brand-blue);
}

.update-timestamp span {
    color: var(--brand-blue);
    font-weight: 700;
}

.critical-cases-alert {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 122, 69, 0.1));
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 71, 87, 0.2);
    cursor: pointer;
    transition: var(--transition-fast);
}

.critical-cases-alert:hover {
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.15), rgba(255, 122, 69, 0.15));
    border-color: rgba(255, 71, 87, 0.3);
    transform: translateY(-2px);
}

.critical-cases-alert i {
    color: var(--error-red);
    font-size: 14px;
}

.critical-cases-alert span {
    font-weight: 600;
    color: var(--text-primary);
}

.critical-count {
    background: var(--error-red);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 800;
    min-width: 20px;
    text-align: center;
}

/* WORD CLOUD */
.word-cloud-card { min-height: 500px; }
.word-cloud-container { position: relative; height: 400px; width: 100%; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); overflow: hidden; display: flex; align-items: center; justify-content: center; }
.word-cloud-container canvas { max-width: 100%; max-height: 100%; }
.word-cloud-empty { text-align: center; color: var(--text-muted); padding: 40px; flex-direction: column; }
.word-cloud-empty i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; display: block; }
.word-cloud-empty p { font-size: 14px; max-width: 400px; margin: 0 auto; }
.word-cloud-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); }
.word-stat { text-align: center; padding: 12px; }
.word-stat-value { display: block; font-size: 24px; font-weight: 800; color: var(--brand-blue); font-family: var(--font-secondary); margin-bottom: 4px; }
.word-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
@media (max-width: 900px) { .word-cloud-stats { grid-template-columns: repeat(2,1fr); } .word-cloud-container { height: 300px; } }

/* ========================================
   CONSOLIDA ULTIMATE v8.0.0
   Build: 5C2F86E7 | 2025-12-26
   ======================================== */

/* ===== TIMECOMPARE ENGINE ===== */
.compare-toggle {
    display: none;
    align-items: center;
    gap: 12px;
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 10px 16px;
    margin-bottom: 16px;
}
.compare-toggle.show { display: flex; }
.compare-toggle-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
}
.compare-toggle-label i { color: var(--purple); }
.compare-presets { display: flex; gap: 6px; flex: 1; flex-wrap: wrap; }
.compare-preset {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
}
.compare-preset:hover { background: rgba(157, 78, 221, 0.15); border-color: var(--purple); }
.compare-preset.active { background: var(--purple); border-color: var(--purple); color: white; font-weight: 600; }
.compare-summary {
    background: linear-gradient(135deg, rgba(157, 78, 221, 0.12) 0%, rgba(123, 44, 191, 0.05) 100%);
    border: 1px solid rgba(157, 78, 221, 0.3);
    border-radius: var(--radius-lg);
    padding: 20px 24px;
    margin-bottom: 20px;
    display: none;
}
.compare-summary.show { display: block; }
.compare-summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.compare-summary-title { font-size: 14px; font-weight: 700; color: var(--purple-light); display: flex; align-items: center; gap: 10px; }
.compare-period-badge { background: rgba(157, 78, 221, 0.2); color: var(--purple-light); font-size: 11px; padding: 4px 12px; border-radius: 12px; }
.compare-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px; }
.compare-card { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.06); }
.compare-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.compare-card-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
.compare-card-delta { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
.compare-card-delta.positive { background: rgba(0, 201, 167, 0.2); color: var(--success-green); }
.compare-card-delta.negative { background: rgba(255, 71, 87, 0.2); color: var(--error-red); }
.compare-card-delta.neutral { background: rgba(255,255,255,0.1); color: var(--text-muted); }
.compare-card-values { display: flex; align-items: baseline; gap: 8px; }
.compare-card-current { font-size: 26px; font-weight: 800; color: var(--text-primary); }
.compare-card-previous { font-size: 13px; color: var(--text-muted); }
.sparkline-container { height: 24px; margin-top: 10px; display: flex; align-items: flex-end; gap: 2px; }
.sparkline-bar { flex: 1; background: rgba(157, 78, 221, 0.3); border-radius: 2px 2px 0 0; min-height: 3px; }
.sparkline-bar:last-child { background: var(--purple); }
.evolution-score { display: flex; gap: 16px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
.evolution-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
.evolution-icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
.evolution-icon.improving { background: rgba(0, 201, 167, 0.2); color: var(--success-green); }
.evolution-icon.worsening { background: rgba(255, 71, 87, 0.2); color: var(--error-red); }
.evolution-count { font-weight: 700; color: var(--text-primary); }
.evolution-label { color: var(--text-secondary); }
.kpi-delta { display: none; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 10px; margin-top: 8px; }
.kpi-delta.show { display: inline-flex; }
.kpi-delta.positive { background: rgba(0, 201, 167, 0.15); color: var(--success-green); }
.kpi-delta.negative { background: rgba(255, 71, 87, 0.15); color: var(--error-red); }

/* ===== ENTERPRISE FEATURES ===== */
.btn-novo-registro { background: linear-gradient(135deg, #00C9A7 0%, #00A884 100%) !important; color: white !important; padding: 10px 20px !important; font-weight: 700 !important; border-radius: 25px !important; box-shadow: 0 4px 15px rgba(0, 201, 167, 0.4); }
.cnpj-input-wrapper { display: flex; gap: 8px; }
.btn-buscar-cnpj { background: var(--color-azul); color: white; border: none; padding: 12px 16px; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600; }
.btn-buscar-cnpj .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.cnpj-result { margin-top: 8px; padding: 10px 12px; background: rgba(0, 201, 167, 0.1); border: 1px solid rgba(0, 201, 167, 0.3); border-radius: var(--radius-sm); font-size: 12px; color: var(--success-green); display: none; }
.cnpj-result.show { display: block; }
.cnpj-result.error { background: rgba(255, 71, 87, 0.1); border-color: rgba(255, 71, 87, 0.3); color: var(--error-red); }
.smart-bar { background: linear-gradient(90deg, var(--bg-card) 0%, rgba(61, 141, 255, 0.1) 100%); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); padding: 14px 20px; display: none; align-items: center; gap: 16px; margin-bottom: 16px; }
.smart-bar.show { display: flex; }
.smart-bar-icon { width: 36px; height: 36px; background: var(--gradient-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }
.smart-bar-content { flex: 1; }
.smart-bar-title { font-weight: 600; font-size: 13px; color: var(--text-primary); }
.smart-bar-desc { font-size: 12px; color: var(--text-secondary); }
.efficiency-panel { background: linear-gradient(135deg, rgba(0, 201, 167, 0.08) 0%, rgba(0, 136, 116, 0.03) 100%); border: 1px solid rgba(0, 201, 167, 0.2); border-radius: var(--radius-lg); padding: 20px 24px; margin-bottom: 20px; display: none; }
.efficiency-panel.show { display: block; }
.efficiency-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.efficiency-title { font-weight: 700; font-size: 14px; color: var(--success-green); display: flex; align-items: center; gap: 10px; }
.efficiency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; }
.efficiency-card { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 14px; border: 1px solid var(--border-primary); }
.efficiency-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.efficiency-card-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
.efficiency-card-icon.speed { background: rgba(61, 141, 255, 0.15); color: var(--brand-blue); }
.efficiency-card-icon.sameday { background: rgba(0, 201, 167, 0.15); color: var(--success-green); }
.efficiency-card-icon.backlog { background: rgba(255, 71, 87, 0.15); color: var(--error-red); }
.efficiency-card-icon.capacity { background: rgba(255, 169, 61, 0.15); color: var(--warning); }
.efficiency-card-icon.trend { background: rgba(157, 78, 221, 0.15); color: var(--purple); }
.efficiency-card-badge { font-size: 9px; padding: 2px 6px; border-radius: 8px; font-weight: 600; }
.efficiency-card-badge.good { background: rgba(0, 201, 167, 0.2); color: var(--success-green); }
.efficiency-card-badge.warning { background: rgba(255, 169, 61, 0.2); color: var(--warning); }
.efficiency-card-badge.bad { background: rgba(255, 71, 87, 0.2); color: var(--error-red); }
.efficiency-card-value { font-size: 24px; font-weight: 800; color: var(--text-primary); }
.efficiency-card-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.simulation-panel { background: linear-gradient(135deg, rgba(157, 78, 221, 0.1) 0%, rgba(123, 44, 191, 0.03) 100%); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: var(--radius-lg); margin-bottom: 20px; overflow: hidden; display: none; }
.simulation-panel.show { display: block; }
.simulation-header { padding: 14px 20px; background: rgba(157, 78, 221, 0.1); display: flex; justify-content: space-between; align-items: center; }
.simulation-title { font-weight: 700; font-size: 13px; color: var(--purple-light); display: flex; align-items: center; gap: 8px; }
.simulation-badge { background: var(--purple); color: white; font-size: 9px; padding: 3px 8px; border-radius: 10px; }
.simulation-body { padding: 20px; }
.simulation-sliders { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
.simulation-slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.simulation-slider-label { font-size: 12px; color: var(--text-secondary); }
.simulation-slider-value { font-size: 14px; font-weight: 700; color: var(--purple-light); }
.simulation-slider { width: 100%; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.1); -webkit-appearance: none; cursor: pointer; }
.simulation-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--purple); cursor: pointer; }
.simulation-results { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; }
.simulation-results-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
.simulation-results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
.simulation-result-card { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; text-align: center; }
.simulation-result-value { font-size: 20px; font-weight: 800; color: var(--text-primary); }
.simulation-result-value.improved { color: var(--success-green); }
.simulation-result-value.worsened { color: var(--error-red); }
.simulation-result-label { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
.annotations-panel { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); margin-bottom: 20px; overflow: hidden; display: none; }
.annotations-panel.show { display: block; }
.annotations-header { padding: 14px 20px; background: linear-gradient(90deg, rgba(255, 169, 61, 0.1) 0%, transparent 100%); border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; }
.annotations-title { font-weight: 700; font-size: 13px; color: var(--warning); display: flex; align-items: center; gap: 8px; }
.annotations-body { padding: 16px 20px; }
.annotation-input-group { display: flex; gap: 10px; margin-bottom: 12px; }
.annotation-input { flex: 1; background: var(--bg-card-hover); border: 1px solid var(--border-primary); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 13px; }
.annotation-type-select { background: var(--bg-card-hover); border: 1px solid var(--border-primary); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 12px; }
.btn-add-annotation { background: var(--warning); color: #000; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
.annotations-list { max-height: 120px; overflow-y: auto; }
.annotation-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px; font-size: 12px; }
.annotation-marker { width: 8px; height: 8px; border-radius: 50%; margin-top: 4px; }
.annotation-marker.event { background: var(--error-red); }
.annotation-marker.note { background: var(--brand-blue); }
.annotation-marker.milestone { background: var(--success-green); }
.alert-center { position: fixed; top: 80px; right: 20px; width: 340px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.alert-item { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-primary); box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden; pointer-events: auto; animation: slideInRight 0.3s ease; }
@keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
.alert-item.dismissing { animation: slideOutRight 0.3s ease forwards; }
@keyframes slideOutRight { to { opacity: 0; transform: translateX(100%); } }
.alert-item-header { padding: 12px 14px; display: flex; align-items: center; gap: 10px; }
.alert-item.severity-critical .alert-item-header { background: rgba(255, 71, 87, 0.15); }
.alert-item.severity-warning .alert-item-header { background: rgba(255, 169, 61, 0.15); }
.alert-icon { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.severity-critical .alert-icon { background: var(--error-red); color: white; }
.severity-warning .alert-icon { background: var(--warning); color: #000; }
.alert-title { font-size: 12px; font-weight: 700; color: var(--text-primary); flex: 1; }
.alert-close { background: none; border: none; color: var(--text-muted); cursor: pointer; }
.alert-body { padding: 0 14px 12px 52px; font-size: 12px; color: var(--text-secondary); }
.export-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 7000; display: none; align-items: center; justify-content: center; }
.export-modal-overlay.show { display: flex; }
.export-modal { background: var(--bg-card); border-radius: var(--radius-xl); width: 100%; max-width: 480px; border: 1px solid var(--border-primary); }
.export-modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; }
.export-modal-title { font-size: 16px; font-weight: 700; color: var(--text-primary); }
.export-modal-body { padding: 24px; }
.export-options { display: grid; gap: 12px; }
.export-option { background: var(--bg-card-hover); border: 2px solid var(--border-primary); border-radius: 12px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 14px; transition: all 0.2s; }
.export-option:hover { border-color: var(--brand-blue); }
.export-option.selected { border-color: var(--brand-blue); background: rgba(61, 141, 255, 0.1); }
.export-option-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.export-option-icon.excel { background: rgba(0, 168, 84, 0.15); color: #00A854; }
.export-option-icon.pdf { background: rgba(255, 71, 87, 0.15); color: var(--error-red); }
.export-option-text h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
.export-option-text p { font-size: 12px; color: var(--text-muted); margin: 0; }
.export-modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-primary); display: flex; justify-content: flex-end; gap: 10px; }



.audit-btn:hover { background: rgba(255,255,255,0.2); }
.audit-btn.active { background: var(--purple); color: white; }
body { padding-bottom: 40px; }

/* ===== CSS DO MODAL DE INSERÇÃO ===== */
.modal-inserir-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: fadeInOverlay 0.3s ease-out;
}

.modal-inserir-overlay.show {
    display: flex;
}

@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-inserir {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    width: 95%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-primary);
    animation: slideUpModal 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

@keyframes slideUpModal {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-inserir-header {
    background: var(--color-azul);
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid var(--color-amarelo);
}

.modal-inserir-title {
    color: white;
    font-size: 20px;
    font-weight: 800;
    font-family: var(--font-secondary);
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-inserir-title i {
    color: var(--color-amarelo);
}

.modal-inserir-close {
    background: rgba(255,255,255,0.15);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-inserir-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

.modal-inserir-body {
    padding: 30px;
    overflow-y: auto;
    flex: 1;
}

.form-inserir-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-inserir-grid .form-group.full-width {
    grid-column: span 2;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group label {
    font-size: 12px;
    font-weight: 700;
    color: var(--color-azul);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group label .required {
    color: var(--error-red);
    margin-left: 2px;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 16px;
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
    background: var(--bg-card);
    color: var(--text-primary);
    transition: var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-azul);
    box-shadow: 0 0 0 4px rgba(0, 69, 181, 0.15);
}

.form-group input.invalid,
.form-group select.invalid,
.form-group textarea.invalid {
    border-color: var(--error-red);
    box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.15);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-group .error-message {
    font-size: 11px;
    color: var(--error-red);
    display: none;
}

.form-group .error-message.show {
    display: block;
}

.modal-inserir-footer {
    padding: 20px 30px;
    background: rgba(0, 69, 181, 0.05);
    border-top: 1px solid var(--border-primary);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.btn-inserir-submit {
    background: var(--color-azul) !important;
    color: white !important;
    padding: 14px 28px !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    border: none !important;
    border-radius: var(--radius-sm) !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition-fast);
    box-shadow: 0 4px 15px rgba(0, 69, 181, 0.3);
}

.btn-inserir-submit:hover:not(:disabled) {
    background: var(--color-indigo) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 69, 181, 0.4);
}

.btn-inserir-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-inserir-submit .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
}

.btn-inserir-submit.loading .spinner {
    display: block;
}

.btn-inserir-submit.loading .btn-text {
    display: none;
}

.btn-inserir-cancel {
    background: transparent !important;
    color: var(--text-secondary) !important;
    padding: 14px 24px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    border: 1px solid var(--border-primary) !important;
    border-radius: var(--radius-sm) !important;
    cursor: pointer;
    transition: var(--transition-fast);
}

.btn-inserir-cancel:hover {
    background: rgba(0,0,0,0.05) !important;
    border-color: var(--text-secondary) !important;
}

.btn-novo-registro {
    background: linear-gradient(135deg, #00C9A7 0%, #008B74 100%) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(0, 201, 167, 0.3) !important;
    border: none !important;
}

.btn-novo-registro:hover {
    background: linear-gradient(135deg, #00E4BE 0%, #00A98A 100%) !important;
    box-shadow: 0 6px 20px rgba(0, 201, 167, 0.4) !important;
    transform: translateY(-2px) scale(1.02);
}

@media (max-width: 600px) {
    .form-inserir-grid {
        grid-template-columns: 1fr;
    }
    .form-inserir-grid .form-group.full-width {
        grid-column: span 1;
    }
    .modal-inserir-footer {
        flex-direction: column;
    }
    .modal-inserir-footer button {
        width: 100%;
        justify-content: center;
    }
}
/* ===== FIM CSS DO MODAL DE INSERÇÃO ===== */

/* SEARCHABLE DROPDOWN CSS */
.searchable-dropdown{position:relative;width:100%}
.searchable-dropdown-input{width:100%;padding:12px 16px;border:2px solid var(--border-primary);border-radius:var(--radius-sm);font-size:14px;font-family:inherit;background:var(--bg-card);color:var(--text-primary);transition:var(--transition-fast);cursor:text;box-sizing:border-box}
.searchable-dropdown-input:focus{outline:none;border-color:var(--color-azul);box-shadow:0 0 0 4px rgba(0,69,181,0.15)}
.searchable-dropdown-input.invalid{border-color:var(--error-red);box-shadow:0 0 0 4px rgba(255,71,87,0.15)}
.searchable-dropdown-list{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:2px solid var(--color-azul);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);z-index:9999;display:none;box-shadow:0 8px 20px rgba(0,0,0,0.15)}
.searchable-dropdown-list.show{display:block}
.searchable-dropdown-item{padding:10px 16px;cursor:pointer;font-size:13px;color:var(--text-primary);transition:background 0.15s;border-bottom:1px solid var(--border-light)}
.searchable-dropdown-item:last-child{border-bottom:none}
.searchable-dropdown-item:hover,.searchable-dropdown-item.highlighted{background:rgba(0,69,181,0.1);color:var(--color-azul)}
.searchable-dropdown-item.selected{background:var(--color-azul);color:white}
.searchable-dropdown-empty{padding:12px 16px;color:var(--text-muted);font-style:italic;font-size:13px;text-align:center}

</style>

<!-- IDENTIDADE VISUAL IPIRANGA -->
<style>
/* ===== TOKENS IPIRANGA ===== */
:root {
  --color-azul: #0045B5;
  --color-amarelo: #FFD100;
  --color-laranja: #FF6900;
  --color-indigo: #0068FF;
  --color-chumbo: #58595B;
  --color-asfalto: #939598;
  --color-cromo: #D1D3D4;
  --color-preto: #000000;
  
  /* Cores de suporte */
  --color-aqua: #00D9B8;
  --color-laranja-escuro: #F04C25;
  --color-cinza-claro: #F7F7F7;
  
  /* Tipografia */
  --font-title: 'Montserrat', 'Inter', Verdana, sans-serif;
  --font-text: 'Inter', 'Segoe UI', Arial, sans-serif;
}

/* ===== CABEÇALHO - AMARELO COM TEXTO AZUL ===== */
.header {
    background: var(--color-azul) !important;
    color: #fff !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
  }

  .header::before {
    background: linear-gradient(90deg, var(--color-amarelo), var(--color-laranja)) !important;

}

.header-left .header-title {
    color: #fff !important;
    -webkit-text-fill-color: #fff !important;
    background: none !important;

}

.header-subtitle {
    color: #fff !important;
    opacity: 0.9 !important;
}

.header-logo {
    background: var(--color-amarelo) !important;
    color: var(--color-azul) !important;
    box-shadow: 0 4px 12px rgba(255, 209, 0, 0.3) !important;
  }

  .header-stats .stat-item {
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
}

.header-stats .stat-value {
    color: #fff !important;
}

.header-stats .stat-label {
    color: #fff !important;
    opacity: 0.8 !important;
}

/* ===== ÍCONES E AVATAR ===== */
.header-actions .btn {
    color: #fff !important;
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
}

.header-actions .btn:hover {
  background: rgba(255, 255, 255, 0.5) !important;
}

/* ===== BOTÕES PRINCIPAIS ===== */
.btn-primary {
  background: var(--color-azul) !important;
  box-shadow: 0 5px 15px rgba(0, 69, 181, 0.3) !important;
  border: none !important;
}

.btn-primary:hover {
  background: var(--color-indigo) !important;
  box-shadow: 0 8px 25px rgba(0, 104, 255, 0.4) !important;
}

.btn-secondary {
  background: var(--color-chumbo) !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 5px 15px rgba(88, 89, 91, 0.3) !important;
}

.btn-secondary:hover {
  background: #6c6d6f !important;
  box-shadow: 0 8px 25px rgba(108, 109, 111, 0.4) !important;
}

.btn-ghost {
  color: var(--color-azul) !important;
  border-color: var(--color-azul) !important;
  background: transparent !important;
}

.btn-ghost:hover {
  color: var(--color-indigo) !important;
  border-color: var(--color-indigo) !important;
  background: rgba(0, 104, 255, 0.05) !important;
}

.btn-purple,
.btn-automation {
  background: var(--color-azul) !important;
  box-shadow: 0 5px 15px rgba(0, 69, 181, 0.3) !important;
}

.btn-purple:hover,
.btn-automation:hover {
  background: var(--color-indigo) !important;
  box-shadow: 0 8px 25px rgba(0, 104, 255, 0.4) !important;
}

/* ===== KPIs E CARTÕES ===== */
.kpi-card {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

.kpi-card:hover {
  border-color: var(--color-azul) !important;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25) !important;
}

.kpi-card::before {
  background: linear-gradient(90deg, var(--color-azul), var(--color-indigo)) !important;
}

.kpi-card.active-filter {
  border-color: var(--color-laranja) !important;
  box-shadow: 0 0 0 3px rgba(255, 105, 0, 0.2), 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

.kpi-card.active-filter::before {
  background: linear-gradient(90deg, var(--color-laranja), #ff8533) !important;
}

.kpi-lbl {
  color: var(--color-azul) !important;
}

.kpi-val {
  color: var(--color-preto) !important;
}

.kpi-icon {
  color: var(--color-amarelo) !important;
  opacity: 0.3 !important;
}

.kpi-card:hover .kpi-icon {
  opacity: 0.4 !important;
}

/* KPIs específicos */
#kOpen,
#headerOpen {
  color: var(--color-amarelo) !important;
}

#kClosed,
#headerClosed {
  color: var(--color-aqua) !important;
}

/* ===== FILTROS E INPUTS ===== */
.filter-tag {
  background: var(--color-azul) !important;
  border-color: rgba(0, 69, 181, 0.3) !important;
}

.filter-tag:hover {
  background: var(--color-indigo) !important;
}

.form-control {
  border: 1px solid var(--color-cromo) !important;
  background: white !important;
  color: var(--color-preto) !important;
}

.form-control:focus {
  border-color: var(--color-indigo) !important;
  box-shadow: 0 0 0 3px rgba(0, 104, 255, 0.15) !important;
}

.select-wrapper::after {
  color: var(--color-chumbo) !important;
}

/* ===== CONTEXT BAR ===== */
.context-bar {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.context-text {
  color: var(--color-chumbo) !important;
}

.context-text span {
  background: rgba(0, 69, 181, 0.1) !important;
  color: var(--color-azul) !important;
  border: 1px solid rgba(0, 69, 181, 0.2) !important;
}

.context-hint {
  background: rgba(0, 69, 181, 0.05) !important;
  border: 1px solid rgba(0, 69, 181, 0.1) !important;
  color: var(--color-azul) !important;
}

/* ===== GRÁFICOS - AJUSTE DAS PALETAS ===== */
/* Gráfico de barras - Performance por Analista */
#chartAnal {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de rosca - Origem do Contato */
#chartOrigemContato {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de barras - Tipo de Atendimento */
#chartTipoAtendimento {
  --chart-color-ativo: var(--color-azul);
  --chart-color-receptivo: var(--color-amarelo);
}

/* Gráfico de rosca - Subclassificação */
#chartSubclassificacao {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de linha - Evolução Diária */
#chartEvo {
  --chart-color-total: var(--color-azul);
  --chart-color-concluido: var(--color-aqua);
}

/* Gráfico de barras horizontais - Distribuição por Motivo */
#chartMot {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
  --chart-color-accent: var(--color-laranja);
}

/* ===== TABELAS ===== */
.table thead {
  background: var(--color-azul) !important;
}

.table th {
  color: white !important;
  border-bottom-color: var(--color-amarelo) !important;
}

.table th:hover {
  background: rgba(255, 255, 255, 0.1) !important;
}

.table tr:nth-child(even) {
  background-color: var(--color-cinza-claro) !important;
}

.table tr:hover {
  background-color: rgba(255, 209, 0, 0.18) !important;
}

.table tr.active-filter {
  background-color: rgba(255, 105, 0, 0.1) !important;
}

/* Status pills */
.st-fechado {
  background: var(--color-aqua) !important;
  color: white !important;
}

.st-aberto {
  background: var(--color-amarelo) !important;
  color: var(--color-preto) !important;
}

/* ===== NOTIFICAÇÕES ===== */
.notification-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.notification-header {
  border-bottom-color: var(--color-cromo) !important;
}

.notification-title i {
  color: var(--color-azul) !important;
}

.notification-item {
  background: #f9f9f9 !important;
  border: 1px solid var(--color-cromo) !important;
}

.notification-item-stats {
  background: rgba(0, 69, 181, 0.05) !important;
}

/* Alertas/Toast */
.toast.success {
  border-left-color: var(--color-aqua) !important;
  background: #E9FCF6 !important;
  color: var(--color-preto) !important;
}

.toast.warning {
  border-left-color: var(--color-amarelo) !important;
  background: #FFF7CC !important;
  color: var(--color-preto) !important;
}

.toast.error {
  border-left-color: var(--color-laranja-escuro) !important;
  background: #FFE6DB !important;
  color: var(--color-preto) !important;
}

.toast.info {
  border-left-color: var(--color-azul) !important;
  background: #E6F0FF !important;
  color: var(--color-preto) !important;
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: white !important;
  border-right: 1px solid var(--color-cromo) !important;
}

.section-title {
  color: var(--color-azul) !important;
}

.section-title::after {
  background: linear-gradient(90deg, var(--color-azul), var(--color-amarelo)) !important;
}

#connectionStatus {
  border: 1px solid var(--color-azul) !important;
  background: rgba(0, 69, 181, 0.05) !important;
}

/* ===== CARTÕES GERAIS ===== */
.card {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.card-title i {
  color: inherit !important;
  background: none !important;
  -webkit-text-fill-color: inherit !important;
}

/* ===== PAGINAÇÃO ===== */
.pagination-btn {
  border-color: var(--color-cromo) !important;
  color: var(--color-azul) !important;
}

.pagination-btn:hover {
  background: var(--color-azul) !important;
  color: white !important;
  border-color: var(--color-azul) !important;
}

/* ===== MODAL DE AUTOMAÇÃO ===== */
.automation-popup,
.development-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.automation-header,
.development-header {
  border-bottom-color: var(--color-cromo) !important;
}

.automation-icon,
.development-icon {
  color: var(--color-azul) !important;
}

.tab-btn.active {
  color: var(--color-azul) !important;
  border-bottom-color: var(--color-azul) !important;
}

.tab-btn:hover {
  color: var(--color-indigo) !important;
}

.stat-card {
  background: #f9f9f9 !important;
  border: 1px solid var(--color-cromo) !important;
}

/* ===== LINKS ===== */
a {
  color: var(--color-azul) !important;
}

a:hover {
  color: var(--color-indigo) !important;
}

/* ===== ACESSIBILIDADE ===== */
:focus-visible {
  outline: 3px solid var(--color-indigo) !important;
  outline-offset: 2px !important;
}

/* ===== AJUSTES PARA TEXTO SOBRE FUNDO AMARELO ===== */
.on-yellow {
  color: var(--color-azul) !important;
}

/* ===== LEGENDAS/EIXOS PARA GRÁFICOS ===== */
.chart-container,
.bar-chart-mini-container,
.chart-scroll-container {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

/* Eixos de gráficos */
.chartjs-render-monitor .chartjs-tooltip {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  color: var(--color-preto) !important;
}

/* ===== NOVOS ESTILOS IPIRANGA ===== */

/* Tooltip para Motivo Mais Tratado - Estilo Ipiranga */
.motivo-tooltip {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
}

.motivo-tooltip h4 {
  color: var(--color-azul) !important;
  border-bottom: 2px solid var(--color-amarelo) !important;
  padding-bottom: 8px;
}

.motivo-tooltip p {
  color: var(--color-chumbo) !important;
}

.motivo-tooltip p strong {
  color: var(--color-azul) !important;
}

.motivo-tooltip p span {
  color: var(--color-preto) !important;
  font-weight: 600;
}

/* Legenda Ipiranga */
.legend-item {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.legend-item:hover {
  background: var(--color-cinza-claro) !important;
}

.legend-label {
  color: var(--color-preto) !important;
}

.legend-value {
  color: var(--color-azul) !important;
}

/* Ícone de informação no KPI */
.kpi-lbl .fa-circle-info {
  color: var(--color-azul) !important;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.kpi-lbl .fa-circle-info:hover {
  opacity: 1;
}

/* Styles for the Motivo Details Popup - Ipiranga */
.motivo-info-icon {
  color: var(--color-azul) !important;
}

.motivo-details-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.motivo-details-header {
  background: #00266E !important; /* Azul escuro do Ipiranga */
}

.motivo-details-title {
  color: white !important;
}

.motivo-details-subtitle {
  color: rgba(255, 255, 255, 0.9) !important;
}

.motivo-details-close {
  color: white !important;
}

.motivo-details-close:hover {
  background: rgba(255, 255, 255, 0.2) !important;
}

.motivo-details-content {
  background: white !important;
  color: var(--color-preto) !important;
}

.motivo-details-label {
  color: var(--color-chumbo) !important;
}

.motivo-details-value {
  color: var(--color-azul) !important;
}

.motivo-details-note {
  background: rgba(0, 69, 181, 0.05) !important;
  border: 1px solid rgba(0, 69, 181, 0.1) !important;
  color: var(--color-chumbo) !important;
}

.motivo-details-note i {
  color: var(--color-azul) !important;
}

/* EFEITOS ESPECIAIS NOS CARDS DO GRID - IPIRANGA */
.kpi-card::after {
  background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
              rgba(0, 69, 181, 0.1) 0%, 
              transparent 70%) !important;
}

/* RODAPÉ - IPIRANGA */
.footer-info-bar {
  background: rgba(0, 69, 181, 0.05) !important;
  border: 1px solid rgba(0, 69, 181, 0.1) !important;
}

.update-timestamp i {
  color: var(--color-azul) !important;
}

.update-timestamp span {
  color: var(--color-azul) !important;
}

.critical-cases-alert {
  background: linear-gradient(135deg, rgba(255, 71, 87, 0.05), rgba(255, 122, 69, 0.05)) !important;
  border: 1px solid rgba(255, 71, 87, 0.1) !important;
}

.critical-cases-alert:hover {
  background: linear-gradient(135deg, rgba(255, 71, 87, 0.08), rgba(255, 122, 69, 0.08)) !important;
  border-color: rgba(255, 71, 87, 0.2) !important;
}

.critical-cases-alert i {
  color: var(--color-laranja-escuro) !important;
}

.critical-count {
  background: var(--color-laranja-escuro) !important;
}

/* ALERTA NO HEADER - IPIRANGA */
.critical-alert {
  background: linear-gradient(135deg, rgba(255, 71, 87, 0.9), rgba(255, 105, 0, 0.9)) !important;
  box-shadow: 0 4px 12px rgba(255, 105, 0, 0.3) !important;
}

.critical-alert-count {
  background: white !important;
  color: var(--color-laranja-escuro) !important;
}

/* WORD CLOUD */
.word-cloud-card { min-height: 500px; }
.word-cloud-container { position: relative; height: 400px; width: 100%; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); overflow: hidden; display: flex; align-items: center; justify-content: center; }
.word-cloud-container canvas { max-width: 100%; max-height: 100%; }
.word-cloud-empty { text-align: center; color: var(--text-muted); padding: 40px; flex-direction: column; }
.word-cloud-empty i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; display: block; }
.word-cloud-empty p { font-size: 14px; max-width: 400px; margin: 0 auto; }
.word-cloud-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); }
.word-stat { text-align: center; padding: 12px; }
.word-stat-value { display: block; font-size: 24px; font-weight: 800; color: var(--brand-blue); font-family: var(--font-secondary); margin-bottom: 4px; }
.word-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
@media (max-width: 900px) { .word-cloud-stats { grid-template-columns: repeat(2,1fr); } .word-cloud-container { height: 300px; } }

</style>
</head>
<body>
<header class="header" role="banner" aria-label="Cabeçalho principal">
<div class="header-left">
    <img src="https://pbs.twimg.com/profile_images/1633505846981283841/KeJ1rMhg_400x400.jpg"
         alt="Logo Consolida Torre" 
         class="header-logo-img"
         aria-label="Logo ConsolidaTorre">
    <div class="header-titles">
        <div class="header-title">CONSOLIDA | TORRE</div>
        <div class="header-subtitle">Torre de Expansão • Mapeamento de Contato</div>
    </div>
</div>
<div class="header-right">
<div class="header-stats" aria-label="Estatísticas gerais">
<div class="stat-item">
<div class="stat-value" id="headerTotal">0</div>
<div class="stat-label">Total Registros</div>
</div>
<div class="stat-item">
<div class="stat-value" id="headerOpen" style="color:var(--color-amarelo)">0</div>
<div class="stat-label">Em Aberto</div>
</div>
<div class="stat-item">
<div class="stat-value" id="headerClosed" style="color:var(--color-aqua)">0</div>
<div class="stat-label">Concluídos</div>
</div>
</div>
<div class="header-actions">
    <button onclick="openModalInserir()" class="btn btn-primary btn-novo-registro" title="Novo Atendimento">
        <i class="fa-solid fa-plus"></i> Novo Atendimento
    </button>
    <a href="req_internas.html" class="btn btn-ghost" style="padding: 8px 14px; text-decoration: none;">
        <i class="fa-solid fa-clipboard-list"></i> Req. Internas
    </a>
    <button onclick="toggleFullScreen()" class="btn btn-ghost btn-icon" title="Tela Cheia">
        <i class="fa-solid fa-expand"></i>
    </button>
    <button onclick="toggleTheme()" class="btn btn-ghost btn-icon" title="Tema">
        <i class="fa-solid fa-moon"></i>
    </button>
</div></div>
</div>
</header>

<div class="layout">
<aside class="sidebar" aria-label="Filtros e ranking de analistas">
<div class="sb-icons">
<i class="fa-solid fa-database sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-filter sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-trophy sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-chart-line sb-icon" aria-hidden="true"></i>
</div>
<div class="sb-content">
<div class="mb-md">
<div class="section-title">Fonte de Dados</div>
<div id="connectionStatus" style="border:1px solid rgba(61, 141, 255, 0.3); background: rgba(61, 141, 255, 0.1); border-radius:var(--radius-sm); padding:18px; text-align:center; box-shadow: var(--shadow-sm); backdrop-filter: blur(10px);">
<div style="font-size:13px; font-weight:700; color:var(--brand-blue); margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px;">
<i class="fa-solid fa-database"></i> <span id="dataSourceStatus">Nenhuma Base Carregada</span>
</div>
<div style="font-size:11px; color:var(--brand-blue); margin-bottom:12px; font-weight:500;">
<span id="lastLoadInfo">Clique em "Carregar Nova Base" para começar</span>
</div>
<div style="display: flex; gap: 8px; margin-top: 10px;">
<button onclick="document.getElementById('fileInput').click()" class="btn btn-secondary" style="flex:1; justify-content:center; padding:10px; font-size:12px;">
<i class="fa-solid fa-upload"></i> Carregar Base
</button>
<button onclick="loadLocalData()" class="btn btn-ghost" style="flex:1; justify-content:center; padding:10px; font-size:12px;">
<i class="fa-solid fa-database"></i> Dados Salvos
</button>
</div>
</div>
</div>
<div class="mb-md">
<div class="section-title">Filtros principais</div>
<input id="qSearch" class="form-control" placeholder="🔍 Buscar (CNPJ, Razão Social, Analista)..." aria-label="Busca rápida">
<div style="font-size:12px; color:var(--text-secondary); margin-bottom:6px; font-weight:500;">Período de análise</div>
<div class="select-wrapper">
<select id="datePreset" class="form-control" style="margin-bottom:8px;" aria-label="Filtro de período predefinido">
<option value="">Período Personalizado</option>
<option value="last7">Últimos 7 dias</option>
<option value="last30">Últimos 30 dias</option>
<option value="currentMonth">Mês Atual</option>
<option value="lastMonth">Mês Passado</option>
<option value="currentYear">Ano Atual</option>
<option value="fullRange">Período Completo (Base)</option>
</select>
</div>
<div class="flex gap-xs mb-sm">
<input id="dateStart" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data inicial">
<input id="dateEnd" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data final">
</div>
<div class="select-wrapper">
<select id="motivoSelect" class="form-control" aria-label="Filtro de motivo">
<option value="">Todos Motivos</option>
</select>
</div>
<div class="select-wrapper">
<div class="analista-filter-container">
<label class="analista-todos-label">
<input type="checkbox" id="analistaSelectAll" checked> <span>Todos Analistas</span>
</label>
<select id="analistaSelect" class="form-control" aria-label="Filtro de analista" multiple style="height: 100px;">
</select>
</div>
</div>
</div>
<div class="mb-md">
<div class="section-title">Filtros avançados</div>
<div class="select-wrapper">
<select id="subSelect" class="form-control" aria-label="Filtro de subclassificação">
<option value="">Todas Subclasses</option>
</select>
</div>
<div class="select-wrapper">
<select id="tipoContatoSelect" class="form-control" aria-label="Filtro de tipo de contato">
<option value="">Todos Tipos</option>
<option value="Ativo">Ativo</option>
<option value="Receptivo">Receptivo</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label"><i class="fa-solid fa-building"></i> Área Responsável</label>
<select id="areaResponsavelSelect" class="form-control" aria-label="Filtro de área responsável">
<option value="">Todas Áreas</option>
</select>
</div>
<div class="flex gap-sm mt-sm">
<button id="applyBtn" class="btn btn-primary" type="button" style="flex:1">
<i class="fa-solid fa-rotate-right"></i> Aplicar Filtros
</button>
<button id="clearBtn" class="btn btn-ghost" type="button" style="flex:1">
<i class="fa-solid fa-eraser"></i> Limpar Tudo
</button>
</div>
<div class="flex gap-sm mt-md">
    <button id="btnCompareFilter" class="btn btn-ghost" type="button" style="flex:1" onclick="TimeCompare.toggle()" title="Comparar com período anterior">
        <i class="fa-solid fa-code-compare"></i> Comparar
    </button>
    <button id="btnAnnotationsFilter" class="btn btn-ghost" type="button" style="flex:1" onclick="toggleAnnotations()" title="Adicionar anotações">
        <i class="fa-solid fa-sticky-note"></i> Anotações
    </button>
</div>

</div>
<div>
<div class="section-title">Ranking Analistas</div>
<div id="gamificationBoard">
<div style="font-size:13px; color:var(--text-muted); text-align:center; padding:15px;">Carregando ranking...</div>
</div>
</div>
</div>
</aside>

<main class="main" id="main-content" role="main">
<div class="context-bar fade-in">
<div class="context-text" id="contextSummary">Carregue uma base de dados para começar...</div>
<div class="context-actions">
<div class="context-hint">
<i class="fa-solid fa-lightbulb"></i>
<span>Clique em gráficos, células ou KPIs para filtrar/desfiltrar</span>
</div>
<button class="btn btn-automation" onclick="showAutomationModal()" aria-label="Dashboard de Análise por Motivo">
<i class="fa-solid fa-chart-network"></i> Dashboard por Motivo
</button>

<button onclick="generateExecutiveReport()" class="btn btn-purple" aria-label="Gerar relatório executivo">
<i class="fa-solid fa-file-pdf"></i> Relatório Executivo
</button>
</div>
</div>

<div id="activeFilters" aria-label="Filtros ativos"></div>

<!-- COMPARE TOGGLE -->
<div class="compare-toggle" id="compareToggle">
    <div class="compare-toggle-label"><i class="fa-solid fa-code-compare"></i> Comparar com:</div>
    <div class="compare-presets">
        <button class="compare-preset" onclick="TimeCompare.setPreset('7d')">7 dias antes</button>
        <button class="compare-preset" onclick="TimeCompare.setPreset('14d')">14 dias antes</button>
        <button class="compare-preset" onclick="TimeCompare.setPreset('30d')">Mês anterior</button>
        <button class="compare-preset" onclick="TimeCompare.setPreset('custom')">Personalizado</button>
    </div>
    <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:6px;" onclick="TimeCompare.disable()"><i class="fa-solid fa-times"></i></button>
</div>

<!-- COMPARE SUMMARY -->
<div class="compare-summary" id="compareSummary">
    <div class="compare-summary-header">
        <div class="compare-summary-title"><i class="fa-solid fa-chart-line"></i> Análise Comparativa</div>
        <div class="compare-period-badge" id="comparePeriodBadge">vs período anterior</div>
    </div>
    <div class="compare-grid" id="compareGrid"></div>
    <div class="evolution-score" id="evolutionScore"></div>
</div>

<!-- SMART BAR -->
<div class="smart-bar" id="smartBar">
    <div class="smart-bar-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
    <div class="smart-bar-content">
        <div class="smart-bar-title" id="smartBarTitle">Analisando...</div>
        <div class="smart-bar-desc" id="smartBarDesc">Carregue dados</div>
    </div>
    <div style="display:flex;gap:8px;">
        <button style="padding:8px 16px;font-size:12px;background:var(--brand-blue);color:white;border:none;border-radius:6px;cursor:pointer;" id="smartBarAction">Ver</button>
        <button style="padding:8px;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:var(--text-muted);cursor:pointer;" onclick="dismissSmartBar()"><i class="fa-solid fa-times"></i></button>
    </div>
</div>

<!-- ANNOTATIONS PANEL -->
<div class="annotations-panel" id="annotationsPanel">
    <div class="annotations-header">
        <div class="annotations-title"><i class="fa-solid fa-sticky-note"></i> Contexto do Período</div>
        <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;" onclick="toggleAnnotations()"><i class="fa-solid fa-chevron-up"></i></button>
    </div>
    <div class="annotations-body">
        <div class="annotation-input-group">
            <input type="text" class="annotation-input" id="annotationText" placeholder="Ex: Falha sistêmica às 14h..." maxlength="200">
            <select class="annotation-type-select" id="annotationType">
                <option value="note">📝 Observação</option>
                <option value="event">🚨 Evento</option>
                <option value="milestone">🎯 Marco</option>
            </select>
            <button class="btn-add-annotation" onclick="addAnnotation()"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div class="annotations-list" id="annotationsList"></div>
    </div>
</div>

<!-- SIMULATION PANEL -->
<div class="simulation-panel" id="simulationPanel">
    <div class="simulation-header">
        <div class="simulation-title"><i class="fa-solid fa-flask"></i> Modo Simulação <span class="simulation-badge">WHAT-IF</span></div>
        <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;" onclick="toggleSimulation()"><i class="fa-solid fa-times"></i></button>
    </div>
    <div class="simulation-body">
        <div class="simulation-sliders">
            <div><div class="simulation-slider-header"><span class="simulation-slider-label">Redução do Backlog</span><span class="simulation-slider-value" id="simBacklogValue">0%</span></div><input type="range" class="simulation-slider" id="simBacklog" min="0" max="100" value="0" oninput="updateSimulation()"></div>
            <div><div class="simulation-slider-header"><span class="simulation-slider-label">Aumento FCR</span><span class="simulation-slider-value" id="simFCRValue">0%</span></div><input type="range" class="simulation-slider" id="simFCR" min="0" max="50" value="0" oninput="updateSimulation()"></div>
            <div><div class="simulation-slider-header"><span class="simulation-slider-label">Redução Tempo Médio</span><span class="simulation-slider-value" id="simTimeValue">0%</span></div><input type="range" class="simulation-slider" id="simTime" min="0" max="50" value="0" oninput="updateSimulation()"></div>
        </div>
        <div class="simulation-results">
            <div class="simulation-results-title">Impacto Estimado</div>
            <div class="simulation-results-grid">
                <div class="simulation-result-card"><div class="simulation-result-value" id="simResBacklog">-</div><div class="simulation-result-label">Dias p/ Zerar</div></div>
                <div class="simulation-result-card"><div class="simulation-result-value" id="simResFCR">-</div><div class="simulation-result-label">FCR Projetado</div></div>
                <div class="simulation-result-card"><div class="simulation-result-value" id="simResTime">-</div><div class="simulation-result-label">Tempo Médio</div></div>
                <div class="simulation-result-card"><div class="simulation-result-value" id="simResEfficiency">-</div><div class="simulation-result-label">Eficiência</div></div>
            </div>
        </div>
    </div>
</div>

<!-- EFFICIENCY PANEL -->
<div class="efficiency-panel" id="efficiencyPanel">
    <div class="efficiency-header">
        <div class="efficiency-title"><i class="fa-solid fa-gauge-high"></i> Indicadores de Eficiência</div>
    </div>
    <div class="efficiency-grid" id="efficiencyGrid"></div>
</div>

<div class="kpi-sticky-container">
<div class="kpi-grid">
<!-- NOVA ORDEM DOS KPIs -->
<div class="kpi-card slide-in-left" id="kpiTotal" data-filter="Total" style="animation-delay: 0.1s">
<div class="kpi-content">
<div class="kpi-val" id="kTotal">0</div>
<div class="total-card-separator"></div>
<div class="kpi-lbl">Total de registros</div>
<div class="demanda-interna-indicator">
<i class="fa-solid fa-inbox" style="font-size: 0.9em;"></i>
<span id="demandaInternaCount">0</span> Requisições internas
</div>
<div class="kpi-helper" id="kTotalHelper">Clique para limpar todos os filtros</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-layer-group"></i></div>
</div>

<div class="kpi-card slide-in-left" id="kpiOpen" data-filter="Aberto" style="animation-delay: 0.2s">
<div class="kpi-content">
<div class="kpi-val" id="kOpen" style="color:var(--color-amarelo)">0</div>
<div class="kpi-lbl">Em aberto</div>
<div class="kpi-trend neutral" id="kOpenTrend"><span>0%</span></div>
<div class="kpi-helper" id="kOpenHelper">Clique para filtrar/desfiltrar por status "Em Aberto"</div>
</div>
<div class="kpi-icon"><i class="fa-regular fa-clock"></i></div>
</div>

<div class="kpi-card slide-in-left" id="kpiClosed" data-filter="Fechado" style="animation-delay: 0.3s">
<div class="kpi-content">
<div class="kpi-val" id="kClosed" style="color:var(--color-aqua)">0</div>
<div class="kpi-lbl">Concluídos</div>
<div class="kpi-trend neutral" id="kClosedTrend"><span>0%</span></div>
<div class="kpi-helper" id="kClosedHelper">Clique para filtrar/desfiltrar por status "Concluído"</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-check-circle"></i></div>
</div>

<!-- CNPJ ÚNICOS NO PERÍODO -->
<div class="kpi-card slide-in-left" id="kpiCnpjCount" style="animation-delay: 0.4s">
<div class="kpi-content">
<div class="kpi-val" id="kCnpjCount">0</div>
<div class="kpi-lbl">CNPJ Únicos</div>
<div class="kpi-trend neutral" id="kCnpjTrend"><i class="fa-solid fa-chart-simple"></i> <span>--</span></div>
<div class="kpi-helper">Quantidade de CNPJ distintos no período</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-building"></i></div>
</div>

<!-- MOTIVO MAIS TRATADO -->
<div class="kpi-card slide-in-left" id="kpiTopMotivo" style="animation-delay: 0.5s">
<div class="kpi-content">
<div class="kpi-val" id="kTopMotivo" title="">-</div>
<div class="kpi-lbl">Motivo Mais Tratado <i class="fa-solid fa-circle-info motivo-info-icon" onclick="showMotivoDetailsPopup(event)"></i></div>
<div class="kpi-trend neutral" id="kMotivoTrend"><i class="fa-solid fa-percent"></i> <span>--</span></div>
<div class="kpi-helper">Tema com maior volume</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-chart-bar"></i></div>
</div>

<!-- FCR -->
<div class="kpi-card slide-in-left" id="kpiFCR" data-filter="FCR" style="animation-delay: 0.6s">
<div class="kpi-content">
<div class="kpi-val" id="kFCR">0%</div>
<div class="kpi-lbl">FCR (Resolução 1ª)</div>
<div class="kpi-trend neutral" id="kFCRTrend"><span>--</span></div>
<div class="kpi-helper" id="kFCRHelper">Clique para filtrar/desfiltrar por FCR = Sim</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-bullseye"></i></div>
</div>

<!-- TEMPO MÉDIO DE RESOLUÇÃO -->
<div class="kpi-card slide-in-left avg-time-card" id="kpiAvgTime" data-filter="AvgTime" style="animation-delay: 0.7s">
<div class="kpi-content">
<div class="kpi-val" id="kAvgTime">0d</div>
<div class="kpi-lbl">Tempo Médio Resolução</div>
<div class="kpi-trend neutral" id="kAvgTimeTrend"><span>--</span></div>
<div class="kpi-helper" id="kAvgTimeHelper">Baseado apenas nos casos concluídos</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-hourglass-half"></i></div>
</div>

</div>
</div>

<div class="charts-grid">
<!-- Linha 1: Tipo de Atendimento e Canais de Contato -->
<div class="card fade-in" style="animation-delay: 0.3s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-headset" style="color:var(--brand-blue)"></i> Tipo de Atendimento</h3>
<div class="card-subtitle">Distribuição entre contatos Ativos e Receptivos</div>
</div>
</div>
<div class="bar-chart-mini-container">
<canvas id="chartTipoAtendimento" role="img" aria-label="Gráfico de barras para tipo de atendimento"></canvas>
</div>
<div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
<div style="display:flex; align-items:center; gap:6px; font-size:11px;">
<div style="width:12px; height:12px; background:var(--brand-blue); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Ativo</span>
</div>
<div style="display:flex; align-items:center; gap:6px; font-size:11px;">
<div style="width:12px; height:12px; background:var(--color-amarelo); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Receptivo</span>
</div>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique nas barras para filtrar/desfiltrar por tipo
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.45s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-comments" style="color:var(--success-green)"></i> Canais de Contato</h3>
<div class="card-subtitle">Distribuição dos canais de comunicação</div>
</div>
<button onclick="downloadChart('chartOrigemContato', 'origem-contato.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
<i class="fa-solid fa-download"></i> Exportar
</button>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartOrigemContato" role="img" aria-label="Gráfico de rosca com origem do contato"></canvas>
<div class="doughnut-center-info" id="chartOrigemContatoCenter">
<div class="doughnut-center-name">Total</div>
<div class="doughnut-center-value">0</div>
</div>
</div>
<div id="legendOrigemContato" class="legend-container"></div>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em uma fatia para filtrar/desfiltrar por origem
</div>
</div>

<!-- Linha 2: Subclassificação e GN -->
<div class="card fade-in" style="animation-delay: 0.5s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-sitemap" style="color:var(--brand-blue)"></i> Subclassificação</h3>
<div class="card-subtitle">Distribuição dos atendimentos por subclasse</div>
</div>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartSubclassificacao" role="img" aria-label="Gráfico de rosca por subclassificação"></canvas>
<div class="doughnut-center-info" id="chartSubclassificacaoCenter"></div>
</div>
<div id="legendSubclassificacao" class="legend-container"></div>
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.55s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-map" style="color:var(--brand-orange)"></i> Atendimentos por GN</h3>
<div class="card-subtitle">Distribuição por Gerência Nacional</div>
</div>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartGN" role="img" aria-label="Gráfico de rosca por GN"></canvas>
<div class="doughnut-center-info" id="chartGNCenter"></div>
</div>
<div id="legendGN" class="legend-container"></div>
</div>
</div>

<!-- Linha 3: Distribuição por Motivo (ocupa duas colunas) -->
<div class="card fade-in" style="animation-delay: 0.6s; grid-column: span 2;">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-folder-open" style="color:var(--brand-orange)"></i> Distribuição por Motivo</h3>
<div class="card-subtitle">Temas mais recorrentes (Ordenado)</div>
</div>
<button onclick="downloadChart('chartMot', 'distribuicao-motivo.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
<i class="fa-solid fa-download"></i> Exportar
</button>
</div>
<div class="chart-scroll-container">
<canvas id="chartMot" role="img" aria-label="Gráfico de barras horizontais por motivos"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer barra para filtrar/desfiltrar por motivo
</div>
</div>

<!-- Linha 4: Evolução Diária e Performance por Analista -->
<div class="card fade-in" style="animation-delay: 0.7s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-chart-line" style="color:var(--brand-blue)"></i> Evolução Diária</h3>
<div class="card-subtitle">Volume de atividades por dia (Total vs Concluído)</div>
</div>
<div style="display:flex; gap:8px; align-items:center;">
<div style="display:flex; align-items:center; gap:5px; font-size:11px;">
<div style="width:10px; height:10px; background:var(--brand-blue); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Total</span>
</div>
<div style="display:flex; align-items:center; gap:5px; font-size:11px;">
<div style="width:10px; height:10px; background:var(--success-green); border-radius:2px; border:1px dashed var(--success-green);"></div>
<span style="color:var(--text-secondary)">Concluído</span>
</div>
</div>
</div>
<div class="chart-container">
<canvas id="chartEvo" role="img" aria-label="Gráfico de linha com evolução diária de atendimentos"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer ponto para filtrar/desfiltrar por data específica
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.2s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-trophy" style="color:var(--brand-yellow)"></i> Performance por Analista</h3>
<div class="card-subtitle">Volume total de atividades por responsável</div>
</div>
</div>
<div class="chart-container">
<canvas id="chartAnal" role="img" aria-label="Gráfico de barras com atendimentos por analista"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em um analista para filtrar/desfiltrar
</div>
</div>
</div>

<div class="card fade-in" style="margin-top:20px; animation-delay: 0.8s">
<div class="card-header-row">
<div>
<h3 class="card-title" style="margin-bottom:5px;"><i class="fa-solid fa-table" style="color:var(--brand-blue)"></i> Detalhamento das Atividades</h3>
<div class="card-subtitle">Clique em uma linha para filtrar/desfiltrar por caso específico • Clique no cabeçalho para ordenar</div>
</div>
<div style="display:flex; align-items:center; gap:12px;">
<div class="pagination">
<div class="pagination-info" id="paginationInfo">0-0</div>
<button id="prevPage" class="pagination-btn" type="button" aria-label="Página anterior">◀</button>
<button id="nextPage" class="pagination-btn" type="button" aria-label="Próxima página">▶</button>
</div>
<button onclick="exportCSV()" class="btn btn-secondary" type="button">
<i class="fa-solid fa-download"></i> Exportar CSV
</button>
</div>
</div>
<div class="table-container" aria-label="Tabela detalhada das atividades">
<table class="table" id="dataTable">
<thead>
<tr>
<th data-key="status">Status <span class="sort-indicator"></span></th>
<th data-key="dtStart">Data Início <span class="sort-indicator"></span></th>
<th data-key="dtEnd">Data Fim <span class="sort-indicator"></span></th>
<th data-key="tempoResolucaoDias">Tempo Resolução <span class="sort-indicator"></span></th>
<th data-key="fcr">FCR <span class="sort-indicator"></span></th>
<th data-key="analista">Analista <span class="sort-indicator"></span></th>
<th data-key="motivo">Motivo <span class="sort-indicator"></span></th>
<th data-key="sub">Sub Classificação <span class="sort-indicator"></span></th>
<th data-key="solicitante">Razão Social <span class="sort-indicator"></span></th>
<th data-key="tipoContato">Tipo Atendimento <span class="sort-indicator"></span></th>
<th data-key="origemContato">Origem Contato <span class="sort-indicator"></span></th>
<th data-key="descricao" onclick="sortTable('descricao')">Descrição <span class="sort-indicator"></span></th>
<th data-key="id" onclick="sortTable('id')">ID <span class="sort-indicator"></span></th>
                        <th style="width:45px;text-align:center;">ID</th>
                        <th style="width:75px;text-align:center;">Ações</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="14" style="text-align:center; padding:30px; color:var(--text-muted); font-weight:500;">
<i class="fa-solid fa-file-excel" style="margin-right:10px;"></i>
Carregue uma base de dados para visualizar as informações
</td>
</tr>
</tbody>
</table>
</div>
<div style="text-align:center; margin-top:15px;">
    <div onclick="showDevelopmentPopup()" style="cursor:pointer; font-size:12px; color:var(--text-secondary); display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:rgba(61,141,255,0.1); border-radius:8px; border:1px solid rgba(61,141,255,0.2); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(61,141,255,0.2)'" onmouseout="this.style.background='rgba(61,141,255,0.1)'">
        <i class="fa-solid fa-info-circle" style="color:var(--brand-blue)"></i>
        <span>Use <kbd style="background:var(--gradient-primary); color:white; padding:2px 8px; border-radius:4px; font-weight:600;">F</kbd> para focar na busca rápida (Clique para ajuda)</span>
    </div>
</div>
</div>

        <div class="card fade-in word-cloud-card" style="margin-top: 24px; animation-delay: 0.9s">
            <div class="card-header-row">
                <div>
                    <h3 class="card-title"><i class="fa-solid fa-cloud" style="color:var(--purple)"></i> Nuvem de Palavras</h3>
                    <div class="card-subtitle">Termos mais frequentes nas descrições dos atendimentos</div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="wordCloudMinFreq" class="form-control" style="width: 150px; margin: 0;" onchange="updateWordCloud()">
                        <option value="1">Todas palavras</option>
                        <option value="2" selected>Mín. 2 ocorrências</option>
                        <option value="3">Mín. 3 ocorrências</option>
                        <option value="5">Mín. 5 ocorrências</option>
                    </select>
                    <button onclick="updateWordCloud()" class="btn btn-ghost" style="padding: 8px 14px;"><i class="fa-solid fa-rotate"></i> Atualizar</button>
                    <button onclick="downloadWordCloudImage()" class="btn btn-secondary" style="padding: 8px 14px;"><i class="fa-solid fa-download"></i> Exportar</button>
                </div>
            </div>
            <div class="word-cloud-container" id="wordCloudContainer">
                <canvas id="wordCloudCanvas"></canvas>
                <div id="wordCloudEmpty" class="word-cloud-empty" style="display: none;"><i class="fa-solid fa-cloud"></i><p>Carregue uma base de dados com a coluna "Descrição" para gerar a nuvem de palavras</p></div>
            </div>
            <div class="word-cloud-stats" id="wordCloudStats">
                <div class="word-stat"><span class="word-stat-value" id="wcTotalWords">0</span><span class="word-stat-label">Palavras Únicas</span></div>
                <div class="word-stat"><span class="word-stat-value" id="wcTopWord">-</span><span class="word-stat-label">Termo Mais Frequente</span></div>
                <div class="word-stat"><span class="word-stat-value" id="wcTopCount">0</span><span class="word-stat-label">Ocorrências do Top</span></div>
                <div class="word-stat"><span class="word-stat-value" id="wcDescCount">0</span><span class="word-stat-label">Descrições Analisadas</span></div>
            </div>
            <div style="text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 15px; font-weight: 500;"><i class="fa-solid fa-lightbulb"></i> Quanto maior a palavra, mais frequente ela aparece nas descrições.</div>
        </div>

        <!-- NOVO RODAPÉ COM INFORMAÇÕES DE ATUALIZAÇÃO -->
<div class="footer-info-bar">
    <div class="update-timestamp">
        <i class="fa-solid fa-clock"></i>
        Última atualização: <span id="lastUpdateTimeFull">--:-- --/--/----</span>
    </div>
    <div class="critical-cases-alert" onclick="showCriticalCases()" id="criticalAlertFooter" style="display: none;">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>Casos com mais de 3 dias em aberto</span>
        <div class="critical-count" id="criticalAlertCountFooter">0</div>
    </div>
    <div style="font-size: 12px; color: var(--text-muted);">
        Dashboard desenvolvido por <strong>Thiago Jr</strong> • Dados carregados: <span id="dataLoadedInfo">Nenhuma base carregada</span>
    </div>
</div>
</main>
</div>

<!-- Input de arquivo oculto -->
<input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(event)">

<!-- Popup de Notificações -->
<div class="notification-popup" id="notificationPopup" role="dialog" aria-label="Notificações" aria-hidden="true">
<div class="notification-header">
<div class="notification-title">
<i class="fa-solid fa-bell"></i>
Notificações
</div>
<div class="notification-subtitle">Mantenha-se atualizado com as atividades</div>
<button class="notification-close" onclick="toggleNotifications()" aria-label="Fechar notificações">
<i class="fa-solid fa-times"></i>
</button>
</div>
<div class="notification-content">
<div class="notification-item fade-in">
<div class="notification-item-title">
<span>Total de Registros Atualizado</span>
<span class="notification-item-date">De: 2025-11-11</span>
</div>
<div class="notification-item-content">
TOTAL DE REGISTROS atualizado com base nos dados mais recentes da planilha.
</div>
<div class="notification-item-stats">
<div>
<div class="stat-number">132</div>
<div class="stat-label">Total Registros</div>
</div>
<div>
<div class="stat-number">7</div>
<div class="stat-label">Em Aberto</div>
</div>
<div>
<div class="stat-number">125</div>
<div class="stat-label">Concluídos</div>
</div>
</div>
<div style="margin-top: 15px; font-size: 11px; color: var(--text-muted);">
<i class="fa-solid fa-info-circle"></i> Clique para limpar todos os filtros
</div>
</div>
<div class="notification-item fade-in" style="animation-delay: 0.1s">
<div class="notification-item-title">
<span>Tempo Médio de Resolução</span>
<span class="notification-item-date">Hoje</span>
</div>
<div class="notification-item-content">
TEMPO MÉDIO RESOLUÇÃO calculado com base apenas nos casos concluídos.
</div>
<div class="notification-item-stats">
<div style="flex: 1;">
<div class="stat-number" style="color: var(--purple)">0.8d</div>
<div class="stat-label">Tempo Médio</div>
</div>
</div>
</div>
<div class="notification-empty fade-in" style="animation-delay: 0.2s">
<i class="fa-regular fa-bell-slash"></i>
<h3>Nenhuma notificação no momento</h3>
<p>Novas notificações aparecerão aqui automaticamente</p>
</div>
</div>
<div class="notification-footer">
<button class="btn btn-ghost" style="flex: 1;" onclick="clearAllNotifications()" aria-label="Limpar todas as notificações">
<i class="fa-solid fa-trash"></i> Limpar Todas
</button>
<button class="btn btn-purple" style="flex: 1;" onclick="markAllAsRead()" aria-label="Marcar todas as notificações como lidas">
<i class="fa-solid fa-check-double"></i> Marcar como Lidas
</button>
</div>
</div>

<!-- Popup de Desenvolvimento -->
<div class="development-popup" id="developmentPopup" role="dialog" aria-label="Funcionalidade em desenvolvimento" aria-hidden="true">
<div class="development-header">
<div class="development-icon">
<i class="fa-solid fa-code"></i>
</div>
<div class="development-title">Em Desenvolvimento</div>
<div class="development-subtitle">Funcionalidade em construção</div>
</div>
<div class="development-content">
<div class="development-text">
Esta funcionalidade está em fase de desenvolvimento ativo.
Em breve você poderá aproveitar todos os recursos planejados.
</div>
<button class="btn btn-primary development-close" onclick="hideDevelopmentPopup()" aria-label="Entendi, fechar diálogo">
<i class="fa-solid fa-check"></i> Entendi
</button>
</div>
</div>

<!-- NOVO POPUP DE AUTOMAÇÃO - DASHBOARD POR MOTIVO -->
<div class="automation-popup" id="automationPopup" role="dialog" aria-label="Dashboard de Análise por Motivo" aria-hidden="true">
    <div class="automation-header">
        <div class="automation-icon">
            <i class="fa-solid fa-chart-network"></i>
        </div>
        <div class="automation-title">Dashboard de Análise por Motivo</div>
        <div class="automation-subtitle">Análise detalhada por categoria de motivo com métricas específicas</div>
        <button class="automation-close" onclick="hideAutomationModal()" aria-label="Fechar diálogo">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    
    <div class="automation-content">
        <!-- Tabs de Navegação -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchAutomationTab('distribuicao')" data-tab="distribuicao">
                <i class="fa-solid fa-table"></i> Distribuição por Motivo
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('analistas')" data-tab="analistas">
                <i class="fa-solid fa-users"></i> Performance por Analista
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('tempo')" data-tab="tempo">
                <i class="fa-solid fa-clock"></i> Métricas de Tempo (TMR)
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('evolucao')" data-tab="evolucao">
                <i class="fa-solid fa-chart-line"></i> Evolução Temporal
            </button>
        </div>
        
        <!-- Conteúdo das Tabs -->
        <div class="tabs-content">
            
            <!-- Tab 1: Distribuição por Motivo -->
            <div id="tab-distribuicao" class="tab-pane active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-list-check" style="color: var(--brand-blue);"></i>
                        Distribuição Detalhada por Motivo
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="motivoSearch" placeholder="🔍 Filtrar motivo..." 
                               class="form-control" style="width: 250px; margin: 0;">
                        <button onclick="exportMotivoCSV()" class="btn btn-secondary">
                            <i class="fa-solid fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 500px;">
                    <table class="table" id="motivoTable">
                        <thead>
                            <tr>
                                <th data-key="motivo" onclick="sortMotivoTable('motivo')">Motivo <span class="sort-indicator"></span></th>
                                <th data-key="total" onclick="sortMotivoTable('total')">Total <span class="sort-indicator"></span></th>
                                <th data-key="abertos" onclick="sortMotivoTable('abertos')">Em Aberto <span class="sort-indicator"></span></th>
                                <th data-key="fechados" onclick="sortMotivoTable('fechados')">Concluídos <span class="sort-indicator"></span></th>
                                <th data-key="fcr" onclick="sortMotivoTable('fcr')">FCR <span class="sort-indicator"></span></th>
                                <th data-key="tmr" onclick="sortMotivoTable('tmr')">TMR (dias) <span class="sort-indicator"></span></th>
                                <th data-key="analistas" onclick="sortMotivoTable('analistas')">Analistas <span class="sort-indicator"></span></th>
                                <th data-key="tipos" onclick="sortMotivoTable('tipos')">Tipos Contato <span class="sort-indicator"></span></th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="motivoTableBody">
                            <tr>
                                <td colspan="9" style="text-align:center; padding:30px; color:var(--text-muted);">
                                    <i class="fa-solid fa-file-excel" style="margin-right:10px;"></i>
                                    Carregue uma base de dados para visualizar as informações
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="motivo-stats-grid">
                    <div class="stat-card">
                        <h4><i class="fa-solid fa-chart-pie"></i> Resumo Estatístico</h4>
                        <div id="motivoStats" style="font-size: 13px; line-height: 1.6;">
                            Carregue uma base de dados para visualizar as estatísticas
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4><i class="fa-solid fa-ranking-star" style="color:var(--brand-orange);"></i> Top 5 Motivos</h4>
                        <div id="topMotivos" style="font-size: 13px;">
                            Carregue uma base de dados para visualizar o ranking
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Performance por Analista -->
            <div id="tab-analistas" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-user-tie" style="color: var(--success-green);"></i>
                        Performance dos Analistas por Motivo
                    </h3>
                    <select id="analistaFilterMotivo" class="form-control" style="width: 200px; margin: 0;" onchange="loadAnalistaMotivoData()">
                        <option value="">Todos os Motivos</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartAnalistaVolume"></canvas>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartAnalistaFCR"></canvas>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 400px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Analista</th>
                                <th>Motivos Únicos</th>
                                <th>Total</th>
                                <th>Aberto</th>
                                <th>Concluído</th>
                                <th>FCR</th>
                                <th>TMR Médio (dias)</th>
                                <th>Origem Principal</th>
                            </tr>
                        </thead>
                        <tbody id="analistaMotivoTable">
                            <tr>
                                <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">
                                    Carregue uma base de dados para visualizar as informações
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab 3: Métricas de Tempo -->
            <div id="tab-tempo" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-hourglass-half" style="color: var(--purple);"></i>
                        Análise de Tempo Médio de Resolução (TMR) por Motivo
                    </h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="chartTMRMotivo"></canvas>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="stat-card">
                            <h4 style="color: var(--brand-blue);">TMR Geral</h4>
                            <div style="font-size: 28px; font-weight: 900; color: var(--brand-blue);" id="tmrGeral">0d</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Média de todos os motivos concluídos</div>
                        </div>
                        
                        <div class="stat-card">
                            <h4 style="color: var(--brand-orange);">Motivo mais Rápido</h4>
                            <div id="motivoMaisRapido" style="font-size: 14px; font-weight: 600;">-</div>
                            <div id="tempoMaisRapido" style="font-size: 12px; color: var(--text-muted);">-</div>
                        </div>
                        
                        <div class="stat-card">
                            <h4 style="color: var(--error-red);">Motivo mais Lento</h4>
                            <div id="motivoMaisLento" style="font-size: 14px; font-weight: 600;">-</div>
                            <div id="tempoMaisLento" style="font-size: 12px; color: var(--text-muted);">-</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-primary);">
                        <i class="fa-solid fa-table"></i> Detalhamento por Motivo
                    </h4>
                    <div class="table-container" style="max-height: 300px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Motivo</th>
                                    <th>Total Concluídos</th>
                                    <th>TMR (dias)</th>
                                    <th>Desvio Padrão</th>
                                    <th>Casos > 7 dias</th>
                                </tr>
                            </thead>
                            <tbody id="tmrDetailTable">
                                <tr>
                                    <td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">
                                        Carregue uma base de dados para visualizar as informações
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab 4: Evolução Temporal -->
            <div id="tab-evolucao" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-chart-line" style="color: var(--success-green);"></i>
                        Evolução Temporal por Motivo
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="motivoEvolucaoSelect" class="form-control" style="width: 250px; margin: 0;" onchange="updateEvolucaoChart()">
                            <option value="">Selecione um motivo</option>
                        </select>
                        <select id="periodoEvolucao" class="form-control" style="width: 150px; margin: 0;" onchange="updateEvolucaoChart()">
                            <option value="7">Últimos 7 dias</option>
                            <option value="30" selected>Últimos 30 dias</option>
                            <option value="90">Últimos 90 dias</option>
                            <option value="all">Todo o período</option>
                        </select>
                    </div>
                </div>
                
                <div class="chart-container" style="height: 400px; margin-bottom: 20px;">
                    <canvas id="chartEvolucaoMotivo"></canvas>
                </div>
                
                <div class="motivo-stats-grid">
                    <div class="stat-card">
                        <h4 style="color: var(--brand-blue);">
                            <i class="fa-solid fa-calendar-day"></i> Tendência Diária
                        </h4>
                        <div id="tendenciaDiaria" style="font-size: 13px;">
                            Carregue uma base de dados para visualizar a análise
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4 style="color: var(--brand-orange);">
                            <i class="fa-solid fa-chart-column"></i> Pico de Ocorrências
                        </h4>
                        <div id="picoOcorrencias" style="font-size: 13px;">
                            Carregue uma base de dados para visualizar os picos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOVO POPUP DE DETALHES DO MOTIVO -->
<div class="motivo-details-popup" id="motivoDetailsPopup" role="dialog" aria-label="Detalhes do motivo mais tratado" aria-hidden="true">
    <div class="motivo-details-header">
        <div class="motivo-details-title">Detalhes de Tempo por Motivo</div>
        <div class="motivo-details-subtitle">Assunto mais rápido e mais demorado</div>
        <button class="motivo-details-close" onclick="hideMotivoDetailsPopup()" aria-label="Fechar diálogo">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    <div class="motivo-details-content">
        <div class="motivo-details-row">
            <div class="motivo-details-label">Motivo Mais Tratado:</div>
            <div class="motivo-details-value" id="detailMotivoMaisTratado">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Quantidade:</div>
            <div class="motivo-details-value" id="detailQuantidade">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Assunto Mais Rápido:</div>
            <div class="motivo-details-value" id="detailMaisRapido">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Tempo Médio (Mais Rápido):</div>
            <div class="motivo-details-value" id="detailTempoMaisRapido">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Assunto Mais Demorado:</div>
            <div class="motivo-details-value" id="detailMaisDemorado">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Tempo Médio (Mais Demorado):</div>
            <div class="motivo-details-value" id="detailTempoMaisDemorado">-</div>
        </div>
        <div class="motivo-details-note">
            <i class="fa-solid fa-info-circle"></i> Nota: Os tempos são calculados com base na média de resolução por motivo (apenas casos concluídos) em dias.
        </div>
    </div>
</div>

<!-- POPUP DE CASOS CRÍTICOS -->
<div class="development-popup" id="criticalCasesPopup" role="dialog" aria-label="Casos Críticos em Aberto" aria-hidden="true">
    <div class="development-header">
        <div class="development-icon">
            <i class="fa-solid fa-triangle-exclamation" style="color: var(--error-red);"></i>
        </div>
        <div class="development-title">Casos Críticos</div>
        <div class="development-subtitle">Casos em aberto há mais de 3 dias</div>
        <button class="automation-close" onclick="hideCriticalCases()" aria-label="Fechar diálogo">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    <div class="development-content">
        <div class="table-container" style="max-height: 400px; margin-bottom: 20px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Analista</th>
                        <th>Motivo</th>
                        <th>Data Início</th>
                        <th>Dias em Aberto</th>
                        <th>Razão Social</th>
                    </tr>
                </thead>
                <tbody id="criticalCasesTable">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">
                            Nenhum caso crítico encontrado
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 15px;">
            <i class="fa-solid fa-lightbulb"></i> Estes casos requerem atenção imediata para resolução
        </div>
        <button class="btn btn-primary development-close" onclick="hideCriticalCases()" style="margin-top: 20px;">
            <i class="fa-solid fa-check"></i> Entendi
        </button>
    </div>
</div>

<div id="loading">
<div class="loading-content">
<div class="loading-spinner"></div>
<div class="loading-text" id="loadingText">Carregando...</div>
<div id="loadingProgress" style="width:0%; height:4px; background:#0045B5; border-radius:2px; margin-top:15px; transition:width 0.3s;"></div>
</div>
</div>

<script>
/* ===== JAVASCRIPT PRINCIPAL ===== */
Chart.register(ChartDataLabels);

// ===== API DATA LOADING FUNCTIONS =====
function chamarApi() {
    const url = "https://default72b5f4168f414c88a6a0bb4b913838.88.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/cd3aa2644168498dad0aae53087ae69c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Xzxs36C2ZY1CpeRFbbQiijhO1H6HuHmdCr4tsrYf12g";

    showLoading(true, "Carregando dados da API...");
    startLoadingProgress();

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro na resposta da API: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        processApiData(data);
        LAST_UPDATE_TIMESTAMP = new Date();
        updateLastUpdateTimestamp();
        showToast('Dados carregados da API com sucesso!', 'success');
    })
    .catch(error => {
        console.error('Erro ao carregar dados da API:', error);
        showToast('Erro ao carregar dados da API: ' + error.message, 'error');
        showLoading(false);
    });
}

function processApiData(apiResponse) {
    try {
        let json = Array.isArray(apiResponse) ? apiResponse : (apiResponse.value || apiResponse.data || apiResponse.records || [apiResponse]);
        if (!Array.isArray(json)) json = [json];

        RAW = json.map((row, index) => {
            // === FUNÇÃO AUXILIAR PARA PARSEAR DATA SEM PROBLEMA DE TIMEZONE ===
            function parseDate(raw) {
                if (!raw) return null;
            
                // Se já for um objeto Date, apenas retorna
                if (raw instanceof Date) return raw;
            
                if (typeof raw === 'number') {
                    // Excel serial date (comum se você colar dados de planilhas)
                    const date = new Date((raw - 25568) * 86400 * 1000);
                    return new Date(date.getFullYear(), date.getMonth(), date.getDate());
                } 
                
                if (typeof raw === 'string') {
                    // Se a string vier no formato ISO do SharePoint (ex: 2023-10-25T00:00:00Z)
                    // Extraímos apenas a parte da data (YYYY-MM-DD)
                    const dateStr = raw.split('T')[0];
                    
                    // Tenta tratar formatos YYYY-MM-DD (Padrão ISO/SharePoint)
                    if (dateStr.includes('-')) {
                        const parts = dateStr.split('-');
                        if (parts.length === 3) {
                            // Mês no JS começa em 0, por isso o -1
                            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                    }
                    
                    // Tenta tratar formatos brasileiros DD/MM/YYYY (Caso venha de input manual)
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                        }
                    }
                }
            
                // Fallback para o construtor padrão se nada acima funcionar
                const fallbackDate = new Date(raw);
                return isNaN(fallbackDate.getTime()) ? null : fallbackDate;
            }

            // Data Início: row.Data (API) ou fallbacks
            let dataInicioRaw = row.Data || row["dataInício"] || row["dataInicio"] || row["Data Inicio"] || row.dtStart;
            let dataInicioObj = parseDate(dataInicioRaw);

            // Data Fim: row.DataFim (API) ou fallbacks
            let dataFimRaw = row.DataFim || row["dataFim"] || row["Data Fim"] || row.dtEnd;
            let dataFimObj = parseDate(dataFimRaw);

            let statusNorm = "Aberto";
            if (dataFimObj && !isNaN(dataFimObj.getTime())) statusNorm = "Fechado";
            let statusDisplay = row["status"] || row["Status de liberação"] || statusNorm;

            // FCR: row.FCR?.Value (API) ou fallbacks
            let fcrValue = row.FCR?.Value || row["fcr"] || row["FCR"] || "Não";
            if (typeof fcrValue === 'string') {
                fcrValue = fcrValue.trim().toUpperCase();
                if (fcrValue === 'SIM') fcrValue = 'Sim';
                if (fcrValue === 'NÃO' || fcrValue === 'NAO') fcrValue = 'Não';
            }

            let tempoResolucaoFormatado = "-";
            let tempoResolucaoDias = null;
            if (dataInicioObj && dataFimObj && !isNaN(dataInicioObj.getTime()) && !isNaN(dataFimObj.getTime()) && statusNorm === "Fechado" && dataFimObj >= dataInicioObj) {
                const inicioDate = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), dataInicioObj.getDate());
                const fimDate = new Date(dataFimObj.getFullYear(), dataFimObj.getMonth(), dataFimObj.getDate());
                const diffMs = fimDate.getTime() - inicioDate.getTime();
                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDias === 0) {
                    tempoResolucaoDias = 1;
                    tempoResolucaoFormatado = "1 dia";
                } else {
                    tempoResolucaoDias = diffDias;
                    tempoResolucaoFormatado = `${diffDias} dias`;
                }
            }

            // Tipo de Contato: row.Tipodecontato?.Value (API) ou fallbacks
            let tipoContato = row.Tipodecontato?.Value || row["tipoAtendimento"] || row["Tipo de contato"] || "";
            tipoContato = String(tipoContato).trim();
            if (!tipoContato || tipoContato === "") tipoContato = "Não Informado";
            if (tipoContato.toLowerCase().includes("ativo")) tipoContato = "Ativo";
            if (tipoContato.toLowerCase().includes("receptivo")) tipoContato = "Receptivo";

            // CANAL DE CONTATO: row.Origemdocontato0?.Value (API) - Teams, E-mail, etc.
            let origemContato = row.Origemdocontato0?.Value || row["origemContato"] || row["Origem do contato"] || "Não Informado";
            origemContato = String(origemContato).trim();
            if (!origemContato) origemContato = "Não Informado";

            // CNPJ: row.CNPJ (API - direto)
            let cnpjRawDigits = String(row.CNPJ || row["cnpj"] || "").replace(/[^0-9]/g, "");
            let cnpjFormatted = cnpjRawDigits;

            if (cnpjFormatted.length === 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length === 13) {
                cnpjFormatted = '0' + cnpjFormatted;
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length > 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted.substring(0, 14));
            } else {
                cnpjFormatted = "Não Informado";
                cnpjRawDigits = "";
            }

            // Razão Social: row.Raz_x00e3_oSocial (API - direto) ou Solicitante
            let razaoSocial = row.Raz_x00e3_oSocial || row.Solicitante?.Value || row["razaoSocial"] || row["Razão Social"] || row["solicitante"] || "";
            razaoSocial = String(razaoSocial).trim();
            if (razaoSocial === "") razaoSocial = "Não Informada";

            // GN: row.GN?.Value (API)
            let gn = row.GN?.Value || row["gn"] || row["GN"] || "";
            let gnTratada = tratarGN(gn);

            // Área Responsável: row.Origemdocontato?.Value (API) - NÃO é o canal!
            let areaResponsavelResolucao = row.Origemdocontato?.Value || row["areaResponsavelResolucao"] || row["Área Responsável Resolução"] || "Não Informado";
            areaResponsavelResolucao = String(areaResponsavelResolucao).trim();
            if (!areaResponsavelResolucao) areaResponsavelResolucao = "Não Informado";

            // Analista: row.Analista?.Value (API)
            let analistaValue = row.Analista?.Value || row["analista"] || row["Analista"] || "Não Atribuído";

            // Motivo: row.Motivo?.Value (API)
            let motivoValue = row.Motivo?.Value || row["motivo"] || row["Motivo"] || "Outros";

            // Sub Classificação: row.SubClassifica_x00e7__x00e3_o?.Value (API)
            let subValue = row.SubClassifica_x00e7__x00e3_o?.Value || row["subClassificacao"] || row["Sub Classificação"] || "Geral";

            // Descrição: row.Descri_x00e7__x00e3_o (API - direto)
            let descricaoValue = row.Descri_x00e7__x00e3_o || row["detalhes"] || row["Descrição"] || "";

            return {
                uid: index,
                id: parseInt(row.ID || row.Id || row.id, 10) || null,
                status: statusDisplay,
                statusNorm,
                dtStart: dataInicioObj,
                dtEnd: dataFimObj,
                fcr: fcrValue,
                analista: analistaValue,
                motivo: motivoValue,
                sub: subValue,
                solicitante: razaoSocial,
                descricao: descricaoValue,
                cnpj: cnpjRawDigits || "Não Informado",
                cnpjFormatted: cnpjFormatted,
                tipoContato: tipoContato,
                origemContato: origemContato,
                tempoResolucaoDias,
                tempoResolucaoFormatado,
                gn: gnTratada,
                areaResponsavelResolucao: areaResponsavelResolucao
            };
        });

        RAW = RAW.filter(r => r.dtStart && !isNaN(r.dtStart.getTime()));
        FILTERED = [...RAW];
        BASE_FILTERED_LENGTH = FILTERED.length;

        populateFilters();
        applyAllFilters();

        if (firstLoad) {
            $('datePreset').value = 'currentMonth';
            handleDatePreset();
            firstLoad = false;
        }

        LAST_UPDATE_TIMESTAMP = new Date();

        setTimeout(() => {
            showLoading(false);
            updateLastUpdateTimestamp();
            updateCriticalCasesAlert();
        }, 300);

    } catch (err) {
        console.error('Erro ao processar dados da API:', err);
        showToast('Erro ao processar dados da API. Verifique console.', 'error');
        showLoading(false);
    }
}


// === FUNÇÕES GLOBAIS DE HOVER PARA LEGENDAS DAS ROSCAS ===
window.highlightLegendItem = function(legendId, index) {
    const legendDiv = document.getElementById(legendId);
    if (!legendDiv) return;
    legendDiv.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('legend-item-highlight');
    });
    const items = legendDiv.querySelectorAll('.legend-item');
    if (items[index]) {
        items[index].classList.add('legend-item-highlight');
    }
};

window.unhighlightAllLegendItems = function(legendId) {
    const legendDiv = document.getElementById(legendId);
    if (!legendDiv) return;
    legendDiv.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('legend-item-highlight');
    });
};

window.setupDoughnutHover = function(chartInstance, legendId) {
    const canvas = chartInstance.canvas;

    canvas.addEventListener('mousemove', function(e) {
        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length > 0) {
            const idx = points[0].index;
            canvas.style.cursor = 'pointer';
            window.highlightLegendItem(legendId, idx);
        } else {
            canvas.style.cursor = 'default';
            window.unhighlightAllLegendItems(legendId);
        }
    });

    canvas.addEventListener('mouseleave', function() {
        canvas.style.cursor = 'default';
        window.unhighlightAllLegendItems(legendId);
    });
};

const MOTIVO_PALETTE = [
  '#0045B5', '#FFD100', '#0068FF', '#00ADFF', '#00266E',
  '#FFB206', '#00D9B8', '#939598', '#00C9A7', '#FFA93D',
  '#4CE4C9', '#3D8DFF', '#6CABFF', '#FFE4A1', '#FF9E76'
];

const GN_PALETTE = [
  '#0045B5', '#FFD100', '#0068FF', '#00ADFF', '#00266E',
  '#FFB206', '#00D9B8', '#939598', '#9D4EDD', '#FF7A45',
  '#00C9A7', '#FF4757', '#FFA93D', '#7B2CBF', '#4CE4C9'
];

const BRAND_BLUE = '#3D8DFF';
const BRAND_BLUE_LIGHT = '#6CABFF';
const BRAND_YELLOW = '#FFD166';
const BRAND_ORANGE = '#FF7A45';
const SUCCESS_GREEN = '#00C9A7';
const PURPLE = '#9D4EDD';
const IPIRANGA_BLUE = '#0045B5';
const IPIRANGA_YELLOW = '#FFD100';
const IPIRANGA_ORANGE = '#FF6900';

let RAW = [], FILTERED = [], CURRENT_PAGE = 1, ITEMS_PER_PAGE = 15;

// ===== CONFIGURAÇÃO UNIFICADA DO POWER AUTOMATE =====
const POWER_AUTOMATE_URL = 'https://default72b5f4168f414c88a6a0bb4b913838.88.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/66fec7954df142c696e6789422bd89e4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=40W9DVJqVy2yWCUmW8wwepmq3x0v21lX504tnnyu2xA';

async function enviarParaPowerAutomate(acao, dados, idRegistro) {
    const payload = {
        acao: acao,
        id_registro: idRegistro || null,
        status: dados.status || null,
        dataInicio: dados.dataInicio || null,
        dataFim: dados.dataFim || null,
        analista: dados.analista || null,
        motivo: dados.motivo || null,
        subClassificacao: dados.subClassificacao || null,
        cnpj: dados.cnpj || null,
        razaoSocial: dados.razaoSocial || null,
        tipoAtendimento: dados.tipoAtendimento || null,
        origemContato: dados.origemContato || null,
        gn: dados.gn || null,
        solicitante: dados.solicitante || null,
        areaResponsavelResolucao: dados.areaResponsavelResolucao || null,
        detalhes: dados.detalhes || null
    };
    console.log('Power Automate payload:', JSON.stringify(payload, null, 2));
    const response = await fetch(POWER_AUTOMATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    if (!response.ok) throw new Error('Erro: ' + response.status);
    return response;
}
let LAST_UPDATE_TIMESTAMP = null;

function normalizarMotivo(motivo) {
    if (!motivo) return motivo;
    const motivoStr = motivo.toString().trim();
    if (motivoStr.toUpperCase() === 'REDE') {
        return 'Adquirente Redecard';
    }
    return motivoStr;
}

let CHART_FILTERS = {
    'Table Row': null,
    'Evo Date': null,
    'Status': null,
    'FCR_Sim': null,
    'Date Preset': null,
    'Doughnut Selection': {},
    'Motivo': null,
    'Analista': null,
    'Subclassificação': null,
    'TipoContato': null,
    'AreaResponsavel': null,
    'AvgTime': null,
    'Origem': null,
    'GN': null,
    'CnpjCount': null,
    'TopMotivo': null
};

let CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
let BASE_FILTERED_LENGTH = 0;
let charts = {};
let loadingProgressInterval = null;
let notificationCount = 3;
let firstLoad = true;

let motivoAnalyticsData = null;
let currentMotivoSort = { key: 'total', direction: 'desc' };
let motivoCharts = {};

const $ = id => document.getElementById(id);

function formatCNPJ(cnpj) {
    const digits = cnpj.replace(/\D/g, '');
    if (digits.length !== 14) return cnpj;
    return digits.replace(
        /^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,
        '$1.$2.$3/$4-$5'
    );
}

function getContrastColor(hexColor) {
    let r, g, b;
    if (hexColor.startsWith('rgb')) {
        const rgb = hexColor.match(/\d+/g);
        r = parseInt(rgb[0]);
        g = parseInt(rgb[1]);
        b = parseInt(rgb[2]);
    } else {
        const hex = hexColor.replace('#', '');
        r = parseInt(hex.substr(0, 2), 16);
        g = parseInt(hex.substr(2, 2), 16);
        b = parseInt(hex.substr(4, 2), 16);
    }
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

function tratarGN(gn) {
    if (!gn) return 'Não Informado';
    let gnTratada = gn.toString().trim();
    gnTratada = gnTratada.replace(/G\.N\.\s*Urbano\s*/i, "Urb ");
    gnTratada = gnTratada.replace(/G\.N\.\s*Rodovia\s*/i, "Rod. ");
    gnTratada = gnTratada.replace(/G\.N\.\s*/i, "");
    return gnTratada || gn;
}

// ===== FUNÇÃO PARA CALCULAR TMR COM NOVA LÓGICA =====
function calcularTMRComNovaLogica() {
    const casosConcluidos = FILTERED.filter(item => item.statusNorm === 'Fechado' && item.dtStart && item.dtEnd);
    
    if (casosConcluidos.length === 0) return 0;
    
    let somaDias = 0;
    let casosValidos = 0;
    
    casosConcluidos.forEach(item => {
        const inicio = new Date(item.dtStart);
        const fim = new Date(item.dtEnd);
        
        if (isNaN(inicio.getTime()) || isNaN(fim.getTime())) return;
        
        // Resetar horas para comparar apenas datas
        const inicioDate = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
        const fimDate = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate());
        
        // Calcular diferença em dias
        const diffMs = fimDate.getTime() - inicioDate.getTime();
        const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        // Aplicar nova lógica:
        // - Casos encerrados no mesmo dia: 1 dia
        // - Casos encerrados em dias diferentes: contabilizar os dias
        let diasCalculados;
        if (diffDias === 0) {
            diasCalculados = 1; // Mesmo dia = 1 dia
        } else {
            diasCalculados = diffDias; // Dias diferentes = contabilizar os dias
        }
        
        somaDias += diasCalculados;
        casosValidos++;
    });
    
    return casosValidos > 0 ? (somaDias / casosValidos).toFixed(1) : 0;
}

function showMotivoDetailsPopup(event) { 
    event.stopPropagation();
    
    const motivoTempos = {}; 
    FILTERED.forEach(item => { 
        if (item.statusNorm === 'Fechado' && item.dtStart && item.dtEnd) { 
            const motivo = item.motivo || 'Não informado'; 
            
            // Calcular tempo com nova lógica
            const inicio = new Date(item.dtStart);
            const fim = new Date(item.dtEnd);
            const inicioDate = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
            const fimDate = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate());
            const diffMs = fimDate.getTime() - inicioDate.getTime();
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diasCalculados = diffDias === 0 ? 1 : diffDias;
            
            if (!motivoTempos[motivo]) { 
                motivoTempos[motivo] = { 
                    total: 0, 
                    count: 0, 
                    avg: 0 
                }; 
            } 
            motivoTempos[motivo].total += diasCalculados; 
            motivoTempos[motivo].count++; 
        } 
    }); 
    
    Object.keys(motivoTempos).forEach(motivo => { 
        motivoTempos[motivo].avg = motivoTempos[motivo].total / motivoTempos[motivo].count;
    }); 
    
    let maisRapido = { motivo: '-', tempo: Infinity }; 
    let maisDemorado = { motivo: '-', tempo: -Infinity }; 
    
    const motivosComTempo = Object.entries(motivoTempos); 
    if (motivosComTempo.length > 0) { 
        maisRapido = motivosComTempo.reduce((min, [motivo, data]) => { 
            return data.avg < min.tempo ? { motivo, tempo: data.avg } : min; 
        }, { motivo: '', tempo: Infinity }); 
        
        maisDemorado = motivosComTempo.reduce((max, [motivo, data]) => { 
            return data.avg > max.tempo ? { motivo, tempo: data.avg } : max; 
        }, { motivo: '', tempo: -Infinity }); 
    } 
    
    const motivoCounts = {}; 
    FILTERED.forEach(item => { 
        const motivo = item.motivo || 'Não informado'; 
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1; 
    }); 
    
    let topMotivo = '-'; 
    let topMotivoCount = 0; 
    if (Object.keys(motivoCounts).length > 0) { 
        const entries = Object.entries(motivoCounts); 
        entries.forEach(([motivo, count]) => { 
            if (count > topMotivoCount) { 
                topMotivoCount = count; 
                topMotivo = motivo; 
            } 
        }); 
    } 
    
    $('detailMotivoMaisTratado').innerText = topMotivo; 
    $('detailQuantidade').innerText = topMotivoCount; 
    $('detailMaisRapido').innerText = maisRapido.motivo; 
    $('detailTempoMaisRapido').innerText = maisRapido.tempo !== Infinity ? maisRapido.tempo.toFixed(1) + ' dias' : '-'; 
    $('detailMaisDemorado').innerText = maisDemorado.motivo; 
    $('detailTempoMaisDemorado').innerText = maisDemorado.tempo !== -Infinity ? maisDemorado.tempo.toFixed(1) + ' dias' : '-'; 
    
    const popup = $('motivoDetailsPopup'); 
    popup.classList.add('show'); 
} 

function hideMotivoDetailsPopup() { 
    $('motivoDetailsPopup').classList.remove('show'); 
}

// ===== FUNÇÕES PARA CASOS CRÍTICOS =====
function showCriticalCases() {
    if (RAW.length === 0) {
        showToast('Carregue uma base de dados primeiro', 'warning');
        return;
    }
    
    const hoje = new Date();
    const casosCriticos = FILTERED.filter(item => {
        if (item.statusNorm !== 'Aberto') return false;
        if (!item.dtStart) return false;
        
        const dataInicio = new Date(item.dtStart);
        const diffMs = hoje.getTime() - dataInicio.getTime();
        const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        return diffDias > 3;
    });
    
    const tbody = $('criticalCasesTable');
    tbody.innerHTML = '';
    
    if (casosCriticos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">
                    Nenhum caso crítico encontrado
                </td>
            </tr>
        `;
    } else {
        casosCriticos.sort((a, b) => {
            const diasA = Math.floor((hoje.getTime() - new Date(a.dtStart).getTime()) / (1000 * 60 * 60 * 24));
            const diasB = Math.floor((hoje.getTime() - new Date(b.dtStart).getTime()) / (1000 * 60 * 60 * 24));
            return diasB - diasA;
        }).forEach(item => {
            const diasAberto = Math.floor((hoje.getTime() - new Date(item.dtStart).getTime()) / (1000 * 60 * 60 * 24));
            const dataInicio = moment(item.dtStart).format('DD/MM/YYYY');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${item.analista}</strong></td>
                <td>${normalizarMotivo(item.motivo)}</td>
                <td>${dataInicio}</td>
                <td><span class="status-pill" style="background: var(--error-red);">${diasAberto} dias</span></td>
                <td>${item.solicitante}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    $('criticalCasesPopup').classList.add('show');
}

function hideCriticalCases() {
    $('criticalCasesPopup').classList.remove('show');
}

function updateCriticalCasesAlert() {
    const footerAlert = $('criticalAlertFooter');
    const footerCount = $('criticalAlertCountFooter');

    if (RAW.length === 0) {
        if (footerAlert) footerAlert.style.display = 'none';
        return;
    }

    const hoje = new Date();
    const casosCriticos = FILTERED.filter(item => {
        if (item.statusNorm !== 'Aberto') return false;
        if (!item.dtStart) return false;

        const dataInicio = new Date(item.dtStart);
        const diffMs = hoje.getTime() - dataInicio.getTime();
        const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        return diffDias > 3;
    });

    const count = casosCriticos.length;

    if (count > 0 && footerAlert && footerCount) {
        footerAlert.style.display = 'flex';
        footerCount.innerText = count;
    } else if (footerAlert) {
        footerAlert.style.display = 'none';
    }
}

// ===== FUNÇÃO PARA ATUALIZAR TIMESTAMP =====
function updateLastUpdateTimestamp() {
    if (LAST_UPDATE_TIMESTAMP) {
        const now = new Date();
        const diffMs = now.getTime() - LAST_UPDATE_TIMESTAMP.getTime();
        const diffMins = Math.floor(diffMs / (1000 * 60));
        
        let displayText = '';
        if (diffMins < 1) {
            displayText = 'Agora mesmo';
        } else if (diffMins < 60) {
            displayText = `Há ${diffMins} min`;
        } else {
            const diffHours = Math.floor(diffMins / 60);
            displayText = `Há ${diffHours} h`;
        }
        
        const fullDate = moment(LAST_UPDATE_TIMESTAMP).format('HH:mm DD/MM/YYYY');
        $('lastUpdateTimeFull').innerText = `${displayText} (${fullDate})`;
    } else {
        $('lastUpdateTimeFull').innerText = '--:-- --/--/----';
    }
}

// ===== FUNÇÃO PARA GERAR RELATÓRIO EXECUTIVO MELHORADO =====
function generateExecutiveReport() {
    if (RAW.length === 0) {
        showToast('Carregue uma base de dados primeiro', 'warning');
        return;
    }
    
    showLoading(true, "Gerando relatório executivo...");
    
    // Coletar dados para o relatório
    const total = FILTERED.length;
    const closed = FILTERED.filter(d => d.statusNorm === 'Fechado').length;
    const open = total - closed;
    const fcrCount = FILTERED.filter(d => (d.fcr || '').toUpperCase() === 'SIM').length;
    const fcrPerc = total > 0 ? Math.round((fcrCount / total) * 100) : 0;
    const tmrDias = calcularTMRComNovaLogica();
    
    // CNPJ únicos
    const cnpjSet = new Set();
    FILTERED.forEach(item => {
        if (item.cnpj && item.cnpj.trim() !== '') {
            cnpjSet.add(item.cnpj.trim());
        }
    });
    const cnpjCount = cnpjSet.size;
    
    // Motivo mais tratado
    const motivoCounts = {};
    FILTERED.forEach(item => {
        const motivo = item.motivo || 'Não informado';
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
    });
    let topMotivo = '-';
    let topMotivoCount = 0;
    if (Object.keys(motivoCounts).length > 0) {
        const entries = Object.entries(motivoCounts);
        entries.forEach(([motivo, count]) => {
            if (count > topMotivoCount) {
                topMotivoCount = count;
                topMotivo = motivo;
            }
        });
    }
    
    // Análise por tipo de contato
    const tipoContatoCounts = {};
    FILTERED.forEach(item => {
        const tipo = item.tipoContato || 'Não Informado';
        tipoContatoCounts[tipo] = (tipoContatoCounts[tipo] || 0) + 1;
    });
    
    // Análise por origem
    const origemCounts = {};
    FILTERED.forEach(item => {
        const origem = item.origemContato || 'Não Informado';
        origemCounts[origem] = (origemCounts[origem] || 0) + 1;
    });
    
    // Top 5 analistas
    const analistaCounts = {};
    FILTERED.forEach(d => analistaCounts[d.analista] = (analistaCounts[d.analista]||0)+1);
    const topAnalistas = Object.entries(analistaCounts).sort((a,b)=>b[1]-a[1]).slice(0, 5);
    
    // Criar conteúdo do relatório
    const reportContent = `
        <html>
        <head>
            <style>
                body { font-family: 'Inter', sans-serif; margin: 40px; color: #333; }
                .header { background: linear-gradient(135deg, #0045B5, #0068FF); color: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; }
                .header h1 { margin: 0; font-size: 28px; }
                .header .subtitle { opacity: 0.9; font-size: 14px; }
                .section { margin-bottom: 30px; }
                .section-title { color: #0045B5; border-bottom: 2px solid #FFD100; padding-bottom: 10px; font-size: 20px; margin-bottom: 20px; }
                .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
                .kpi-card { background: white; border: 1px solid #D1D3D4; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
                .kpi-value { font-size: 32px; font-weight: 900; color: #0045B5; margin: 10px 0; }
                .kpi-label { font-size: 14px; color: #58595B; text-transform: uppercase; letter-spacing: 1px; }
                .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .table th { background: #0045B5; color: white; padding: 12px; text-align: left; }
                .table td { padding: 10px; border-bottom: 1px solid #D1D3D4; }
                .highlight { background: #FFF7CC; padding: 20px; border-radius: 10px; border-left: 4px solid #FFD100; margin: 20px 0; }
                .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #D1D3D4; font-size: 12px; color: #939598; text-align: center; }
                .badge { background: #0045B5; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; display: inline-block; }
            
/* WORD CLOUD */
.word-cloud-card { min-height: 500px; }
.word-cloud-container { position: relative; height: 400px; width: 100%; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); overflow: hidden; display: flex; align-items: center; justify-content: center; }
.word-cloud-container canvas { max-width: 100%; max-height: 100%; }
.word-cloud-empty { text-align: center; color: var(--text-muted); padding: 40px; flex-direction: column; }
.word-cloud-empty i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; display: block; }
.word-cloud-empty p { font-size: 14px; max-width: 400px; margin: 0 auto; }
.word-cloud-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); }
.word-stat { text-align: center; padding: 12px; }
.word-stat-value { display: block; font-size: 24px; font-weight: 800; color: var(--brand-blue); font-family: var(--font-secondary); margin-bottom: 4px; }
.word-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
@media (max-width: 900px) { .word-cloud-stats { grid-template-columns: repeat(2,1fr); } .word-cloud-container { height: 300px; } }

</style>
        </head>
        <body>
            <div class="header">
                <h1>Relatório Executivo | Consolida Torre</h1>
                <div class="subtitle">Período: ${$('dateStart').value ? moment($('dateStart').value).format('DD/MM/YYYY') : 'Início'} a ${$('dateEnd').value ? moment($('dateEnd').value).format('DD/MM/YYYY') : 'Fim'} | Gerado em: ${moment().format('DD/MM/YYYY HH:mm')}</div>
            </div>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">${total}</div>
                    <div class="kpi-label">Total de Registros</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${open}</div>
                    <div class="kpi-label">Em Aberto</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${closed}</div>
                    <div class="kpi-label">Concluídos</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${fcrPerc}%</div>
                    <div class="kpi-label">FCR</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${tmrDias}d</div>
                    <div class="kpi-label">Tempo Médio</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${cnpjCount}</div>
                    <div class="kpi-label">CNPJ Únicos</div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Análise por Categoria</h2>
                
                <div class="highlight">
                    <h3 style="margin-top: 0; color: #0045B5;">🔍 Motivo Mais Tratado</h3>
                    <p><strong>${topMotivo}</strong> com ${topMotivoCount} ocorrências (${total > 0 ? Math.round((topMotivoCount/total)*100) : 0}% do total)</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3>Tipo de Contato</h3>
                        <table class="table">
                            ${Object.entries(tipoContatoCounts).map(([tipo, count]) => `
                                <tr>
                                    <td>${tipo}</td>
                                    <td><strong>${count}</strong></td>
                                    <td>${total > 0 ? Math.round((count/total)*100) : 0}%</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    <div>
                        <h3>Origem do Contato</h3>
                        <table class="table">
                            ${Object.entries(origemCounts).slice(0, 5).map(([origem, count]) => `
                                <tr>
                                    <td>${origem}</td>
                                    <td><strong>${count}</strong></td>
                                    <td>${total > 0 ? Math.round((count/total)*100) : 0}%</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">🏆 Top 5 Analistas</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Analista</th>
                            <th>Atendimentos</th>
                            <th>% do Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topAnalistas.map(([analista, count], index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td><strong>${analista}</strong></td>
                                <td>${count}</td>
                                <td>${total > 0 ? Math.round((count/total)*100) : 0}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            ${casosCriticos && casosCriticos.length > 0 ? `
            <div class="section">
                <h2 class="section-title" style="color: #F04C25;">⚠️ Atenção: Casos Críticos</h2>
                <div class="highlight" style="background: #FFE6DB; border-left-color: #F04C25;">
                    <p><strong>${casosCriticos.length} casos em aberto há mais de 3 dias</strong> requerem atenção imediata.</p>
                    <p>Recomenda-se priorizar a resolução destes casos.</p>
                </div>
            </div>
            ` : ''}
            
            <div class="footer">
                <p>Relatório gerado automaticamente pelo Dashboard Consolida Torre</p>
                <p>Desenvolvido por Thiago Jr • Última atualização: ${LAST_UPDATE_TIMESTAMP ? moment(LAST_UPDATE_TIMESTAMP).format('DD/MM/YYYY HH:mm') : '--/--/---- --:--'}</p>
            </div>
        
<div id="crudModal">
    <div id="crudBox">
        <div id="crudHead"><h3 id="crudTitle">Modal</h3><button onclick="window.fecharCrud()">✕</button></div>
        <div id="crudBody"></div>
        <div id="crudFoot"></div>
    </div>
</div>
</body>
        </html>
    `;
    
    // Criar nova janela para o relatório
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportContent);
    reportWindow.document.close();
    
    // Dar foco na janela
    setTimeout(() => {
        reportWindow.focus();
        showLoading(false);
        showToast('Relatório executivo gerado com sucesso!', 'success');
    }, 500);
}

// ===== EFEITOS ESPECIAIS NOS CARDS DO GRID =====
function setupCardHoverEffects() {
    document.querySelectorAll('.kpi-card').forEach(card => {
        card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            card.style.setProperty('--mouse-x', `${x}%`);
            card.style.setProperty('--mouse-y', `${y}%`);
        });
    });
}

// ===== FUNÇÃO PARA ALTERNAR TEMA =====
function toggleTheme() {
    const isLight = document.body.classList.toggle('light-theme');
    localStorage.setItem('dashboard-theme', isLight ? 'light' : 'dark');
    
    // Atualizar ícone do botão
    const themeBtn = document.querySelector('[onclick="toggleTheme()"]');
    if (themeBtn) {
        const icon = themeBtn.querySelector('i');
        if (icon) {
            icon.className = isLight ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
    }
    
    showToast(`Tema ${isLight ? 'claro' : 'escuro'} ativado`, 'info');
}

// ===== FUNÇÃO PARA TELA CHEIA =====
function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.log(`Erro ao tentar entrar em tela cheia: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

// ===== FUNÇÃO PARA EXPORTAR CSV =====
function exportCSV() {
    if (FILTERED.length === 0) {
        showToast('Nenhum dado para exportar', 'warning');
        return;
    }
    
    const headers = ['Status', 'Data Início', 'Data Fim', 'Tempo Resolução', 'FCR', 'Analista', 'Motivo', 'Sub Classificação', 'Razão Social', 'Tipo Atendimento', 'Origem Contato'];
    
    const csvData = FILTERED.map(item => [
        item.statusNorm === 'Fechado' ? 'Concluído' : 'Em Aberto',
        item.dtStart ? moment(item.dtStart).format('DD/MM/YYYY') : '',
        item.dtEnd ? moment(item.dtEnd).format('DD/MM/YYYY') : '',
        item.tempoResolucaoFormatado,
        item.fcr,
        item.analista,
        normalizarMotivo(item.motivo),
        item.sub,
        item.solicitante,
        item.tipoContato,
        item.origemContato
    ]);
    
    const csvContent = [
        headers.join(';'),
        ...csvData.map(row => row.join(';'))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `consolida_torre_${moment().format('YYYYMMDD_HHmmss')}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV exportado com sucesso!', 'success');
}

// ===== INICIALIZAÇÃO =====
window.onload = function() {
    document.querySelectorAll('.btn').forEach(button => button.addEventListener('click', addRippleEffect));
    if (localStorage.getItem('dashboard-theme') === 'light') document.body.classList.add('light-theme');
    updateLastUpdateTimestamp();
    setupListeners();
    setupCardHoverEffects();
    
    // Atualizar timestamp a cada minuto
    setInterval(updateLastUpdateTimestamp, 60000);
    
    // Carregar dados da API automaticamente
    setTimeout(() => {
        chamarApi();
    }, 500);
};

function setupListeners() {
    $('applyBtn').addEventListener('click', applyAllFilters);
    $('clearBtn').addEventListener('click', clearAllFilters);
    $('qSearch').addEventListener('input', () => { CURRENT_PAGE=1; applyAllFilters(); });
    $('motivoSelect').addEventListener('change', applyAllFilters);
    $('analistaSelect').addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'OPTION') {
            e.preventDefault();
            const option = e.target;
            option.selected = !option.selected;
            const selectedOptions = Array.from(this.selectedOptions);
            $('analistaSelectAll').checked = selectedOptions.length === 0;
            applyAllFilters();
        }
    });
    $('analistaSelect').addEventListener('change', function() {
        const selectedOptions = Array.from(this.selectedOptions);
        $('analistaSelectAll').checked = selectedOptions.length === 0;
        applyAllFilters();
    });
    $('analistaSelectAll').addEventListener('change', function() {
        const sel = $('analistaSelect');
        if (this.checked) {
            Array.from(sel.options).forEach(o => o.selected = false);
        }
        applyAllFilters();
    });
    $('subSelect').addEventListener('change', applyAllFilters);
    $('tipoContatoSelect').addEventListener('change', applyAllFilters);
    $('areaResponsavelSelect').addEventListener('change', applyAllFilters);
    $('datePreset').addEventListener('change', handleDatePreset);
    $('dateStart').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
    $('dateEnd').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
    $('prevPage').addEventListener('click', () => changePage(-1));
    $('nextPage').addEventListener('click', () => changePage(1));
    $('kpiTotal').addEventListener('click', () => filterByKPI('Total'));
    $('kpiOpen').addEventListener('click', () => filterByKPI('Aberto'));
    $('kpiClosed').addEventListener('click', () => filterByKPI('Fechado'));
    $('kpiFCR').addEventListener('click', () => filterByKPI('FCR'));
    $('kpiAvgTime').addEventListener('click', () => filterByKPI('AvgTime'));
    $('kpiCnpjCount').addEventListener('click', () => filterByKPI('CnpjCount'));
    $('kpiTopMotivo').addEventListener('click', () => filterByKPI('TopMotivo'));
    
    document.addEventListener('click', function(e) {
        if (e.target.matches('#dataTable th[data-key]') || e.target.closest('#dataTable th[data-key]')) {
            const th = e.target.closest('#dataTable th[data-key]');
            const key = th.getAttribute('data-key');
            sortTable(key);
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'f' || e.key === 'F') {
            if (!e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                $('qSearch').focus();
                $('qSearch').select();
                showToast('Campo de busca ativado. Digite para filtrar.', 'info');
            }
        }
        if (e.key === 'Escape') {
            hideDevelopmentPopup();
            hideAutomationModal();
            hideMotivoDetailsPopup();
            hideCriticalCases();
            const notificationPopup = $('notificationPopup');
            if (notificationPopup.classList.contains('show')) {
                toggleNotifications();
            }
        }
    });
    
    document.addEventListener('click', (e) => {
        const notificationPopup = $('notificationPopup');
        const developmentPopup = $('developmentPopup');
        const automationPopup = $('automationPopup');
        const motivoDetailsPopup = $('motivoDetailsPopup');
        const criticalCasesPopup = $('criticalCasesPopup');
        
        if (notificationPopup.classList.contains('show') &&
            !notificationPopup.contains(e.target) &&
            !e.target.closest('.btn-purple.btn-icon')) {
            toggleNotifications();
        }
        
        if (developmentPopup.classList.contains('show') &&
            !developmentPopup.contains(e.target) &&
            !e.target.closest('.btn-ghost.btn-icon')) {
            hideDevelopmentPopup();
        }
        
        if (automationPopup.classList.contains('show') &&
            !automationPopup.contains(e.target) &&
            !e.target.closest('.btn-automation')) {
            hideAutomationModal();
        }
        
        if (motivoDetailsPopup && motivoDetailsPopup.classList.contains('show') &&
            !motivoDetailsPopup.contains(e.target) &&
            !e.target.closest('.motivo-info-icon')) {
            hideMotivoDetailsPopup();
        }
        
        if (criticalCasesPopup && criticalCasesPopup.classList.contains('show') &&
            !criticalCasesPopup.contains(e.target) &&
            !e.target.closest('.critical-alert') &&
            !e.target.closest('.critical-cases-alert')) {
            hideCriticalCases();
        }
    });
    
    const motivoSearch = $('motivoSearch');
    if (motivoSearch) {
        motivoSearch.addEventListener('input', () => {
            if (motivoAnalyticsData) {
                renderMotivoTable();
            }
        });
    }
    
    let lastZoom = 100;
    window.addEventListener('resize', function() {
        const zoom = Math.round((window.outerWidth / window.innerWidth) * 100);
        if (Math.abs(zoom - lastZoom) > 5) {
            lastZoom = zoom;
            adjustZoomStyles(zoom);
        }
    });
}

function adjustZoomStyles(zoomLevel) {
    const fontSize = Math.max(10, 12 * (zoomLevel / 100));
    document.documentElement.style.setProperty('--zoom-factor', zoomLevel / 100);
    
    document.querySelectorAll('.legend-container').forEach(legend => {
        legend.style.fontSize = `${Math.max(0.7, 0.9 * (zoomLevel / 100))}em`;
    });
    
    document.querySelectorAll('.kpi-val').forEach(kpi => {
        kpi.style.fontSize = `clamp(16px, ${2.5 * (zoomLevel / 100)}vw, 28px)`;
    });
}

function toggleNotifications() {
    const popup = $('notificationPopup');
    popup.classList.toggle('show');
    if (popup.classList.contains('show')) {
        updateNotificationBadge(0);
    }
}

function showDevelopmentPopup() {
    $('developmentPopup').classList.add('show');
}

function hideDevelopmentPopup() {
    $('developmentPopup').classList.remove('show');
}

function showAutomationModal() {
    if (RAW.length === 0) {
        showToast('Carregue uma base de dados primeiro', 'warning');
        return;
    }
    
    const popup = $('automationPopup');
    popup.classList.add('show');
    
    loadMotivoAnalytics();
    
    setTimeout(() => {
        popup.focus();
    }, 100);
    document.addEventListener('keydown', handleAutomationKeydown);
}

function hideAutomationModal() {
    const popup = $('automationPopup');
    popup.classList.remove('show');
    document.removeEventListener('keydown', handleAutomationKeydown);
    const automationBtn = document.querySelector('.btn-automation');
    if (automationBtn) automationBtn.focus();
}

function handleAutomationKeydown(e) {
    if (e.key === 'Escape') {
        hideAutomationModal();
    }
}

function clearAllNotifications() {
    const notificationContent = $('notificationPopup').querySelector('.notification-content');
    const emptyState = notificationContent.querySelector('.notification-empty');
    const notificationItems = notificationContent.querySelectorAll('.notification-item');
    
    if (notificationItems.length > 0) {
        notificationItems.forEach(item => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => item.remove(), 300);
        });
        
        if (emptyState) {
            emptyState.style.display = 'block';
        }
        
        updateNotificationBadge(0);
        showToast('Todas as notificações foram limpas', 'success');
    }
}

function markAllAsRead() {
    const notificationItems = $('notificationPopup').querySelectorAll('.notification-item');
    
    notificationItems.forEach(item => {
        item.style.opacity = '0.7';
        item.style.borderLeftColor = 'var(--border-primary)';
        const title = item.querySelector('.notification-item-title');
        if (title) {
            title.style.color = 'var(--text-secondary)';
        }
    });
    
    updateNotificationBadge(0);
    showToast('Todas as notificações marcadas como lidas', 'success');
}

function updateNotificationBadge(count) {
    return;
}

// ===== FUNÇÕES PARA CARREGAMENTO LOCAL =====
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        showLoading(true, "Processando arquivo Excel...");
        startLoadingProgress();
        
        try {
            const data = new Uint8Array(e.target.result);
            processExcelData(data);
            
            // Salvar no localStorage
            saveDataToLocalStorage(data);
            
            // Atualizar timestamp
            LAST_UPDATE_TIMESTAMP = new Date();
            updateLastUpdateTimestamp();
            
            showToast('Base de dados carregada com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao processar arquivo:', error);
            showToast(`Erro ao processar arquivo: ${error.message}`, 'error');
        } finally {
            showLoading(false);
        }
    };
    
    reader.onerror = function() {
        showToast('Erro ao ler o arquivo', 'error');
        showLoading(false);
    };
    
    reader.readAsArrayBuffer(file);
}

function loadLocalData() {
    const savedData = localStorage.getItem('hubData');
    const savedMetadata = localStorage.getItem('hubMetadata');
    
    if (!savedData) {
        showToast('Nenhum dado salvo encontrado. Carregue uma base primeiro.', 'warning');
        $('dataSourceStatus').textContent = 'Nenhuma Base Carregada';
        $('lastLoadInfo').textContent = 'Clique em "Carregar Nova Base" para começar';
        $('contextSummary').innerHTML = 'Carregue uma base de dados para começar...';
        $('dataLoadedInfo').textContent = 'Nenhuma base carregada';
        return;
    }
    
    showLoading(true, "Carregando dados salvos...");
    startLoadingProgress();
    
    try {
        // Converter a string base64 de volta para Uint8Array
        const binaryString = atob(savedData);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        
        processExcelData(bytes);
        
        // Atualizar informações de carregamento
        if (savedMetadata) {
            const metadata = JSON.parse(savedMetadata);
            $('lastLoadInfo').textContent = `Última carga: ${metadata.lastLoadDate}`;
            $('dataLoadedInfo').textContent = `${metadata.lastLoadDate} (${RAW.length} registros)`;
            
            // Tentar extrair timestamp da string de data
            try {
                const dateStr = metadata.lastLoadDate;
                if (dateStr) {
                    LAST_UPDATE_TIMESTAMP = new Date(dateStr);
                    if (isNaN(LAST_UPDATE_TIMESTAMP.getTime())) {
                        LAST_UPDATE_TIMESTAMP = new Date();
                    }
                } else {
                    LAST_UPDATE_TIMESTAMP = new Date();
                }
            } catch (e) {
                LAST_UPDATE_TIMESTAMP = new Date();
            }
        } else {
            LAST_UPDATE_TIMESTAMP = new Date();
        }
        
        updateLastUpdateTimestamp();
        
        showToast('Dados carregados do armazenamento local!', 'success');
    } catch (error) {
        console.error('Erro ao carregar dados salvos:', error);
        showToast(`Erro ao carregar dados: ${error.message}`, 'error');
        showLoading(false);
    }
}

function saveDataToLocalStorage(data) {
    try {
        // Converter Uint8Array para base64 para armazenar no localStorage
        let binary = '';
        const bytes = new Uint8Array(data);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        const base64Data = btoa(binary);
        
        // Salvar dados
        localStorage.setItem('hubData', base64Data);
        
        // Salvar metadados
        const metadata = {
            lastLoadDate: new Date().toLocaleString('pt-BR'),
            recordCount: RAW.length
        };
        localStorage.setItem('hubMetadata', JSON.stringify(metadata));
        
        // Atualizar interface
        $('dataSourceStatus').textContent = 'Base Local Carregada';
        $('lastLoadInfo').textContent = `Última carga: ${metadata.lastLoadDate}`;
        $('dataLoadedInfo').textContent = `${metadata.lastLoadDate} (${RAW.length} registros)`;
        
        console.log('Dados salvos no localStorage com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar dados no localStorage:', error);
        showToast('Erro ao salvar dados localmente', 'error');
    }
}

function clearLocalData() {
    if (confirm('Tem certeza que deseja apagar todos os dados salvos localmente?')) {
        localStorage.removeItem('hubData');
        localStorage.removeItem('hubMetadata');
        RAW = [];
        FILTERED = [];
        LAST_UPDATE_TIMESTAMP = null;
        applyAllFilters();
        updateLastUpdateTimestamp();
        showToast('Dados locais apagados com sucesso!', 'success');
        
        // Resetar interface
        $('dataSourceStatus').textContent = 'Nenhuma Base Carregada';
        $('lastLoadInfo').textContent = 'Clique em "Carregar Nova Base" para começar';
        $('contextSummary').innerHTML = 'Carregue uma base de dados para começar...';
        $('dataLoadedInfo').textContent = 'Nenhuma base carregada';
    }
}

function startLoadingProgress() {
    clearInterval(loadingProgressInterval);
    let progress = 0;
    loadingProgressInterval = setInterval(() => {
        progress += Math.random() * 10 + 5;
        if (progress > 90) {
            progress = 90;
        }
        $('loadingProgress').style.width = progress + '%';
    }, 200);
}

function completeLoadingProgress() {
    clearInterval(loadingProgressInterval);
    $('loadingProgress').style.width = '100%';
}

function resetLoadingProgress() {
    clearInterval(loadingProgressInterval);
    $('loadingProgress').style.width = '0%';
}

function processExcelData(arrayBuffer) {
    try {
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });
        
        const excelDateToJS = (n) => {
            const date = new Date((n - 25568) * 86400 * 1000);
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        };
        
        RAW = json.map((row, index) => {
            // 1. Tratamento das Datas (Usando sua lógica ou a função parseDate se preferir)
            let dataInicioRaw = row["Data Inicio"] || row["dataInício"]; // Tenta ambos os nomes de campo
            let dataInicioObj = null;
            if(typeof dataInicioRaw === 'number') dataInicioObj = excelDateToJS(dataInicioRaw);
            else if(dataInicioRaw) dataInicioObj = parseDate(dataInicioRaw); // Recomendado usar o parseDate que criamos
            
            let dataFimRaw = row["Data Fim"] || row["dataFim"];
            let dataFimObj = null;
            if(typeof dataFimRaw === 'number') dataFimObj = excelDateToJS(dataFimRaw);
            else if(dataFimRaw) dataFimObj = parseDate(dataFimRaw);
            
            // 2. Lógica de Status
            let statusNorm = "Aberto";
            if (dataFimObj && !isNaN(dataFimObj.getTime())) statusNorm = "Fechado";
            let statusDisplay = row["status"] || row["Status de liberação"] || statusNorm;
            
            // 3. Padronização do FCR
            let fcrValue = row["fcr"] || row["FCR"] || "Não";
            if (typeof fcrValue === 'string') {
                fcrValue = fcrValue.trim().toUpperCase();
                if (fcrValue === 'SIM') fcrValue = 'Sim';
                if (fcrValue === 'NÃO' || fcrValue === 'NAO') fcrValue = 'Não';
            }
        
            // 4. RETORNO DO OBJETO (Aqui incluímos o ID para a tabela e para as ações)
            return {
                uid: index,                             // ID interno do JavaScript (usado para o array)
                id: row.ID || row.Id || row.id || "",   // ID REAL do SharePoint (usado para Editar/Excluir)
                dtStart: dataInicioObj,
                dtEnd: dataFimObj,
                status: statusDisplay,
                statusNorm: statusNorm,
                analista: row["analista"] || row["Analista"] || "",
                motivo: row["motivo"] || row["Motivo"] || "",
                sub: row["subClassificacao"] || row["Sub Classificação"] || "",
                cnpj: row["cnpj"] || row["CNPJ"] || "",
                razaoSocial: row["razaoSocial"] || row["Razão Social"] || "",
                tipoContato: row["tipoAtendimento"] || row["Tipo de contato"] || "",
                origemContato: row["origemContato"] || row["Origem do contato"] || "",
                gn: row["gn"] || row["GN"] || "",
                solicitante: row["solicitante"] || row["Solicitante"] || "",
                fcr: fcrValue,
                descricao: row["detalhes"] || row["Descrição"] || "",
                areaResponsavelResolucao: row["areaResponsavelResolucao"] || row["Área Responsável Resolução"] || ""
            };
            // Calcular tempo de resolução com nova lógica
            let tempoResolucaoFormatado = "-";
            let tempoResolucaoDias = null;
            if (dataInicioObj && dataFimObj && !isNaN(dataInicioObj.getTime()) && !isNaN(dataFimObj.getTime()) && statusNorm === "Fechado" && dataFimObj >= dataInicioObj) {
                const inicioDate = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), dataInicioObj.getDate());
                const fimDate = new Date(dataFimObj.getFullYear(), dataFimObj.getMonth(), dataFimObj.getDate());
                const diffMs = fimDate.getTime() - inicioDate.getTime();
                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDias === 0) {
                    tempoResolucaoDias = 1; // Mesmo dia = 1 dia
                    tempoResolucaoFormatado = "1 dia";
                } else {
                    tempoResolucaoDias = diffDias; // Dias diferentes = contabilizar os dias
                    tempoResolucaoFormatado = `${diffDias} dias`;
                }
            }
            
            let tipoContato = String(row["Tipo de contato"] || "").trim();
            if (!tipoContato || tipoContato === "") tipoContato = "Não Informado";
            if (tipoContato.toLowerCase().includes("ativo")) tipoContato = "Ativo";
            if (tipoContato.toLowerCase().includes("receptivo")) tipoContato = "Receptivo";
            
            let origemContato = row["Origem do contato"] || "Não Informado";
            origemContato = origemContato.toString().trim();
            
            let cnpjRawDigits = String(row["CNPJ"] || "").replace(/[^0-9]/g, "");
            let cnpjFormatted = cnpjRawDigits;
            
            if (cnpjFormatted.length === 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length === 13) {
                cnpjFormatted = '0' + cnpjFormatted;
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length > 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted.substring(0, 14));
            } else {
                cnpjFormatted = "Não Informado";
                cnpjRawDigits = "";
            }
            
            let razaoSocial = String(row["Razão Social"] || "").trim();
            if (razaoSocial === "") razaoSocial = "Não Informada";
            
            let gn = row["GN"] || "";
            let gnTratada = tratarGN(gn);
            
            return {
                uid: index,
                id: parseInt(row.ID || row.Id || row.id, 10) || null,
                status: statusDisplay,
                statusNorm,
                dtStart: dataInicioObj,
                dtEnd: dataFimObj,
                fcr: fcrValue,
                analista: row["Analista"] || "Não Atribuído",
                motivo: row["Motivo"] || "Outros",
                sub: row["Sub Classificação"] || "Geral",
                solicitante: razaoSocial,
                descricao: row["Descrição"] || "",
                cnpj: cnpjRawDigits || "Não Informado",
                cnpjFormatted: cnpjFormatted,
                tipoContato: tipoContato,
                origemContato: origemContato,
                tempoResolucaoDias,
                tempoResolucaoFormatado,
                gn: gnTratada,
                areaResponsavelResolucao: row["Área Responsável Resolução"] || row["areaResponsavelResolucao"] || "Não Informado"
            };
        });
        
        RAW = RAW.filter(r => r.dtStart && !isNaN(r.dtStart.getTime()));
        FILTERED = [...RAW];
        BASE_FILTERED_LENGTH = FILTERED.length;
        
        populateFilters();
        applyAllFilters();
        
        if (firstLoad) {
            $('datePreset').value = 'currentMonth';
            handleDatePreset();
            firstLoad = false;
        }
        
        // Atualizar timestamp
        LAST_UPDATE_TIMESTAMP = new Date();
        
        setTimeout(() => {
            showLoading(false);
            updateLastUpdateTimestamp();
            updateCriticalCasesAlert();
        }, 300);
        
    } catch (err) {
        console.error('Erro processamento:', err);
        showToast('Erro ao ler planilha. Verifique console.', 'error');
        showLoading(false);
    }
}

function populateFilters() {
    const unique = (key) => [...new Set(RAW.map(item => item[key]))]
        .filter(x => (typeof x === 'string' ? x.trim() !== '' : x != null))
        .sort();
    
    const fillSelect = (id, list, defaultText) => {
        const sel = $(id);
        sel.innerHTML = `<option value="">${defaultText}</option>`;
        list.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.innerText = val.length > 40 ? val.substring(0, 40) + '...' : val;
            opt.title = val;
            sel.appendChild(opt);
        });
    };
    
    fillSelect('motivoSelect', unique('motivo'), 'Todos Motivos');
    // Multi-select para analistas - LISTA FIXA
    const analistaSel = $('analistaSelect');
    analistaSel.innerHTML = '';
    ['André', 'Fabiana', 'Larissa', 'Ricardo', 'Roberta', 'Thiago'].forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.innerText = val;
        analistaSel.appendChild(opt);
    });
    $('analistaSelectAll').checked = true;
    fillSelect('subSelect', unique('sub'), 'Todas Subclasses');
    fillSelect('tipoContatoSelect', unique('tipoContato'), 'Todos Tipos');
    fillSelect('areaResponsavelSelect', unique('areaResponsavelResolucao'), 'Todas Áreas');
}

function applyAllFilters() {
    if (RAW.length === 0) {
        $('contextSummary').innerHTML = 'Carregue uma base de dados para começar...';
        return;
    }
    
    const q = $('qSearch').value.toLowerCase();
    const fMotivo = $('motivoSelect').value;
    const fAnalista = Array.from($('analistaSelect').selectedOptions).map(o => o.value);
    const fSub = $('subSelect').value;
    const fTipoContato = $('tipoContatoSelect').value;
    const fAreaResponsavel = $('areaResponsavelSelect').value;
    const fOrigem = CHART_FILTERS['Origem'];
    const fGN = CHART_FILTERS['GN'];
    const fCnpjCount = CHART_FILTERS['CnpjCount'];
    const fTopMotivo = CHART_FILTERS['TopMotivo'];
    
    let dStart = $('dateStart').value ? new Date($('dateStart').value) : null;
    let dEnd = $('dateEnd').value ? new Date($('dateEnd').value) : null;
    
    if (CHART_FILTERS['Evo Date']) {
        const filterDate = new Date(CHART_FILTERS['Evo Date']);
        dStart = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 0, 0, 0);
        dEnd = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 23, 59, 59);
    } else if (dEnd) {
        dEnd.setHours(23,59,59);
    }
    
    FILTERED = RAW.filter(item => {
        const textMatch = !q ||
            (item.analista && item.analista.toLowerCase().includes(q)) ||
            (item.solicitante && item.solicitante.toLowerCase().includes(q)) ||
            (item.motivo && item.motivo.toLowerCase().includes(q)) ||
            (item.cnpj && item.cnpj.toString().includes(q)) ||
            (item.cnpjFormatted && item.cnpjFormatted.toLowerCase().includes(q)) ||
            (item.gn && item.gn.toLowerCase().includes(q)) ||
            (item.areaResponsavelResolucao && item.areaResponsavelResolucao.toLowerCase().includes(q));
        
        const motivoMatch = !fMotivo || item.motivo === fMotivo;
        const analistaMatch = fAnalista.length === 0 || fAnalista.includes(item.analista);
        const subMatch = !fSub || item.sub === fSub;
        const tipoContatoMatch = !fTipoContato || item.tipoContato === fTipoContato;
        const areaResponsavelMatch = !fAreaResponsavel || item.areaResponsavelResolucao === fAreaResponsavel;
        const origemMatch = !fOrigem || item.origemContato === fOrigem;
        const gnMatch = !fGN || item.gn === fGN;
        const cnpjCountMatch = !fCnpjCount || (item.cnpj && item.cnpj.trim() !== '');
        const topMotivoMatch = !fTopMotivo || item.motivo === fTopMotivo;
        
        let dateMatch = true;
        if (dStart || dEnd) {
            const itemDate = item.dtStart;
            if (!itemDate) dateMatch = false;
            else {
                if (dStart && itemDate < dStart) dateMatch = false;
                if (dateMatch && dEnd && itemDate > dEnd) dateMatch = false;
            }
        }
        
        const kpiStatusMatch = !CHART_FILTERS['Status'] ||
            (CHART_FILTERS['Status'] === 'Fechado' ? item.statusNorm === 'Fechado' : item.statusNorm === 'Aberto');
        
        const kpiFcrMatch = !CHART_FILTERS['FCR_Sim'] || item.fcr === 'Sim';
        
        const kpiAvgTimeMatch = !CHART_FILTERS['AvgTime'] || (item.statusNorm === 'Fechado' && item.tempoResolucaoDias !== null);
        
        const chartAnalistaMatch = !CHART_FILTERS['Doughnut Selection']['Analista'] || item.analista === CHART_FILTERS['Doughnut Selection']['Analista'];
        
        return textMatch && motivoMatch && analistaMatch && subMatch && tipoContatoMatch && areaResponsavelMatch && origemMatch && dateMatch &&
            kpiStatusMatch && kpiFcrMatch && kpiAvgTimeMatch && chartAnalistaMatch && gnMatch && cnpjCountMatch && topMotivoMatch;
    });
    
    renderKPIs();
    renderCharts();
        generateWordCloud();
    renderTable();
    updateActiveFiltersDisplay();
    generateGamification();
    updateCriticalCasesAlert();
}

function renderKPIs() {
    if (RAW.length === 0) {
        $('kTotal').innerText = '0';
        $('kOpen').innerText = '0';
        $('kClosed').innerText = '0';
        $('kFCR').innerText = '0%';
        $('kAvgTime').innerText = '0d';
        $('kCnpjCount').innerText = '0';
        $('kTopMotivo').innerHTML = '<span title="">-</span> <span style="font-size:16px; color:var(--color-azul)">(0)</span>';
        $('headerTotal').innerText = '0';
        $('headerOpen').innerText = '0';
        $('headerClosed').innerText = '0';
        return;
    }
    
    const total = FILTERED.length;
    const closed = FILTERED.filter(d => d.statusNorm === 'Fechado').length;
    const open = total - closed;
    
    const fcrCount = FILTERED.filter(d => (d.fcr || '').toUpperCase() === 'SIM').length;
    const fcrPerc = total > 0 ? Math.round((fcrCount / total) * 100) : 0;
    
    // Calcular TMR com nova lógica
    const tmrDias = calcularTMRComNovaLogica();
    const avgTimeDisplay = tmrDias > 0 ? `${tmrDias}d` : "0d";
    
    // CNPJ únicos
    const cnpjSet = new Set();
    FILTERED.forEach(item => {
        if (item.cnpj && item.cnpj.trim() !== '') {
            cnpjSet.add(item.cnpj.trim());
        }
    });
    const cnpjCount = cnpjSet.size;
    
    // Motivo mais tratado
    const motivoCounts = {};
    FILTERED.forEach(item => {
        const motivo = item.motivo || 'Não informado';
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
    });
    let topMotivo = '-';
    let topMotivoCount = 0;
    if (Object.keys(motivoCounts).length > 0) {
        const entries = Object.entries(motivoCounts);
        entries.forEach(([motivo, count]) => {
            if (count > topMotivoCount) {
                topMotivoCount = count;
                topMotivo = motivo;
            }
        });
    }
    
    const topMotivoDisplay = topMotivo.length > 20 ? topMotivo.substring(0, 20) + '...' : topMotivo;
    
    // Atualizar KPIs
    $('kTotal').innerText = total;
    $('kOpen').innerText = open;
    $('kClosed').innerText = closed;
    $('kFCR').innerText = fcrPerc + '%';
    $('kAvgTime').innerText = avgTimeDisplay;
    $('kCnpjCount').innerText = cnpjCount;

    // Atualizar percentuais/trends dos KPIs
    updateKPITrends(total, open, closed, fcrPerc, cnpjCount, topMotivoCount, parseFloat(tmrDias));
    
    // Atualizar motivo mais tratado com tooltip
    const kTopMotivoElement = $('kTopMotivo');
    kTopMotivoElement.innerHTML = `<span title="${topMotivo}">${topMotivoDisplay}</span> <span style="font-size:16px; color:var(--color-azul)">(${topMotivoCount})</span>`;
    kTopMotivoElement.setAttribute('title', topMotivo);
    
    $('headerTotal').innerText = total;
    $('headerOpen').innerText = open;
    $('headerClosed').innerText = closed;
    
    $('contextSummary').innerHTML = `Exibindo <span>${total}</span> registros filtrados de <span>${RAW.length}</span> totais.`;
    
    $('kTotalHelper').innerText = (CHART_FILTERS['Status'] || CHART_FILTERS['FCR_Sim'] || CHART_FILTERS['AvgTime']) ?
        'Clique para limpar todos os filtros' : 'Clique para limpar todos os filtros';
    
    $('kOpenHelper').innerText = CHART_FILTERS['Status'] === 'Aberto' ?
        'Clique para remover filtro "Em Aberto"' : 'Clique para filtrar por status "Em Aberto"';
    
    $('kClosedHelper').innerText = (CHART_FILTERS['Status'] === 'Fechado' && !CHART_FILTERS['FCR_Sim'] && !CHART_FILTERS['AvgTime']) ?
        'Clique para remover filtro "Concluído"' : 'Clique para filtrar por status "Concluído"';
    
    $('kFCRHelper').innerText = CHART_FILTERS['FCR_Sim'] === 'Sim' ?
        'Clique para remover filtro FCR' : 'Clique para filtrar por FCR = Sim';
    
    $('kAvgTimeHelper').innerText = CHART_FILTERS['AvgTime'] ?
        'Clique para remover filtro Tempo Médio' : 'Baseado apenas nos casos concluídos';
    
    // Atualizar classes dos cards ativos
    ['kpiTotal', 'kpiOpen', 'kpiClosed', 'kpiFCR', 'kpiAvgTime', 'kpiCnpjCount', 'kpiTopMotivo'].forEach(id => $(id).classList.remove('active-filter'));
    
    if (CHART_FILTERS['Status'] === 'Aberto') $('kpiOpen').classList.add('active-filter');
    else if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) $('kpiClosed').classList.add('active-filter');
    else if (CHART_FILTERS['FCR_Sim'] === 'Sim') $('kpiFCR').classList.add('active-filter');
    else if (CHART_FILTERS['AvgTime']) $('kpiAvgTime').classList.add('active-filter');
    if (CHART_FILTERS['CnpjCount']) $('kpiCnpjCount').classList.add('active-filter');
    if (CHART_FILTERS['TopMotivo']) $('kpiTopMotivo').classList.add('active-filter');
}

function updateKPITrends(total, open, closed, fcrPerc, cnpjCount, topMotivoCount, avgTimeDays) {
    // Percentual de Em Aberto
    const openPerc = total > 0 ? Math.round((open / total) * 100) : 0;
    const openTrend = $('kOpenTrend');
    if (openTrend) {
        openTrend.className = 'kpi-trend ' + (openPerc > 50 ? 'down' : openPerc > 30 ? 'neutral' : 'up');
        openTrend.innerHTML = '<span>' + openPerc + '% do total</span>';
    }

    // Percentual de Concluídos
    const closedPerc = total > 0 ? Math.round((closed / total) * 100) : 0;
    const closedTrend = $('kClosedTrend');
    if (closedTrend) {
        closedTrend.className = 'kpi-trend ' + (closedPerc >= 70 ? 'up' : closedPerc >= 50 ? 'neutral' : 'down');
        closedTrend.innerHTML = '<span>' + closedPerc + '% do total</span>';
    }

    // FCR - Removida a meta
    const fcrTrend = $('kFCRTrend');
    if (fcrTrend) {
        fcrTrend.className = 'kpi-trend neutral';
        fcrTrend.innerHTML = '<span>' + fcrPerc + '%</span>';
    }

    // Tempo Médio - Removida a meta
    const avgTrend = $('kAvgTimeTrend');
    if (avgTrend) {
        avgTrend.className = 'kpi-trend neutral';
        if (avgTimeDays > 0) {
            avgTrend.innerHTML = '<span>' + avgTimeDays.toFixed(1) + 'd</span>';
        } else {
            avgTrend.innerHTML = '<span>--</span>';
        }
    }

    // CNPJ - média de registros por CNPJ
    const cnpjTrend = $('kCnpjTrend');
    if (cnpjTrend) {
        const avgPerCnpj = cnpjCount > 0 ? (total / cnpjCount).toFixed(1) : 0;
        cnpjTrend.className = 'kpi-trend neutral';
        cnpjTrend.innerHTML = '<i class="fa-solid fa-chart-simple"></i> <span>' + avgPerCnpj + ' reg/CNPJ</span>';
    }

    // Motivo - percentual do top motivo
    const motivoTrend = $('kMotivoTrend');
    if (motivoTrend) {
        const motivoPerc = total > 0 ? Math.round((topMotivoCount / total) * 100) : 0;
        motivoTrend.className = 'kpi-trend neutral';
        motivoTrend.innerHTML = '<i class="fa-solid fa-percent"></i> <span>' + motivoPerc + '% do total</span>';
    }
}

function filterByKPI(filterType) {
    if (filterType === 'Total') {
        if (CHART_FILTERS['Status'] === null && CHART_FILTERS['FCR_Sim'] === null && CHART_FILTERS['AvgTime'] === null) return;
        CHART_FILTERS['Status'] = null;
        CHART_FILTERS['FCR_Sim'] = null;
        CHART_FILTERS['AvgTime'] = null;
    } else if (filterType === 'Aberto') {
        if (CHART_FILTERS['Status'] === 'Aberto') {
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['Status'] = 'Aberto';
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'Fechado') {
        if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) {
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'FCR') {
        if (CHART_FILTERS['FCR_Sim'] === 'Sim') {
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['Status'] = null;
            CHART_FILTERS['AvgTime'] = null;
        } else {
            CHART_FILTERS['FCR_Sim'] = 'Sim';
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'AvgTime') {
        if (CHART_FILTERS['AvgTime']) {
            CHART_FILTERS['AvgTime'] = null;
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['AvgTime'] = 'Sim';
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['FCR_Sim'] = null;
        }
    } else if (filterType === 'CnpjCount') {
        if (CHART_FILTERS['CnpjCount']) {
            CHART_FILTERS['CnpjCount'] = null;
        } else {
            CHART_FILTERS['CnpjCount'] = 'Sim';
        }
    } else if (filterType === 'TopMotivo') {
        if (CHART_FILTERS['TopMotivo']) {
            CHART_FILTERS['TopMotivo'] = null;
        } else {
            const motivoCounts = {};
            FILTERED.forEach(item => {
                const motivo = item.motivo || 'Não informado';
                motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
            });
            let topMotivo = null;
            let topMotivoCount = 0;
            Object.entries(motivoCounts).forEach(([motivo, count]) => {
                if (count > topMotivoCount) {
                    topMotivoCount = count;
                    topMotivo = motivo;
                }
            });
            CHART_FILTERS['TopMotivo'] = topMotivo;
        }
    }
    
    applyAllFilters();
}

function filterByOrigem(origem) {
    if (CHART_FILTERS['Origem'] === origem) {
        CHART_FILTERS['Origem'] = null;
        showToast(`Filtro de origem "${origem}" removido`, 'info');
    } else {
        CHART_FILTERS['Origem'] = origem;
        showToast(`Filtrando por origem: ${origem}`, 'success');
    }
    applyAllFilters();
}

function renderCharts() {
    if (RAW.length === 0) return;
    
    const countsAnalista = {};
    FILTERED.forEach(d => countsAnalista[d.analista] = (countsAnalista[d.analista]||0)+1);
    const sortedAnalista = Object.entries(countsAnalista).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    
    createBarChart('chartAnal', sortedAnalista.map(x=>x[0]), sortedAnalista.map(x=>x[1]), 'Analista');
    createTipoAtendimentoChart();
    createOrigemContatoChart();
    
    const countsGN = {};
    FILTERED.forEach(d => {
        const gn = d.gn || 'Não informado';
        countsGN[gn] = (countsGN[gn]||0)+1;
    });
    createDoughnutChart('chartGN', countsGN, 'chartGNCenter', 'legendGN', 'GN');
    
    const countsSub = {};
    FILTERED.forEach(d => {
        const sub = d.sub || 'Não informado';
        countsSub[sub] = (countsSub[sub]||0)+1;
    });
    createDoughnutChart('chartSubclassificacao', countsSub, 'chartSubclassificacaoCenter', 'legendSubclassificacao', 'Subclasse');
    
    const timelineData = {};
    FILTERED.forEach(d => {
        if (!d.dtStart) return;
        const dateKey = moment(d.dtStart).format('YYYY-MM-DD');
        if(!timelineData[dateKey]) timelineData[dateKey] = { total: 0, closed: 0 };
        timelineData[dateKey].total++;
        if(d.statusNorm === 'Fechado') timelineData[dateKey].closed++;
    });
    
    const allDates = [];
    if (FILTERED.length > 0) {
        const minDate = new Date(Math.min(...FILTERED.map(d => d.dtStart).filter(d => d)));
        const maxDate = new Date(Math.max(...FILTERED.map(d => d.dtStart).filter(d => d)));
        let currentDate = new Date(minDate);
        while (currentDate <= maxDate) {
            allDates.push(moment(currentDate).format('YYYY-MM-DD'));
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    
    const sortedDates = allDates.sort();
    const totalPoints = sortedDates.map(d => ({
        x: moment(d, 'YYYY-MM-DD').toDate(),
        y: timelineData[d] ? timelineData[d].total : 0
    }));
    
    const closedPoints = sortedDates.map(d => ({
        x: moment(d, 'YYYY-MM-DD').toDate(),
        y: timelineData[d] ? timelineData[d].closed : 0
    }));
    
    createLineChart('chartEvo', totalPoints, closedPoints);
    
    const countsMotivo = {};
    FILTERED.forEach(d => {
        const motivo = d.motivo || 'Não informado';
        countsMotivo[motivo] = (countsMotivo[motivo]||0)+1;
    });
    const sortedMotivo = Object.entries(countsMotivo).sort((a,b)=>b[1]-a[1]);
    createHorizontalBarChart('chartMot', sortedMotivo.map(x=>x[0]), sortedMotivo.map(x=>x[1]));
}

function createOrigemContatoChart() {
    const ctx = $('chartOrigemContato').getContext('2d');
    if(charts.chartOrigemContato) charts.chartOrigemContato.destroy();
    
    const origemCounts = {};
    FILTERED.forEach(d => {
        const origem = d.origemContato || 'Não Informado';
        origemCounts[origem] = (origemCounts[origem] || 0) + 1;
    });
    
    let origemArray = Object.entries(origemCounts).map(([origem, count]) => ({origem, count}));
    origemArray.sort((a, b) => b.count - a.count);
    
    let topOrigem = [];
    let othersCount = 0;
    if (origemArray.length > 8) {
        topOrigem = origemArray.slice(0, 7);
        othersCount = origemArray.slice(7).reduce((sum, item) => sum + item.count, 0);
        if (othersCount > 0) {
            topOrigem.push({origem: 'Outros', count: othersCount});
        }
    } else {
        topOrigem = origemArray;
    }
    
    const labels = topOrigem.map(item => item.origem);
    const data = topOrigem.map(item => item.count);
    const total = data.reduce((a, b) => a + b, 0);
    
    $('chartOrigemContatoCenter').innerHTML = `
        <div class="doughnut-center-name">Total</div>
        <div class="doughnut-center-value">${total}</div>
    `;
    
    const legendDiv = $('legendOrigemContato');
    let legendHtml = '';
    
    topOrigem.forEach((item, index) => {
        const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
        const color = GN_PALETTE[index % GN_PALETTE.length];
        legendHtml += `
            <div class="legend-item" onclick="filterByOrigem('${item.origem.replace(/'/g, "\\'")}')">
                <span class="legend-color" style="background:${color}"></span>
                <span class="legend-label" title="${item.origem}">${item.origem}</span>
                <span class="legend-value">${item.count} (${perc}%)</span>
            </div>
        `;
    });
    
    legendDiv.innerHTML = legendHtml;
    
    charts.chartOrigemContato = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)',
                hoverOffset: 15,
                hoverBorderWidth: 3,
                hoverBorderColor: 'rgba(255, 255, 255, 0.5)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            },
            onClick: (e, els) => {
                if(!els.length) return;
                const idx = els[0].index;
                const origem = labels[idx];
                if (origem !== 'Outros') {
                    filterByOrigem(origem);
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    window.setupDoughnutHover(charts.chartOrigemContato, 'legendOrigemContato');
}

function createBarChart(id, labels, data, type) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Volume',
                data: data,
                backgroundColor: labels.map((_, index) => 
                    GN_PALETTE[index % GN_PALETTE.length]
                ),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, els) => {
                if(els.length > 0) {
                    const idx = els[0].index;
                    const val = labels[idx];
                    if (CHART_FILTERS['Analista'] === val) {
                        CHART_FILTERS['Analista'] = null;
                        delete CHART_FILTERS['Doughnut Selection']['Analista'];
                        Array.from($('analistaSelect').options).forEach(o => o.selected = false); if($('analistaSelectAll')) $('analistaSelectAll').checked = true;
                        showToast(`Filtro do analista "${val}" removido`, 'info');
                    } else {
                        CHART_FILTERS['Analista'] = val;
                        CHART_FILTERS['Doughnut Selection']['Analista'] = val;
                        Array.from($('analistaSelect').options).forEach(o => o.selected = (o.value === val));
                        if($('analistaSelectAll')) $('analistaSelectAll').checked = false;
                        showToast(`Filtrando por analista: ${val}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'center',
                    align: 'center',
                    formatter: (value) => value,
                    font: { weight: 'bold', size: 12 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 0,
                        font: { size: 11 }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function createTipoAtendimentoChart() {
    const ctx = $('chartTipoAtendimento').getContext('2d');
    if(charts.chartTipoAtendimento) charts.chartTipoAtendimento.destroy();
    
    const tipoCounts = {};
    FILTERED.forEach(d => {
        const tipo = d.tipoContato || 'Não Informado';
        tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
    });
    
    const tiposArray = Object.entries(tipoCounts);
    tiposArray.sort((a, b) => b[1] - a[1]);
    
    const labels = tiposArray.map(item => item[0]);
    const data = tiposArray.map(item => item[1]);
    const total = data.reduce((a, b) => a + b, 0);
    
    const backgroundColors = labels.map(label => {
        if (label === 'Ativo') return IPIRANGA_BLUE;
        if (label === 'Receptivo') return IPIRANGA_YELLOW;
        if (label === 'Não Informado') return '#8B8D9E';
        return GN_PALETTE[labels.indexOf(label) % GN_PALETTE.length];
    });
    
    charts.chartTipoAtendimento = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                borderWidth: 1,
                borderRadius: 6,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const tipo = labels[index];
                    if (CHART_FILTERS['TipoContato'] === tipo || $('tipoContatoSelect').value === tipo) {
                        CHART_FILTERS['TipoContato'] = null;
                        $('tipoContatoSelect').value = '';
                        showToast(`Filtro de tipo "${tipo}" removido`, 'info');
                    } else {
                        CHART_FILTERS['TipoContato'] = tipo;
                        $('tipoContatoSelect').value = tipo;
                        showToast(`Filtrando por tipo: ${tipo}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'center',
                    align: 'center',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: {
                        stepSize: 1,
                        font: { size: 11 }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function createDoughnutChart(id, dataObj, centerId, legendId, title) {
    let processed = [];
    for (let key in dataObj) {
        processed.push({ keyNorm: key, keyDisplay: key, count: dataObj[key] });
    }
    processed.sort((a,b)=>b.count-a.count);
    
    let top = processed.slice(0,7);
    let othersCount = processed.slice(7).reduce((acc, cur)=>acc+cur.count, 0);
    if (othersCount>0) top.push({ keyNorm: 'Outros', keyDisplay: 'Outros', count: othersCount });
    
    const labels = top.map(x=>x.keyDisplay);
    const data = top.map(x=>x.count);
    
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const total = data.reduce((a,b)=>a+b,0);
    $(centerId).innerHTML = `<div class="doughnut-center-name">${title}</div><div class="doughnut-center-value">${total}</div>`;
    
    let legendHtml = '';
    top.forEach((item, i) => {
        const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
        const color = GN_PALETTE[i % GN_PALETTE.length];
        legendHtml += `<div class="legend-item" onclick="filterByGN('${item.keyNorm.replace(/'/g, "\\'")}')">
            <span class="legend-color" style="background:${color}"></span>
            <span class="legend-label" title="${item.keyDisplay}">${item.keyDisplay}</span>
            <span class="legend-value">${item.count} (${perc}%)</span>
        </div>`;
    });
    
    $(legendId).innerHTML = legendHtml;
    
    charts[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)',
                hoverOffset: 15,
                hoverBorderWidth: 3,
                hoverBorderColor: 'rgba(255, 255, 255, 0.5)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            rotation: -90,
            circumference: 360,
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            },
            onClick: (e, els) => {
                if(!els.length) return;
                const idx = els[0].index;
                const displayVal = labels[idx];
                if (displayVal === 'Outros') return;
                if (title === 'Subclasse') {
                    if ($('subSelect').value === displayVal) {
                        $('subSelect').value = '';
                        showToast(`Filtro de subclasse removido`, 'info');
                    } else {
                        $('subSelect').value = displayVal;
                        showToast(`Filtrando por subclasse: ${displayVal}`, 'success');
                    }
                    applyAllFilters();
                } else if (title === 'GN') {
                    filterByGN(displayVal);
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    window.setupDoughnutHover(charts[id], legendId);
}

function filterByGN(gn) {
    if (CHART_FILTERS['GN'] === gn) {
        CHART_FILTERS['GN'] = null;
        showToast(`Filtro de GN removido`, 'info');
    } else {
        CHART_FILTERS['GN'] = gn;
        showToast(`Filtrando por GN: ${gn}`, 'success');
    }
    applyAllFilters();
}

function createLineChart(id, totalPoints, closedPoints) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();

    const labels = totalPoints.map(p => moment(p.x).format('YYYY-MM-DD'));
    const totalData = totalPoints.map(p => p.y);
    const closedData = closedPoints.map(p => p.y);

    const isDateFiltered = CHART_FILTERS['Evo Date'] !== null;
    let gradient;
    if (!isDateFiltered) {
        gradient = ctx.createLinearGradient(0, 0, 0, 280);
        gradient.addColorStop(0, 'rgba(61, 141, 255, 0.3)');
        gradient.addColorStop(1, 'rgba(61, 141, 255, 0)');
    }

    // Plugin para desenhar faixas de fim de semana
    const weekendPlugin = {
        id: 'weekendHighlight',
        beforeDraw: (chart) => {
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            const chartArea = chart.chartArea;

            ctx.save();

            labels.forEach((label, index) => {
                const date = moment(label, 'YYYY-MM-DD');
                const dayOfWeek = date.day(); // 0 = Domingo, 6 = Sábado

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const x = xAxis.getPixelForValue(index);
                    const barWidth = xAxis.width / labels.length;

                    ctx.fillStyle = 'rgba(255, 209, 0, 0.15)'; // Amarelo claro translúcido
                    ctx.fillRect(
                        x - barWidth / 2,
                        chartArea.top,
                        barWidth,
                        chartArea.bottom - chartArea.top
                    );
                }
            });

            ctx.restore();
        }
    };

    charts[id] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total',
                    data: totalData,
                    borderColor: BRAND_BLUE,
                    backgroundColor: isDateFiltered ? 'transparent' : gradient,
                    fill: !isDateFiltered,
                    tension: 0.4,
                    pointRadius: labels.map(d => d === CHART_FILTERS['Evo Date'] ? 10 : 6),
                    pointHoverRadius: 10,
                    pointBackgroundColor: labels.map(d => d === CHART_FILTERS['Evo Date'] ? BRAND_ORANGE : BRAND_YELLOW),
                    pointBorderColor: BRAND_BLUE,
                    pointBorderWidth: 2,
                    borderWidth: isDateFiltered ? 1 : 3,
                    datalabels: {
                        display: true,
                        align: 'top',
                        anchor: 'end',
                        offset: 8,
                        color: '#0045B5',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: (value) => value > 0 ? value : '',
                        padding: { top: 4 }
                    }
                },
                {
                    label: 'Concluído',
                    data: closedData,
                    borderColor: SUCCESS_GREEN,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.4,
                    pointRadius: 0,
                    datalabels: {
                        display: false
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: true },
            layout: {
                padding: {
                    top: 30
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 11 },
                        boxWidth: 8,
                        boxHeight: 8
                    }
                },
                tooltip: {
                    callbacks: {
                        title: (items) => {
                            const label = items[0].label;
                            let parsed = moment(label, 'YYYY-MM-DD');
                            if (!parsed.isValid()) parsed = moment(label, 'DD/MM');
                            if (!parsed.isValid()) parsed = moment(label);
                            const dayOfWeek = parsed.day();
                            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                            let title = parsed.isValid() ? parsed.format('ddd, DD/MM/YYYY') : label;
                            if (isWeekend) {
                                title += ' (Fim de Semana)';
                            }
                            return title;
                        },
                        label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
                    }
                },
                datalabels: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'category',
                    grid: { display: false },
                    ticks: {
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            const parsed = moment(label, 'YYYY-MM-DD');
                            return parsed.isValid() ? parsed.format('DD/MM') : label;
                        },
                        maxRotation: 45,
                        minRotation: 0,
                        font: { size: 11 },
                        autoSkip: true,
                        maxTicksLimit: 15
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { stepSize: 1 }
                }
            },
            onClick: (e, elements) => {
                if (!elements.length) return;
                const element = elements[0];
                const datasetIndex = element.datasetIndex;
                const index = element.index;

                if (datasetIndex === 0) {
                    const dateLabel = labels[index];
                    const dateISO = dateLabel;

                    if (CHART_FILTERS['Evo Date'] === dateISO) {
                        CHART_FILTERS['Evo Date'] = null;
                        if ($('dateStart').value === dateISO && $('dateEnd').value === dateISO) {
                            $('dateStart').value = '';
                            $('dateEnd').value = '';
                        }
                        $('datePreset').value = '';
                        showToast(`Filtro de data removido`, 'info');
                    } else {
                        CHART_FILTERS['Evo Date'] = dateISO;
                        $('dateStart').value = dateISO;
                        $('dateEnd').value = dateISO;
                        $('datePreset').value = '';
                        showToast(`Filtrando por data: ${moment(dateISO).format('DD/MM/YYYY')}`, 'success');
                    }

                    applyAllFilters();
                }
            }
        },
        plugins: [ChartDataLabels, weekendPlugin]
    });
}

function createHorizontalBarChart(id, labels, data) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const barHeight = 25;
    const minHeight = 300;
    const canvasHeight = Math.max(minHeight, labels.length * barHeight + 50);
    
    ctx.canvas.height = canvasHeight;
    ctx.canvas.style.height = canvasHeight + 'px';
    ctx.canvas.style.width = '100%';
    
    charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ocorrências',
                data: data,
                backgroundColor: labels.map((_, index) => 
                    MOTIVO_PALETTE[index % MOTIVO_PALETTE.length]
                ),
                hoverBackgroundColor: labels.map((_, index) => {
                    const color = MOTIVO_PALETTE[index % MOTIVO_PALETTE.length];
                    return color;
                }),
                barThickness: 20,
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 300
            },
            onHover: (event, elements, chart) => {
                if (elements.length > 0) {
                    chart.canvas.style.cursor = 'pointer';
                    const idx = elements[0].index;
                    chart.data.datasets[0].borderWidth = chart.data.datasets[0].data.map((_, i) => i === idx ? 3 : 0);
                    chart.data.datasets[0].borderColor = chart.data.datasets[0].data.map((_, i) => i === idx ? 'rgba(255,255,255,0.8)' : 'transparent');
                    chart.update('none');
                } else {
                    chart.canvas.style.cursor = 'default';
                    chart.data.datasets[0].borderWidth = 0;
                    chart.data.datasets[0].borderColor = 'transparent';
                    chart.update('none');
                }
            },
            onClick: (e, els) => {
                if(els.length > 0) {
                    const idx = els[0].index;
                    const val = labels[idx];
                    if (CHART_FILTERS['Motivo'] === val || $('motivoSelect').value === val) {
                        CHART_FILTERS['Motivo'] = null;
                        $('motivoSelect').value = '';
                        showToast(`Filtro do motivo "${val}" removido`, 'info');
                    } else {
                        CHART_FILTERS['Motivo'] = val;
                        $('motivoSelect').value = val;
                        showToast(`Filtrando por motivo: ${val}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'start',
                    formatter: (val) => val,
                    font: { weight: 'bold', size: 12 },
                    padding: { right: 8 },
                    clamp: true,
                    clip: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { display: false },
                    ticks: { stepSize: 1 }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 12 },
                        autoSkip: false,
                        padding: 10
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function renderTable() {
    const tbody = document.querySelector('#dataTable tbody');
    
    if (RAW.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="14" style="text-align:center; padding:30px; color:var(--text-muted); font-weight:500;">
                    <i class="fa-solid fa-file-excel" style="margin-right:10px;"></i>
                    Carregue uma base de dados para visualizar as informações
                </td>
            </tr>
        `;
        $('paginationInfo').innerText = '0-0 de 0';
        $('prevPage').disabled = true;
        $('nextPage').disabled = true;
        return;
    }
    
    tbody.innerHTML = '';
    
    const sortedData = [...FILTERED].sort((a,b) => {
        let valA = a[CURRENT_SORT.key];
        let valB = b[CURRENT_SORT.key];
        
        if (CURRENT_SORT.key === 'dtStart' || CURRENT_SORT.key === 'dtEnd') {
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else {
            if(valA == null) valA = "";
            if(valB == null) valB = "";
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
        }
        
        if (valA < valB) return CURRENT_SORT.direction === 'asc' ? -1 : 1;
        if (valA > valB) return CURRENT_SORT.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE);
    if(CURRENT_PAGE > totalPages) CURRENT_PAGE = 1;
    
    const start = (CURRENT_PAGE - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageData = sortedData.slice(start, end);
    
    $('paginationInfo').innerText = `${sortedData.length ? start+1 : 0}-${Math.min(end, sortedData.length)} de ${sortedData.length}`;
    $('prevPage').disabled = CURRENT_PAGE === 1;
    $('nextPage').disabled = CURRENT_PAGE >= totalPages || totalPages === 0;
    
    if(pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:20px;color:var(--text-muted)">Nenhum dado encontrado com os filtros atuais</td></tr>`;
        return;
    }
    
    pageData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s forwards`;
        tr.style.opacity = '0';
        
        tr.dataset.spid = row.id || '';
        tr.dataset.nome = (row.solicitante || '').replace(/['"<>]/g, '');
        let statusClass = row.statusNorm === 'Fechado' ? 'st-fechado' : 'st-aberto';
        let statusText = row.statusNorm === 'Fechado' ? 'Concluído' : 'Em Aberto';
        
        const dtStart = row.dtStart ? moment(row.dtStart).format('DD/MM/YYYY') : '-';
        const dtEnd = row.dtEnd ? moment(row.dtEnd).format('DD/MM/YYYY') : '-';
        
        const fcrColor = row.fcr === 'Sim' ? 'color:var(--success-green);font-weight:700;' : 'color:var(--text-secondary);';
        
        let tempoCor = 'color:var(--text-secondary);';
        if (row.tempoResolucaoDias !== null) {
            if (row.tempoResolucaoDias > 7) tempoCor = 'color:var(--error-red);font-weight:700;';
            else if (row.tempoResolucaoDias > 3) tempoCor = 'color:var(--brand-orange);font-weight:600;';
            else if (row.tempoResolucaoDias > 0) tempoCor = 'color:var(--success-green);font-weight:600;';
        }
        
        let tipoCor = 'color:var(--text-secondary);';
        if (row.tipoContato === 'Ativo') tipoCor = 'color:var(--brand-blue);font-weight:600;';
        else if (row.tipoContato === 'Receptivo') tipoCor = 'color:var(--color-amarelo);font-weight:600;';
        
        let origemCor = 'color:var(--text-secondary);';
        if (row.origemContato === 'Whatsapp') origemCor = 'color:#25D366;font-weight:600;';
        else if (row.origemContato === 'Telefone') origemCor = 'color:#34B7F1;font-weight:600;';
        else if (row.origemContato === 'E-mail') origemCor = 'color:#EA4335;font-weight:600;';
        else if (row.origemContato === 'Teams') origemCor = 'color:#7B83EB;font-weight:600;';
        
        const descricaoTexto = row.descricao || '-';
        const descricaoTrunc = descricaoTexto.length > 50 ? descricaoTexto.substring(0, 50) + '...' : descricaoTexto;

        tr.innerHTML = `
            <td><span class="status-pill ${statusClass}">${statusText}</span></td>
            <td>${dtStart}</td>
            <td>${dtEnd}</td>
            <td style="${tempoCor}">${row.tempoResolucaoFormatado}</td>
            <td style="${fcrColor}">${row.fcr}</td>
            <td style="font-weight:600;color:var(--brand-blue)">${row.analista}</td>
            <td class="truncated" title="${normalizarMotivo(row.motivo)}">${normalizarMotivo(row.motivo)}</td>
            <td class="truncated" title="${row.sub}">${row.sub}</td>
            <td class="truncated" title="${row.solicitante}">${row.solicitante}</td>
            <td style="${tipoCor}">${row.tipoContato}</td>
            <td style="${origemCor}">${row.origemContato}</td>
            <td class="truncated" title="${descricaoTexto}">${descricaoTrunc}</td>
            <td style="text-align:center;font-weight:600;color:var(--brand-blue);font-size:11px;">${row.id || '-'}</td>
            <td style="text-align:center;"><button class="btn-ed" onclick="window.editarReg(${row.id || null},event)">✏️</button> <button class="btn-del" onclick="window.excluirReg(${row.id || null},event)">🗑️</button></td>
        `;
        
        tr.addEventListener('click', (evt) => { if(evt.target.closest('button')) return;
            if (CHART_FILTERS['Table Row'] === row.uid) {
                CHART_FILTERS['Table Row'] = null;
                tr.classList.remove('active-filter');
                showToast('Filtro de linha específica removido', 'info');
            } else {
                CHART_FILTERS['Table Row'] = row.uid;
                document.querySelectorAll('#dataTable tr.active-filter').forEach(r => {
                    r.classList.remove('active-filter');
                });
                tr.classList.add('active-filter');
                showToast(`Filtrando por caso específico`, 'success');
            }
            applyAllFilters();
        });
        
        if (CHART_FILTERS['Table Row'] === row.uid) {
            tr.classList.add('active-filter');
        }
        
        tbody.appendChild(tr);
    });
    
    document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => el.innerHTML = '');
    const activeHeader = document.querySelector(`#dataTable th[data-key="${CURRENT_SORT.key}"] .sort-indicator`);
    if(activeHeader) activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '▲' : '▼';
}

function sortTable(key) {
    if (CURRENT_SORT.key === key) {
        CURRENT_SORT.direction = CURRENT_SORT.direction === 'asc' ? 'desc' : 'asc';
    } else {
        CURRENT_SORT.key = key;
        CURRENT_SORT.direction = 'asc';
    }
    
    document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => {
        el.innerHTML = '';
    });
    
    const activeHeader = document.querySelector(`#dataTable th[data-key="${key}"] .sort-indicator`);
    if (activeHeader) {
        activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '▲' : '▼';
    }
    
    renderTable();
}

function changePage(delta) {
    CURRENT_PAGE += delta;
    renderTable();
}

function handleDatePreset() {
    CHART_FILTERS['Evo Date'] = null;

    const val = $('datePreset').value;
    const today = new Date();
    // Criar data de amanhã (sempre um dia à frente)
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    let start = new Date();

    if(!val) return;

    switch(val) {
        case 'last7': 
            start = new Date(tomorrow);
            start.setDate(tomorrow.getDate()-7); 
            break;
        case 'last30': 
            start = new Date(tomorrow);
            start.setDate(tomorrow.getDate()-30); 
            break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'lastMonth':
            start = new Date(today.getFullYear(), today.getMonth()-1, 1);
            const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            $('dateStart').value = start.toISOString().split('T')[0];
            $('dateEnd').value = lastDayLastMonth.toISOString().split('T')[0];
            applyAllFilters();
            return;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); break;
        case 'fullRange':
            $('dateStart').value = '';
            $('dateEnd').value = '';
            applyAllFilters();
            return;
    }

    $('dateStart').value = start.toISOString().split('T')[0];
    $('dateEnd').value = tomorrow.toISOString().split('T')[0];
    applyAllFilters();
}

function updateActiveFiltersDisplay() {
    const container = $('activeFilters');
    container.innerHTML = '';
    
    if (RAW.length === 0) return;
    
    const addTag = (label, onClick, color) => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `${label} <i class="fa-solid fa-xmark"></i>`;
        if (color) tag.style.background = color;
        tag.onclick = onClick;
        container.appendChild(tag);
    };
    
    if($('qSearch').value) addTag(`Busca: "${$('qSearch').value}"`, () => { $('qSearch').value=''; applyAllFilters(); });
    if($('motivoSelect').value) addTag(`Motivo: ${$('motivoSelect').value}`, () => { $('motivoSelect').value=''; applyAllFilters(); });
    const selectedAnalistas = Array.from($('analistaSelect').selectedOptions).map(o => o.value);
    if(selectedAnalistas.length > 0) {
        const label = selectedAnalistas.length === 1 ? `Analista: ${selectedAnalistas[0]}` : `Analistas: ${selectedAnalistas.length} selecionados`;
        addTag(label, () => { Array.from($('analistaSelect').options).forEach(o => o.selected = false); $('analistaSelectAll').checked = true; applyAllFilters(); });
    }
    if($('subSelect').value) addTag(`Subclasse: ${$('subSelect').value}`, () => { $('subSelect').value=''; applyAllFilters(); });
    if($('tipoContatoSelect').value) addTag(`Tipo: ${$('tipoContatoSelect').value}`, () => { $('tipoContatoSelect').value=''; applyAllFilters(); });
    
    if(CHART_FILTERS['Status']) {
        const color = CHART_FILTERS['Status'] === 'Aberto' ? 'var(--gradient-warning)' : 'var(--gradient-success)';
        addTag(`Status: ${CHART_FILTERS['Status']}`, () => { $('kpiTotal').click(); }, color);
    }
    
    if(CHART_FILTERS['FCR_Sim']) {
        addTag(`FCR: Sim`, () => { CHART_FILTERS['FCR_Sim'] = null; $('kpiTotal').click(); });
    }
    
    if(CHART_FILTERS['AvgTime']) {
        addTag(`Tempo Médio: Ativo`, () => { CHART_FILTERS['AvgTime'] = null; $('kpiTotal').click(); }, 'var(--gradient-purple)');
    }
    
    if(CHART_FILTERS['Doughnut Selection']['Analista']) {
        addTag(`Analista: ${CHART_FILTERS['Doughnut Selection']['Analista']}`, () => { delete CHART_FILTERS['Doughnut Selection']['Analista']; $('analistaSelect').value=''; applyAllFilters(); });
    }
    
    if(CHART_FILTERS['Evo Date']) {
        addTag(`Data: ${moment(CHART_FILTERS['Evo Date']).format('DD/MM/YYYY')}`, () => { 
            CHART_FILTERS['Evo Date'] = null;
            if ($('dateStart').value === CHART_FILTERS['Evo Date'] && $('dateEnd').value === CHART_FILTERS['Evo Date']) {
                $('dateStart').value = '';
                $('dateEnd').value = '';
            }
            applyAllFilters(); 
        }, 'var(--gradient-primary)');
    } else if($('dateStart').value || $('dateEnd').value) {
        const dateLabel = `${$('dateStart').value ? moment($('dateStart').value).format('DD/MM/YYYY') : 'Início'} a ${$('dateEnd').value ? moment($('dateEnd').value).format('DD/MM/YYYY') : 'Fim'}`;
        addTag(`Período: ${dateLabel}`, () => {
            $('dateStart').value = '';
            $('dateEnd').value = '';
            $('datePreset').value = '';
            CHART_FILTERS['Evo Date'] = null;
            applyAllFilters();
        });
    } else if($('datePreset').value) {
        const presetText = $('datePreset').options[$('datePreset').selectedIndex].text;
        addTag(`Período: ${presetText}`, () => {
            $('datePreset').value = '';
            CHART_FILTERS['Evo Date'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['Origem']) {
        addTag(`Origem: ${CHART_FILTERS['Origem']}`, () => {
            CHART_FILTERS['Origem'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['GN']) {
        addTag(`GN: ${CHART_FILTERS['GN']}`, () => {
            CHART_FILTERS['GN'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['CnpjCount']) {
        addTag(`CNPJ Únicos: Sim`, () => {
            CHART_FILTERS['CnpjCount'] = null;
            applyAllFilters();
        }, 'var(--gradient-primary)');
    }
    
    if(CHART_FILTERS['TopMotivo']) {
        addTag(`Motivo Mais: ${CHART_FILTERS['TopMotivo']}`, () => {
            CHART_FILTERS['TopMotivo'] = null;
            applyAllFilters();
        }, 'var(--gradient-warning)');
    }
}

function clearAllFilters() {
    $('qSearch').value = '';
    $('motivoSelect').value = '';
    Array.from($('analistaSelect').options).forEach(o => o.selected = false); if($('analistaSelectAll')) $('analistaSelectAll').checked = true;
    $('subSelect').value = '';
    $('tipoContatoSelect').value = '';
    $('areaResponsavelSelect').value = '';
    $('dateStart').value = '';
    $('dateEnd').value = '';
    $('datePreset').value = '';
    
    CHART_FILTERS = {
        'Table Row': null,
        'Evo Date': null,
        'Status': null,
        'FCR_Sim': null,
        'Date Preset': null,
        'Doughnut Selection': {},
        'Motivo': null,
        'Analista': null,
        'Subclassificação': null,
        'TipoContato': null,
        'AreaResponsavel': null,
        'AvgTime': null,
        'Origem': null,
        'GN': null,
        'CnpjCount': null,
        'TopMotivo': null
    };
    
    CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
    CURRENT_PAGE = 1;
    applyAllFilters();
    showToast('Todos os filtros foram limpos', 'info');
}

function generateGamification() {
    if (RAW.length === 0) {
        $('gamificationBoard').innerHTML = '<div style="font-size:13px; color:var(--text-muted); text-align:center; padding:15px;">Carregue uma base de dados para visualizar o ranking</div>';
        return;
    }
    
    const board = $('gamificationBoard');
    const counts = {};
    FILTERED.forEach(d => counts[d.analista] = (counts[d.analista]||0)+1);
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 10);
    
    if(sorted.length === 0) {
        board.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-muted)">Sem dados para exibir o ranking</div>';
        return;
    }
    
    let html = '<div style="max-height:300px;overflow-y:auto;">';
    const maxCount = sorted[0][1];
    
    sorted.forEach((item, index) => {
        const medal = index === 0 ? '🥇' : (index === 1 ? '🥈' : (index === 2 ? '🥉' : ''));
        const percentage = maxCount > 0 ? Math.round((item[1]/maxCount)*100) : 0;
        const barWidth = Math.max(20, percentage);
        
        html += `
            <div style="display:flex;align-items:center;padding:12px 15px;border-bottom:1px solid var(--border-light);transition:var(--transition-fast);cursor:pointer;"
                 onclick="filterByChartSegment('Analista', '${item[0]}')">
                <div style="font-weight:900;color:var(--brand-blue);width:25px;font-size:14px;">${index+1}</div>
                <div style="flex:1;margin-left:10px;">
                    <div style="font-weight:700;font-size:13px">${item[0]} ${medal}</div>
                    <div style="font-size:11px;color:var(--text-secondary)">${item[1]} solicitações</div>
                </div>
                <div style="width:80px;height:6px;background:rgba(255, 255, 255, 0.05);border-radius:3px;overflow:hidden;">
                    <div style="width:${barWidth}%;height:100%;background:var(--gradient-primary);transition:width 0.5s;"></div>
                </div>
                <div style="font-weight:700;color:var(--brand-blue);margin-left:10px;font-size:12px;">${item[1]}</div>
            </div>`;
    });
    
    html += '</div>';
    board.innerHTML = html;
}

function filterByChartSegment(filterKey, filterValue) {
    if (filterKey === 'Analista') {
        if(CHART_FILTERS['Doughnut Selection']['Analista'] === filterValue) {
            delete CHART_FILTERS['Doughnut Selection']['Analista'];
            Array.from($('analistaSelect').options).forEach(o => o.selected = false); if($('analistaSelectAll')) $('analistaSelectAll').checked = true;
            showToast(`Filtro do analista "${filterValue}" removido`, 'info');
        } else {
            CHART_FILTERS['Doughnut Selection']['Analista'] = filterValue;
            Array.from($('analistaSelect').options).forEach(o => o.selected = (o.value === filterValue));
            if($('analistaSelectAll')) $('analistaSelectAll').checked = false;
            showToast(`Filtrando por analista: ${filterValue}`, 'success');
        }
        applyAllFilters();
    }
}

function showLoading(show, text) {
    $('loading').style.display = show ? 'flex' : 'none';
    if(text) $('loadingText').innerText = text;
    if (!show) {
        resetLoadingProgress();
    }
}

function showToast(msg, type) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.style.cssText = `
        position: fixed; top: 100px; right: 30px;
        background: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
        color: white; padding: 16px 20px; border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl); z-index: 3000; display: flex; align-items: center; gap: 12px;
        transform: translateX(400px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px;
        backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid ${type === 'success' ? SUCCESS_GREEN : type === 'error' ? 'var(--error-red)' : type === 'info' ? BRAND_BLUE : type === 'warning' ? 'var(--warning)' : PURPLE};
    `;
    
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : type === 'warning' ? 'fa-lightbulb' : 'fa-hourglass-half';
    
    t.innerHTML = `<i class="fa-solid ${icon}" style="font-size:20px;"></i><div style="flex:1;font-weight:600;font-size:13px;">${msg}</div>`;
    document.body.appendChild(t);
    
    setTimeout(() => t.style.transform = 'translateX(0)', 10);
    setTimeout(() => { t.style.transform = 'translateX(400px)'; setTimeout(() => t.remove(), 300); }, 4000);
}

function addRippleEffect(e) {
    const btn = e.currentTarget;
    const circle = document.createElement('span');
    const d = Math.max(btn.clientWidth, btn.clientHeight);
    const rect = btn.getBoundingClientRect();
    
    circle.style.width = circle.style.height = d + 'px';
    circle.style.left = e.clientX - rect.left - d/2 + 'px';
    circle.style.top = e.clientY - rect.top - d/2 + 'px';
    circle.style.position = 'absolute';
    circle.style.borderRadius = '50%';
    circle.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
    circle.style.transform = 'scale(0)';
    circle.style.animation = 'ripple 0.6s linear';
    circle.style.pointerEvents = 'none';
    
    btn.style.overflow = 'hidden';
    btn.style.position = 'relative';
    btn.appendChild(circle);
    
    setTimeout(()=>{
        circle.remove();
        btn.style.overflow = '';
    }, 600);
}

// ===== NOVAS FUNÇÕES PARA ANÁLISE POR MOTIVO =====
function loadMotivoAnalytics() {
    if (!RAW.length) {
        showToast('Carregue os dados primeiro', 'warning');
        return;
    }
    
    const motivoGroups = {};
    
    RAW.forEach(item => {
        const motivo = item.motivo || 'Não Informado';
        
        if (!motivoGroups[motivo]) {
            motivoGroups[motivo] = {
                motivo: motivo,
                total: 0,
                abertos: 0,
                fechados: 0,
                fcrSim: 0,
                fcrNao: 0,
                temposResolucao: [],
                analistas: new Set(),
                tiposContato: new Set(),
                origens: new Set(),
                registros: []
            };
        }
        
        const grupo = motivoGroups[motivo];
        grupo.total++;
        grupo.registros.push(item);
        
        if (item.statusNorm === 'Aberto') {
            grupo.abertos++;
        } else {
            grupo.fechados++;
        }
        
        if (item.fcr === 'Sim') grupo.fcrSim++;
        else if (item.fcr === 'Não') grupo.fcrNao++;
        
        // Calcular tempo com nova lógica
        if (item.statusNorm === 'Fechado' && item.dtStart && item.dtEnd) {
            const inicio = new Date(item.dtStart);
            const fim = new Date(item.dtEnd);
            const inicioDate = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
            const fimDate = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate());
            const diffMs = fimDate.getTime() - inicioDate.getTime();
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diasCalculados = diffDias === 0 ? 1 : diffDias;
            
            grupo.temposResolucao.push(diasCalculados);
        }
        
        if (item.analista) grupo.analistas.add(item.analista);
        if (item.tipoContato) grupo.tiposContato.add(item.tipoContato);
        if (item.origemContato) grupo.origens.add(item.origemContato);
    });
    
    motivoAnalyticsData = Object.values(motivoGroups).map(grupo => {
        const fcrPerc = grupo.fechados > 0 ? (grupo.fcrSim / grupo.fechados * 100) : 0;
        
        let tmrDias = 0;
        if (grupo.temposResolucao.length > 0) {
            tmrDias = grupo.temposResolucao.reduce((a, b) => a + b, 0) / grupo.temposResolucao.length;
        }
        
        return {
            ...grupo,
            fcrPercentual: fcrPerc.toFixed(1),
            tmrDias: tmrDias.toFixed(1),
            analistasCount: grupo.analistas.size,
            tiposContatoList: Array.from(grupo.tiposContato).join(', '),
            origensList: Array.from(grupo.origens).join(', ')
        };
    });
    
    renderMotivoTable();
    loadMotivoStats();
    populateMotivoSelects();
    loadAnalistaMotivoData();
    loadTMRData();
}

function renderMotivoTable() {
    const tbody = $('motivoTableBody');
    const searchTerm = ($('motivoSearch') || {value: ''}).value.toLowerCase();
    
    let filteredData = [...motivoAnalyticsData];
    if (searchTerm) {
        filteredData = filteredData.filter(item => 
            item.motivo.toLowerCase().includes(searchTerm)
        );
    }
    
    filteredData.sort((a, b) => {
        const valA = a[currentMotivoSort.key];
        const valB = b[currentMotivoSort.key];
        
        if (currentMotivoSort.key === 'tmr') {
            const numA = parseFloat(a.tmrDias) || 0;
            const numB = parseFloat(b.tmrDias) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'fcr') {
            const numA = parseFloat(a.fcrPercentual) || 0;
            const numB = parseFloat(b.fcrPercentual) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'total' || currentMotivoSort.key === 'abertos' || currentMotivoSort.key === 'fechados' || currentMotivoSort.key === 'analistas') {
            return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
        }
        
        if (typeof valA === 'string') return currentMotivoSort.direction === 'asc' 
            ? valA.localeCompare(valB) 
            : valB.localeCompare(valA);
        
        return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
    });
    
    tbody.innerHTML = '';
    
    filteredData.forEach((item, index) => {
        const tr = document.createElement('tr');
        
        const fcrColor = item.fcrPercentual >= 80 ? 'color:var(--success-green);' 
            : item.fcrPercentual >= 60 ? 'color:var(--brand-orange);' 
            : 'color:var(--error-red);';
            
        const tmrColor = parseFloat(item.tmrDias) > 2.0 ? 'color:var(--error-red);' 
            : parseFloat(item.tmrDias) > 1.0 ? 'color:var(--brand-orange);' 
            : 'color:var(--success-green);';
        
        tr.innerHTML = `
            <td><strong>${item.motivo}</strong></td>
            <td><span class="status-pill" style="background:var(--gradient-primary)">${item.total}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-warning)">${item.abertos}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-success)">${item.fechados}</span></td>
            <td style="${fcrColor}; font-weight: 600;">${item.fcrPercentual}%</td>
            <td style="${tmrColor}; font-weight: 600;">${item.tmrDias}d</td>
            <td>${item.analistasCount} analista(s)</td>
            <td class="truncated" title="${item.tiposContatoList}">${item.tiposContatoList}</td>
            <td>
                <button onclick="drillDownMotivo('${item.motivo}')" class="btn btn-sm" style="padding: 4px 8px; font-size: 11px;">
                    <i class="fa-solid fa-magnifying-glass"></i> Detalhar
                </button>
            </td>
        `;
        
        tr.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                drillDownMotivo(item.motivo);
            }
        });
        
        tbody.appendChild(tr);
    });
}

function sortMotivoTable(key) {
    if (currentMotivoSort.key === key) {
        currentMotivoSort.direction = currentMotivoSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentMotivoSort.key = key;
        currentMotivoSort.direction = 'desc';
    }
    
    renderMotivoTable();
}

function loadMotivoStats() {
    if (!motivoAnalyticsData) return;
    
    const totalRegistros = motivoAnalyticsData.reduce((sum, item) => sum + item.total, 0);
    const totalMotivos = motivoAnalyticsData.length;
    const mediaPorMotivo = (totalRegistros / totalMotivos).toFixed(1);
    
    const melhorFCR = motivoAnalyticsData.reduce((best, current) => 
        parseFloat(current.fcrPercentual) > parseFloat(best.fcrPercentual) ? current : best
    );
    
    const maisFrequente = motivoAnalyticsData.reduce((most, current) => 
        current.total > most.total ? current : most
    );
    
    $('motivoStats').innerHTML = `
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Total de Motivos Únicos:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalMotivos}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Registros Totais:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalRegistros}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Média por Motivo:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${mediaPorMotivo}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Melhor FCR:</span>
            <span style="font-weight: 600; color: var(--success-green); margin-left: 8px;">
                ${melhorFCR.fcrPercentual}% (${melhorFCR.motivo})
            </span>
        </div>
    `;
    
    const top5 = [...motivoAnalyticsData]
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);
    
    let top5HTML = '';
    top5.forEach((item, index) => {
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
        top5HTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                <span>${medal} ${item.motivo}</span>
                <span style="font-weight: 600; color: var(--brand-blue);">${item.total}</span>
            </div>
        `;
    });
    
    $('topMotivos').innerHTML = top5HTML;
}

function populateMotivoSelects() {
    const selectAnalista = $('analistaFilterMotivo');
    const selectEvolucao = $('motivoEvolucaoSelect');
    
    selectAnalista.innerHTML = '<option value="">Todos os Motivos</option>';
    selectEvolucao.innerHTML = '<option value="">Selecione um motivo</option>';
    
    motivoAnalyticsData.sort((a, b) => a.motivo.localeCompare(b.motivo)).forEach(item => {
        const option1 = document.createElement('option');
        option1.value = item.motivo;
        option1.textContent = item.motivo;
        selectAnalista.appendChild(option1.cloneNode(true));
        
        const option2 = option1.cloneNode(true);
        selectEvolucao.appendChild(option2);
    });
}

function loadAnalistaMotivoData() {
    const motivoSelecionado = $('analistaFilterMotivo').value;
    const filteredData = motivoSelecionado 
        ? RAW.filter(item => item.motivo === motivoSelecionado)
        : RAW;
    
    const analistaGroups = {};
    
    filteredData.forEach(item => {
        const analista = item.analista || 'Não Atribuído';
        
        if (!analistaGroups[analista]) {
            analistaGroups[analista] = {
                analista: analista,
                total: 0,
                abertos: 0,
                fechados: 0,
                fcrSim: 0,
                temposResolucao: [],
                motivos: new Set(),
                origens: {}
            };
        }
        
        const grupo = analistaGroups[analista];
        grupo.total++;
        grupo.motivos.add(item.motivo);
        
        if (item.statusNorm === 'Aberto') {
            grupo.abertos++;
        } else {
            grupo.fechados++;
        }
        
        if (item.fcr === 'Sim') grupo.fcrSim++;
        
        // Calcular tempo com nova lógica
        if (item.statusNorm === 'Fechado' && item.dtStart && item.dtEnd) {
            const inicio = new Date(item.dtStart);
            const fim = new Date(item.dtEnd);
            const inicioDate = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
            const fimDate = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate());
            const diffMs = fimDate.getTime() - inicioDate.getTime();
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diasCalculados = diffDias === 0 ? 1 : diffDias;
            
            grupo.temposResolucao.push(diasCalculados);
        }
        
        const origem = item.origemContato || 'Não Informado';
        grupo.origens[origem] = (grupo.origens[origem] || 0) + 1;
    });
    
    const analistaData = Object.values(analistaGroups).map(grupo => {
        const fcrPerc = grupo.fechados > 0 ? (grupo.fcrSim / grupo.fechados * 100) : 0;
        
        let tmrDias = 0;
        if (grupo.temposResolucao.length > 0) {
            tmrDias = grupo.temposResolucao.reduce((a, b) => a + b, 0) / grupo.temposResolucao.length;
        }
        
        return {
            ...grupo,
            fcrPercentual: fcrPerc.toFixed(1),
            tmrDias: tmrDias.toFixed(1),
            analistasCount: grupo.analistas.size,
            tiposContatoList: Array.from(grupo.tiposContato).join(', '),
            origensList: Array.from(grupo.origens).join(', ')
        };
    });
    
    renderMotivoTable();
    loadMotivoStats();
    populateMotivoSelects();
    loadAnalistaMotivoData();
    loadTMRData();
}

function renderMotivoTable() {
    const tbody = $('motivoTableBody');
    const searchTerm = ($('motivoSearch') || {value: ''}).value.toLowerCase();
    
    let filteredData = [...motivoAnalyticsData];
    if (searchTerm) {
        filteredData = filteredData.filter(item => 
            item.motivo.toLowerCase().includes(searchTerm)
        );
    }
    
    filteredData.sort((a, b) => {
        const valA = a[currentMotivoSort.key];
        const valB = b[currentMotivoSort.key];
        
        if (currentMotivoSort.key === 'tmr') {
            const numA = parseFloat(a.tmrDias) || 0;
            const numB = parseFloat(b.tmrDias) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'fcr') {
            const numA = parseFloat(a.fcrPercentual) || 0;
            const numB = parseFloat(b.fcrPercentual) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'total' || currentMotivoSort.key === 'abertos' || currentMotivoSort.key === 'fechados' || currentMotivoSort.key === 'analistas') {
            return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
        }
        
        if (typeof valA === 'string') return currentMotivoSort.direction === 'asc' 
            ? valA.localeCompare(valB) 
            : valB.localeCompare(valA);
        
        return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
    });
    
    tbody.innerHTML = '';
    
    filteredData.forEach((item, index) => {
        const tr = document.createElement('tr');
        
        const fcrColor = item.fcrPercentual >= 80 ? 'color:var(--success-green);' 
            : item.fcrPercentual >= 60 ? 'color:var(--brand-orange);' 
            : 'color:var(--error-red);';
            
        const tmrColor = parseFloat(item.tmrDias) > 2.0 ? 'color:var(--error-red);' 
            : parseFloat(item.tmrDias) > 1.0 ? 'color:var(--brand-orange);' 
            : 'color:var(--success-green);';
        
        tr.innerHTML = `
            <td><strong>${item.motivo}</strong></td>
            <td><span class="status-pill" style="background:var(--gradient-primary)">${item.total}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-warning)">${item.abertos}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-success)">${item.fechados}</span></td>
            <td style="${fcrColor}; font-weight: 600;">${item.fcrPercentual}%</td>
            <td style="${tmrColor}; font-weight: 600;">${item.tmrDias}d</td>
            <td>${item.analistasCount} analista(s)</td>
            <td class="truncated" title="${item.tiposContatoList}">${item.tiposContatoList}</td>
            <td>
                <button onclick="drillDownMotivo('${item.motivo}')" class="btn btn-sm" style="padding: 4px 8px; font-size: 11px;">
                    <i class="fa-solid fa-magnifying-glass"></i> Detalhar
                </button>
            </td>
        `;
        
        tr.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                drillDownMotivo(item.motivo);
            }
        });
        
        tbody.appendChild(tr);
    });
}

function sortMotivoTable(key) {
    if (currentMotivoSort.key === key) {
        currentMotivoSort.direction = currentMotivoSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentMotivoSort.key = key;
        currentMotivoSort.direction = 'desc';
    }
    
    renderMotivoTable();
}

function loadMotivoStats() {
    if (!motivoAnalyticsData) return;
    
    const totalRegistros = motivoAnalyticsData.reduce((sum, item) => sum + item.total, 0);
    const totalMotivos = motivoAnalyticsData.length;
    const mediaPorMotivo = (totalRegistros / totalMotivos).toFixed(1);
    
    const melhorFCR = motivoAnalyticsData.reduce((best, current) => 
        parseFloat(current.fcrPercentual) > parseFloat(best.fcrPercentual) ? current : best
    );
    
    const maisFrequente = motivoAnalyticsData.reduce((most, current) => 
        current.total > most.total ? current : most
    );
    
    $('motivoStats').innerHTML = `
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Total de Motivos Únicos:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalMotivos}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Registros Totais:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalRegistros}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Média por Motivo:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${mediaPorMotivo}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Melhor FCR:</span>
            <span style="font-weight: 600; color: var(--success-green); margin-left: 8px;">
                ${melhorFCR.fcrPercentual}% (${melhorFCR.motivo})
            </span>
        </div>
    `;
    
    const top5 = [...motivoAnalyticsData]
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);
    
    let top5HTML = '';
    top5.forEach((item, index) => {
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
        top5HTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                <span>${medal} ${item.motivo}</span>
                <span style="font-weight: 600; color: var(--brand-blue);">${item.total}</span>
            </div>
        `;
    });
    
    $('topMotivos').innerHTML = top5HTML;
}

function populateMotivoSelects() {
    const selectAnalista = $('analistaFilterMotivo');
    const selectEvolucao = $('motivoEvolucaoSelect');
    
    selectAnalista.innerHTML = '<option value="">Todos os Motivos</option>';
    selectEvolucao.innerHTML = '<option value="">Selecione um motivo</option>';
    
    motivoAnalyticsData.sort((a, b) => a.motivo.localeCompare(b.motivo)).forEach(item => {
        const option1 = document.createElement('option');
        option1.value = item.motivo;
        option1.textContent = item.motivo;
        selectAnalista.appendChild(option1.cloneNode(true));
        
        const option2 = option1.cloneNode(true);
        selectEvolucao.appendChild(option2);
    });
}

function loadAnalistaMotivoData() {
    const motivoSelecionado = $('analistaFilterMotivo').value;
    const filteredData = motivoSelecionado 
        ? RAW.filter(item => item.motivo === motivoSelecionado)
        : RAW;
    
    const analistaGroups = {};
    
    filteredData.forEach(item => {
        const analista = item.analista || 'Não Atribuído';
        
        if (!analistaGroups[analista]) {
            analistaGroups[analista] = {
                analista: analista,
                total: 0,
                abertos: 0,
                fechados: 0,
                fcrSim: 0,
                temposResolucao: [],
                motivos: new Set(),
                origens: {}
            };
        }
        
        const grupo = analistaGroups[analista];
        grupo.total++;
        grupo.motivos.add(item.motivo);
        
        if (item.statusNorm === 'Aberto') {
            grupo.abertos++;
        } else {
            grupo.fechados++;
        }
        
        if (item.fcr === 'Sim') grupo.fcrSim++;
        
        // Calcular tempo com nova lógica
        if (item.statusNorm === 'Fechado' && item.dtStart && item.dtEnd) {
            const inicio = new Date(item.dtStart);
            const fim = new Date(item.dtEnd);
            const inicioDate = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
            const fimDate = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate());
            const diffMs = fimDate.getTime() - inicioDate.getTime();
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diasCalculados = diffDias === 0 ? 1 : diffDias;
            
            grupo.temposResolucao.push(diasCalculados);
        }
        
        const origem = item.origemContato || 'Não Informado';
        grupo.origens[origem] = (grupo.origens[origem] || 0) + 1;
    });
    
    const analistaData = Object.values(analistaGroups).map(grupo => {
        const fcrPerc = grupo.fechados > 0 ? (grupo.fcrSim / grupo.fechados * 100) : 0;
        
        let tmrDias = 0;
        if (grupo.temposResolucao.length > 0) {
            tmrDias = grupo.temposResolucao.reduce((a, b) => a + b, 0) / grupo.temposResolucao.length;
        }
        
        let origemPrincipal = '-';
        let maxCount = 0;
        Object.entries(grupo.origens).forEach(([origem, count]) => {
            if (count > maxCount) {
                maxCount = count;
                origemPrincipal = origem;
            }
        });
        
        return {
            ...grupo,
            fcrPercentual: fcrPerc.toFixed(1),
            tmrDias: tmrDias.toFixed(1),
            motivosCount: grupo.motivos.size,
            origemPrincipal: origemPrincipal
        };
    });
    
    const tbody = $('analistaMotivoTable');
    tbody.innerHTML = '';
    
    analistaData.sort((a, b) => b.total - a.total).forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${item.analista}</strong></td>
            <td>${item.motivosCount}</td>
            <td>${item.total}</td>
            <td>${item.abertos}</td>
            <td>${item.fechados}</td>
            <td>${item.fcrPercentual}%</td>
            <td>${item.tmrDias}d</td>
            <td>${item.origemPrincipal}</td>
        `;
        tbody.appendChild(tr);
    });
    
    updateAnalistaCharts(analistaData);
}

function updateAnalistaCharts(data) {
    const ctx1 = $('chartAnalistaVolume').getContext('2d');
    if (motivoCharts.analistaVolumeChart) motivoCharts.analistaVolumeChart.destroy();
    
    const sortedData = [...data].sort((a, b) => b.total - a.total).slice(0, 10);
    
    motivoCharts.analistaVolumeChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: sortedData.map(d => d.analista),
            datasets: [{
                label: 'Total de Atendimentos',
                data: sortedData.map(d => d.total),
                backgroundColor: MOTIVO_PALETTE[0],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    const ctx2 = $('chartAnalistaFCR').getContext('2d');
    if (motivoCharts.analistaFCRChart) motivoCharts.analistaFCRChart.destroy();
    
    motivoCharts.analistaFCRChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: sortedData.map(d => d.analista),
            datasets: [{
                label: 'FCR (%)',
                data: sortedData.map(d => parseFloat(d.fcrPercentual)),
                backgroundColor: sortedData.map(d => 
                    parseFloat(d.fcrPercentual) >= 80 ? MOTIVO_PALETTE[6] :
                    parseFloat(d.fcrPercentual) >= 60 ? MOTIVO_PALETTE[9] :
                    MOTIVO_PALETTE[11]
                ),
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    max: 100,
                    ticks: {
                        callback: value => value + '%'
                    }
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value + '%'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function loadTMRData() {
    if (!motivoAnalyticsData) return;
    
    const motivosComTMR = motivoAnalyticsData
        .filter(item => parseFloat(item.tmrDias) > 0)
        .sort((a, b) => parseFloat(b.tmrDias) - parseFloat(a.tmrDias));
    
    const temposGeral = [];
    motivoAnalyticsData.forEach(item => {
        if (item.temposResolucao && item.temposResolucao.length > 0) {
            temposGeral.push(...item.temposResolucao);
        }
    });
    
    const tmrGeralHoras = temposGeral.length > 0 
        ? (temposGeral.reduce((a, b) => a + b, 0) / temposGeral.length)
        : 0;
    const tmrGeralDias = tmrGeralHoras.toFixed(1);
    
    $('tmrGeral').textContent = `${tmrGeralDias}d`;
    
    if (motivosComTMR.length > 0) {
        const maisRapido = motivosComTMR[motivosComTMR.length - 1];
        const maisLento = motivosComTMR[0];
        
        $('motivoMaisRapido').textContent = maisRapido.motivo;
        $('tempoMaisRapido').textContent = `${maisRapido.tmrDias} dias`;
        
        $('motivoMaisLento').textContent = maisLento.motivo;
        $('tempoMaisLento').textContent = `${maisLento.tmrDias} dias`;
    }
    
    const ctx = $('chartTMRMotivo').getContext('2d');
    if (motivoCharts.tmrChart) motivoCharts.tmrChart.destroy();
    
    const top15 = motivosComTMR.slice(0, 15);
    
    motivoCharts.tmrChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top15.map(d => d.motivo.length > 20 ? d.motivo.substring(0, 20) + '...' : d.motivo),
            datasets: [{
                label: 'TMR (dias)',
                data: top15.map(d => parseFloat(d.tmrDias)),
                backgroundColor: top15.map(d => 
                    parseFloat(d.tmrDias) > 2.0 ? MOTIVO_PALETTE[11] :
                    parseFloat(d.tmrDias) > 1.0 ? MOTIVO_PALETTE[9] :
                    MOTIVO_PALETTE[6]
                ),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: context => `TMR: ${context.parsed.y.toFixed(1)} dias`
                    }
                },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value.toFixed(1) + 'd'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    const tbody = $('tmrDetailTable');
    tbody.innerHTML = '';
    
    motivosComTMR.forEach(item => {
        const casosLentos = item.temposResolucao.filter(t => t > 7).length;
        const desvioPadraoDias = item.temposResolucao.length > 1 
            ? Math.sqrt(item.temposResolucao.reduce((sq, n) => sq + Math.pow(n - parseFloat(item.tmrDias), 2), 0) / item.temposResolucao.length)
            : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.motivo}</td>
            <td>${item.fechados}</td>
            <td>${item.tmrDias}</td>
            <td>${desvioPadraoDias.toFixed(1)}d</td>
            <td>${casosLentos}</td>
        `;
        tbody.appendChild(tr);
    });
}

function drillDownMotivo(motivo) {
    $('motivoSearch').value = motivo;
    renderMotivoTable();
    switchAutomationTab('distribuicao');
    showToast(`Filtrando por motivo: ${motivo}`, 'success');
}

function switchAutomationTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    document.querySelector(`.tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
    $(`tab-${tabName}`)?.classList.add('active');
    
    if (tabName === 'evolucao') {
        updateEvolucaoChart();
    }
}

function updateEvolucaoChart() {
    const motivoSelecionado = $('motivoEvolucaoSelect').value;
    const periodoSelecionado = $('periodoEvolucao').value;
    
    if (!motivoSelecionado) {
        $('tendenciaDiaria').innerHTML = 'Selecione um motivo para visualizar a evolução';
        $('picoOcorrencias').innerHTML = 'Selecione um motivo para visualizar os picos';
        return;
    }
    
    const dadosMotivo = RAW.filter(item => item.motivo === motivoSelecionado);
    
    const dadosPorData = {};
    dadosMotivo.forEach(item => {
        if (!item.dtStart) return;
        const dataKey = moment(item.dtStart).format('YYYY-MM-DD');
        if (!dadosPorData[dataKey]) {
            dadosPorData[dataKey] = { total: 0, concluidos: 0 };
        }
        dadosPorData[dataKey].total++;
        if (item.statusNorm === 'Fechado') {
            dadosPorData[dataKey].concluidos++;
        }
    });
    
    const datas = Object.keys(dadosPorData).sort();
    
    let datasFiltradas = datas;
    if (periodoSelecionado !== 'all') {
        const dias = parseInt(periodoSelecionado);
        const dataLimite = moment().subtract(dias, 'days').format('YYYY-MM-DD');
        datasFiltradas = datas.filter(d => d >= dataLimite);
    }
    
    const labels = datasFiltradas;
    const totais = datasFiltradas.map(d => dadosPorData[d].total);
    const concluidos = datasFiltradas.map(d => dadosPorData[d].concluidos);
    
    const ctx = $('chartEvolucaoMotivo').getContext('2d');
    if (motivoCharts.evolucaoChart) motivoCharts.evolucaoChart.destroy();
    
    motivoCharts.evolucaoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total',
                    data: totais,
                    borderColor: MOTIVO_PALETTE[0],
                    backgroundColor: 'rgba(0, 69, 181, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Concluídos',
                    data: concluidos,
                    borderColor: MOTIVO_PALETTE[6],
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
    
    const totalPeriodo = totais.reduce((a, b) => a + b, 0);
    const mediaDiaria = (totalPeriodo / labels.length).toFixed(1);
    const maiorDia = Math.max(...totais);
    const indiceMaiorDia = totais.indexOf(maiorDia);
    const dataMaiorDia = labels[indiceMaiorDia];
    
    $('tendenciaDiaria').innerHTML = `
        <div style="margin-bottom: 5px;">
            <span style="color: var(--text-secondary);">Média diária:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${mediaDiaria} ocorrências/dia</span>
        </div>
        <div>
            <span style="color: var(--text-secondary);">Total no período:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${totalPeriodo} ocorrências</span>
        </div>
    `;
    
    $('picoOcorrencias').innerHTML = `
        <div style="margin-bottom: 5px;">
            <span style="color: var(--text-secondary);">Pico:</span>
            <span style="font-weight: 600; color: var(--brand-orange); margin-left: 5px;">${maiorDia} ocorrências</span>
        </div>
        <div>
            <span style="color: var(--text-secondary);">Data do pico:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${moment(dataMaiorDia).format('DD/MM/YYYY')}</span>
        </div>
    `;
}

// ===== FUNÇÕES ADICIONAIS =====
function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Erro ao ativar tela cheia: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function downloadChart(chartId, filename) {
    const chartCanvas = $(chartId);
    const link = document.createElement('a');
    link.download = filename;
    link.href = chartCanvas.toDataURL('image/png');
    link.click();
}

function exportCSV() {
    if (FILTERED.length === 0) {
        showToast('Não há dados para exportar', 'warning');
        return;
    }
    
    const headers = ['Status', 'Data Início', 'Data Fim', 'Tempo Resolução', 'FCR', 'Analista', 'Motivo', 'Sub Classificação', 'Razão Social', 'Tipo Atendimento', 'Origem Contato'];
    
    const csvContent = [
        headers.join(','),
        ...FILTERED.map(row => [
            row.status,
            row.dtStart ? moment(row.dtStart).format('DD/MM/YYYY') : '',
            row.dtEnd ? moment(row.dtEnd).format('DD/MM/YYYY') : '',
            row.tempoResolucaoFormatado,
            row.fcr,
            `"${row.analista}"`,
            `"${normalizarMotivo(row.motivo)}"`,
            `"${row.sub}"`,
            `"${row.solicitante}"`,
            row.tipoContato,
            row.origemContato
        ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `dados_hub_${moment().format('YYYY-MM-DD_HH-mm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV exportado com sucesso!', 'success');
}

function exportMotivoCSV() {
    if (!motivoAnalyticsData) {
        showToast('Carregue os dados de motivo primeiro', 'warning');
        return;
    }
    
    const headers = ['Motivo', 'Total', 'Em Aberto', 'Concluídos', 'FCR (%)', 'TMR (dias)', 'Nº Analistas', 'Tipos de Contato', 'Origens'];
    
    const csvContent = [
        headers.join(','),
        ...motivoAnalyticsData.map(item => [
            `"${item.motivo}"`,
            item.total,
            item.abertos,
            item.fechados,
            item.fcrPercentual,
            item.tmrDias,
            item.analistasCount,
            `"${item.tiposContatoList}"`,
            `"${item.origensList}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `analise_motivos_${moment().format('YYYY-MM-DD_HH-mm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV de motivos exportado com sucesso!', 'success');
}

function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    localStorage.setItem('dashboard-theme', isLight ? 'light' : 'dark');
    showToast(`Tema ${isLight ? 'claro' : 'escuro'} ativado`, 'info');
}

function updateLastUpdateTime() {
    LAST_UPDATE_TIME = new Date();
    $('lastUpdateTime').textContent = moment(LAST_UPDATE_TIME).format('DD/MM/YYYY HH:mm');
}

function generateExecutiveReport() {
    if (!FILTERED || FILTERED.length === 0) {
        showToast('Carregue os dados primeiro antes de gerar o relatório.', 'warning');
        return;
    }

    showToast('Gerando relatório executivo...', 'info');

    const total = FILTERED.length;
    const abertos = FILTERED.filter(i => i.statusNorm === 'Aberto').length;
    const fechados = FILTERED.filter(i => i.statusNorm === 'Fechado').length;
    const fcrSim = FILTERED.filter(i => i.fcr === 'Sim').length;
    const fcrPerc = fechados > 0 ? ((fcrSim / fechados) * 100).toFixed(1) : '0.0';

    const tmrDias = calcularTMRComNovaLogica();

    const cnpjsUnicos = new Set(FILTERED.filter(i => i.cnpj && i.cnpj.trim() !== '').map(i => i.cnpj)).size;

    const motivoCounts = {};
    FILTERED.forEach(item => {
        const motivo = item.motivo || 'Não informado';
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
    });
    const topMotivos = Object.entries(motivoCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const analistaCounts = {};
    FILTERED.forEach(item => {
        const analista = item.analista || 'Não Atribuído';
        analistaCounts[analista] = (analistaCounts[analista] || 0) + 1;
    });
    const topAnalistas = Object.entries(analistaCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const origemCounts = {};
    FILTERED.forEach(item => {
        const origem = item.origemContato || 'Não Informado';
        origemCounts[origem] = (origemCounts[origem] || 0) + 1;
    });

    const tipoCounts = {};
    FILTERED.forEach(item => {
        const tipo = item.tipoContato || 'Não Informado';
        tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
    });

    const datas = FILTERED.filter(i => i.dtStart).map(i => i.dtStart);
    const dataMin = datas.length > 0 ? moment(Math.min(...datas)).format('DD/MM/YYYY') : '--';
    const dataMax = datas.length > 0 ? moment(Math.max(...datas)).format('DD/MM/YYYY') : '--';

    const reportHTML = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Relatório Executivo - Torre Mapeamento de Contatos</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%230045B5'/%3E%3Cstop offset='100%25' stop-color='%230068FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ccircle cx='30' cy='30' r='12' fill='%23FFD100'/%3E%3Ccircle cx='70' cy='30' r='12' fill='%23FFD100'/%3E%3Ccircle cx='30' cy='70' r='12' fill='%23FFD100'/%3E%3Ccircle cx='70' cy='70' r='12' fill='%23FFD100'/%3E%3Ccircle cx='50' cy='50' r='18' fill='white'/%3E%3Cpath d='M30 30 L50 50 M70 30 L50 50 M30 70 L50 50 M70 70 L50 50' stroke='%23FFD100' stroke-width='4' stroke-linecap='round'/%3E%3C/svg%3E">
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: 'Inter', sans-serif;
                    background: linear-gradient(135deg, #f8faff 0%, #e8f0ff 100%);
                    color: #1a1b2e;
                    line-height: 1.6;
                    padding: 40px;
                }
                .report-container {
                    max-width: 900px;
                    margin: 0 auto;
                    background: white;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                    overflow: hidden;
                }
                .report-header {
                    background: linear-gradient(135deg, #0045B5 0%, #0068FF 100%);
                    color: white;
                    padding: 40px;
                    text-align: center;
                }
                .report-header h1 {
                    font-family: 'Montserrat', sans-serif;
                    font-size: 28px;
                    font-weight: 800;
                    margin-bottom: 10px;
                }
                .report-header p {
                    opacity: 0.9;
                    font-size: 14px;
                }
                .report-content { padding: 40px; }
                .section {
                    margin-bottom: 30px;
                    padding-bottom: 30px;
                    border-bottom: 1px solid #e8e9ee;
                }
                .section:last-child { border-bottom: none; }
                .section-title {
                    font-family: 'Montserrat', sans-serif;
                    font-size: 18px;
                    font-weight: 700;
                    color: #0045B5;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .section-title::before {
                    content: '';
                    width: 4px;
                    height: 24px;
                    background: linear-gradient(180deg, #0045B5, #FFD100);
                    border-radius: 2px;
                }
                .kpi-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                }
                .kpi-card {
                    background: linear-gradient(135deg, #f8faff 0%, #fff 100%);
                    border: 1px solid #e8e9ee;
                    border-radius: 12px;
                    padding: 20px;
                    text-align: center;
                }
                .kpi-value {
                    font-family: 'Montserrat', sans-serif;
                    font-size: 32px;
                    font-weight: 800;
                    color: #0045B5;
                    line-height: 1;
                }
                .kpi-label {
                    font-size: 12px;
                    color: #5a5d72;
                    margin-top: 8px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .list-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: #f8faff;
                    border-radius: 8px;
                    margin-bottom: 8px;
                }
                .list-item:last-child { margin-bottom: 0; }
                .list-name { font-weight: 600; color: #1a1b2e; }
                .list-value {
                    font-weight: 700;
                    color: #0045B5;
                    background: rgba(0,69,181,0.1);
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 13px;
                }
                .report-footer {
                    background: #f8faff;
                    padding: 20px 40px;
                    text-align: center;
                    font-size: 12px;
                    color: #5a5d72;
                    border-top: 1px solid #e8e9ee;
                }
                .print-btn {
                    background: linear-gradient(135deg, #0045B5, #0068FF);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-top: 20px;
                    font-size: 14px;
                }
                .print-btn:hover { opacity: 0.9; }
                @media print {
                    body { padding: 0; background: white; }
                    .report-container { box-shadow: none; }
                    .print-btn { display: none; }
                }
            
/* WORD CLOUD */
.word-cloud-card { min-height: 500px; }
.word-cloud-container { position: relative; height: 400px; width: 100%; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); overflow: hidden; display: flex; align-items: center; justify-content: center; }
.word-cloud-container canvas { max-width: 100%; max-height: 100%; }
.word-cloud-empty { text-align: center; color: var(--text-muted); padding: 40px; flex-direction: column; }
.word-cloud-empty i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; display: block; }
.word-cloud-empty p { font-size: 14px; max-width: 400px; margin: 0 auto; }
.word-cloud-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border: 1px solid var(--border-primary); }
.word-stat { text-align: center; padding: 12px; }
.word-stat-value { display: block; font-size: 24px; font-weight: 800; color: var(--brand-blue); font-family: var(--font-secondary); margin-bottom: 4px; }
.word-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
@media (max-width: 900px) { .word-cloud-stats { grid-template-columns: repeat(2,1fr); } .word-cloud-container { height: 300px; } }

.modal-inserir-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: fadeInOverlay 0.3s ease-out;
}
@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}
.modal-inserir-overlay.show {
    display: flex;
}
.modal-inserir {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    width: 95%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-primary);
    animation: slideUpModal 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
@keyframes slideUpModal {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.modal-inserir-header {
    background: var(--color-azul);
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid var(--color-amarelo);
}
.modal-inserir-title {
    color: white;
    font-size: 20px;
    font-weight: 800;
    font-family: var(--font-secondary);
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal-inserir-title i {
    color: var(--color-amarelo);
}
.modal-inserir-close {
    background: rgba(255,255,255,0.15);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-inserir-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}
.modal-inserir-body {
    padding: 30px;
    overflow-y: auto;
    max-height: calc(90vh - 180px);
}
.form-inserir-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.form-inserir-grid .form-group.full-width {
    grid-column: span 2;
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.form-group label {
    font-size: 12px;
    font-weight: 700;
    color: var(--color-azul);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.form-group label .required {
    color: var(--error-red);
    margin-left: 2px;
}
.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 16px;
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
    background: var(--bg-card);
    color: var(--text-primary);
    transition: var(--transition-fast);
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-azul);
    box-shadow: 0 0 0 4px rgba(0, 69, 181, 0.15);
}
.form-group input.invalid,
.form-group select.invalid,
.form-group textarea.invalid {
    border-color: var(--error-red);
    box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.15);
}
.form-group textarea {
    min-height: 100px;
    resize: vertical;
}
.form-group .error-message {
    font-size: 11px;
    color: var(--error-red);
    display: none;
}
.form-group .error-message.show {
    display: block;
}
.modal-inserir-footer {
    padding: 20px 30px;
    background: rgba(0, 69, 181, 0.05);
    border-top: 1px solid var(--border-primary);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}
.btn-inserir-submit {
    background: var(--color-azul) !important;
    color: white !important;
    padding: 14px 28px !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    border: none !important;
    border-radius: var(--radius-sm) !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition-fast);
    box-shadow: 0 4px 15px rgba(0, 69, 181, 0.3);
}
.btn-inserir-submit:hover:not(:disabled) {
    background: var(--color-indigo) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 69, 181, 0.4);
}
.btn-inserir-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}
.btn-inserir-submit .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
}
.btn-inserir-submit.loading .spinner {
    display: block;
}
.btn-inserir-submit.loading .btn-text {
    display: none;
}
.btn-inserir-cancel {
    background: transparent !important;
    color: var(--text-secondary) !important;
    padding: 14px 24px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    border: 1px solid var(--border-primary) !important;
    border-radius: var(--radius-sm) !important;
    cursor: pointer;
    transition: var(--transition-fast);
}
.btn-inserir-cancel:hover {
    background: rgba(0,0,0,0.05) !important;
    border-color: var(--text-secondary) !important;
}
.btn-novo-registro {
    background: linear-gradient(135deg, #00C9A7 0%, #008B74 100%) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(0, 201, 167, 0.3) !important;
    border: none !important;
}
.btn-novo-registro:hover {
    background: linear-gradient(135deg, #00E4BE 0%, #00A98A 100%) !important;
    box-shadow: 0 6px 20px rgba(0, 201, 167, 0.4) !important;
    transform: translateY(-2px) scale(1.02);
}
@media (max-width: 600px) {
    .form-inserir-grid {
        grid-template-columns: 1fr;
    }
    .form-inserir-grid .form-group.full-width {
        grid-column: span 1;
    }
    .modal-inserir-footer {
        flex-direction: column;
    }
    .modal-inserir-footer button {
        width: 100%;
        justify-content: center;
    }
}

</style>
        </head>
        <body>
            <div class="report-container">
                <div class="report-header">
                    <h1>📊 Relatório Executivo</h1>
                    <p>Torre Mapeamento de Contatos • Período: ${dataMin} a ${dataMax}</p>
                    <p>Gerado em: ${moment().format('DD/MM/YYYY [às] HH:mm')}</p>
                </div>
                <div class="report-content">
                    <div class="section">
                        <div class="section-title">Indicadores Principais</div>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-value">${total}</div>
                                <div class="kpi-label">Total Registros</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${abertos}</div>
                                <div class="kpi-label">Em Aberto</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${fechados}</div>
                                <div class="kpi-label">Concluídos</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${cnpjsUnicos}</div>
                                <div class="kpi-label">CNPJs Únicos</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${topMotivos.length > 0 ? topMotivos[0][0].substring(0, 15) + (topMotivos[0][0].length > 15 ? '...' : '') : '-'}</div>
                                <div class="kpi-label">Motivo Mais Tratado</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${fcrPerc}%</div>
                                <div class="kpi-label">FCR</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${tmrDias}d</div>
                                <div class="kpi-label">TMR (dias)</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Top 5 Motivos</div>
                        ${topMotivos.map(([motivo, count], idx) => `
                            <div class="list-item">
                                <span class="list-name">${idx + 1}. ${motivo}</span>
                                <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="section">
                        <div class="section-title">Top 5 Analistas</div>
                        ${topAnalistas.map(([analista, count], idx) => `
                            <div class="list-item">
                                <span class="list-name">${idx + 1}. ${analista}</span>
                                <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="section">
                        <div class="section-title">Distribuição por Tipo de Atendimento</div>
                        ${Object.entries(tipoCounts).map(([tipo, count]) => `
                            <div class="list-item">
                                <span class="list-name">${tipo}</span>
                                <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="section">
                        <div class="section-title">Distribuição por Origem de Contato</div>
                        ${Object.entries(origemCounts).map(([origem, count]) => `
                            <div class="list-item">
                                <span class="list-name">${origem}</span>
                                <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="report-footer">
                    <p>Relatório gerado automaticamente pelo Dashboard Torre Mapeamento de Contatos</p>
                    <button class="print-btn" onclick="window.print()">🖨️ Imprimir Relatório</button>
                </div>
            </div>
        </body>
        </html>
    `;

    const newWindow = window.open();
    newWindow.document.write(reportHTML);
    newWindow.document.close();
    showToast('Relatório gerado com sucesso!', 'success');
}
// ============ DEMANDA INTERNA (CÓDIGO FALTANTE) ============
// ============ DEMANDA INTERNA (INTEGRAÇÃO LOCAL) ============
function updateDemandaInternaFromStorage() {
    try {
        // Tenta ler os dados que o req_internas.html salvou
        const savedData = localStorage.getItem('consolida_dashboard_data');
        const element = document.getElementById('demandaInternaCount');
        
        if (!element) return;

        if (savedData) {
            const parsedData = JSON.parse(savedData);
            // O req_internas salva uma propriedade .count
            const count = parsedData.count || 0;
            
            // Atualiza o número na tela
            element.innerText = count;
            
            // Opcional: Muda a cor se tiver dados
            if (count > 0) {
                element.style.color = 'var(--text-primary)';
                element.style.fontWeight = '700';
            }
        } else {
            // Se não houver dados salvos ainda
            element.innerText = "0";
        }
    } catch (error) {
        console.error('Erro ao ler demandas internas locais:', error);
        const element = document.getElementById('demandaInternaCount');
        if(element) element.innerText = "--";
    }
}

// Executa assim que carregar
updateDemandaInternaFromStorage();

// Verifica a cada 3 segundos se houve mudança (caso você atualize o outro dash na outra aba)
setInterval(updateDemandaInternaFromStorage, 3000);

const STOPWORDS_PT = new Set(['posto','entrei','foram','a','o','e','é','de','da','do','das','dos','em','no','na','nos','nas','um','uma','uns','umas','para','por','com','sem','que','se','não','nao','mais','como','mas','foi','ser','são','sao','está','esta','estar','esse','essa','esses','essas','este','estes','estas','isto','isso','aquilo','aquele','aquela','aqueles','aquelas','pelo','pela','pelos','pelas','ao','aos','à','às','até','após','ante','sob','sobre','entre','perante','contra','desde','durante','mediante','segundo','conforme','consoante','quando','onde','porque','porquê','pois','logo','portanto','entretanto','todavia','contudo','porém','já','ainda','também','tambem','apenas','só','somente','mesmo','mesma','próprio','propria','tal','tais','qual','quais','quanto','quanta','quantos','quantas','todo','toda','todos','todas','outro','outra','outros','outras','muito','muita','muitos','muitas','pouco','pouca','poucos','poucas','algum','alguma','alguns','algumas','nenhum','nenhuma','cada','certo','certa','certos','certas','vário','vária','vários','várias','tanto','tanta','tantos','tantas','bastante','bastantes','qualquer','quaisquer','eu','tu','ele','ela','nós','vós','eles','elas','me','te','lhe','vos','lhes','mim','ti','si','meu','minha','meus','minhas','teu','tua','teus','tuas','seu','sua','seus','suas','nosso','nossa','nossos','nossas','vosso','vossa','vossos','vossas','dele','dela','deles','delas','nele','nela','neles','nelas','aqui','aí','ali','lá','cá','acolá','longe','perto','dentro','fora','acima','abaixo','adiante','atrás','agora','antes','depois','hoje','ontem','amanhã','sempre','nunca','jamais','talvez','sim','bem','mal','assim','então','entao','ora','seja','ou','nem','quer','enquanto','embora','caso','ref','obs','via','dia','dias','vez','vezes','forma','formas','tipo','tipos','ano','anos','mes','mês','meses','favor','obrigado','obrigada','prezado','prezada','att','atenciosamente','cordialmente','olá','ola','bom','boa','etc','sr','sra','dr','dra','ltda','cpf','cnpj','rg','ie']);
let wordCloudData = [];
function processDescriptions() {
    const descriptions = FILTERED.map(item => item.descricao || '').filter(d => d.trim() !== '');
    if (descriptions.length === 0) return { words: [], totalDescriptions: 0 };
    const wordCounts = {};
    descriptions.forEach(desc => {
        const cleanText = desc.toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
        cleanText.split(' ').forEach(word => {
            if (word.length > 2 && !STOPWORDS_PT.has(word) && !/^\d+$/.test(word)) wordCounts[word] = (wordCounts[word] || 0) + 1;
        });
    });
    const minFreq = parseInt($('wordCloudMinFreq')?.value) || 2;
    return { words: Object.entries(wordCounts).filter(([w, c]) => c >= minFreq).sort((a, b) => b[1] - a[1]).slice(0, 150), totalDescriptions: descriptions.length };
}
function generateWordCloud() {
    const container = $('wordCloudContainer'), canvas = $('wordCloudCanvas'), emptyMsg = $('wordCloudEmpty');
    if (!container || !canvas) return;
    if (RAW.length === 0) { canvas.style.display = 'none'; emptyMsg.style.display = 'flex'; updateWordCloudStats([], 0); return; }
    const { words, totalDescriptions } = processDescriptions();
    if (words.length === 0) { canvas.style.display = 'none'; emptyMsg.style.display = 'flex'; updateWordCloudStats([], totalDescriptions); return; }
    canvas.style.display = 'block'; emptyMsg.style.display = 'none';
    const containerWidth = container.clientWidth || 800, containerHeight = container.clientHeight || 400;
    canvas.width = containerWidth; canvas.height = containerHeight;
    const maxCount = words[0][1], minCount = words[words.length - 1][1];
    const colors = ['#0045B5', '#FFD100', '#0068FF', '#00ADFF', '#00266E', '#FFB206', '#00D9B8', '#F04C25', '#00C9A7', '#FF6900'];
    const wordList = words.map(([word, count]) => [word, Math.max(14, Math.min(80, 14 + ((count - minCount) / (maxCount - minCount || 1)) * 66))]);
    wordCloudData = words;
    if (typeof WordCloud !== 'undefined') {
        WordCloud(canvas, { list: wordList, gridSize: Math.round(16 * containerWidth / 1024), weightFactor: 1, fontFamily: 'Montserrat, Inter, sans-serif', fontWeight: 'bold', color: () => colors[Math.floor(Math.random() * colors.length)], rotateRatio: 0.3, rotationSteps: 2, backgroundColor: 'transparent', drawOutOfBound: false, shrinkToFit: true, click: item => { if (item && item[0]) { $('qSearch').value = item[0]; applyAllFilters(); showToast('Filtrando por: "' + item[0] + '"', 'success'); } }, hover: (item) => { canvas.style.cursor = item ? 'pointer' : 'default'; canvas.title = item ? item[0] + ': ' + (wordCloudData.find(w => w[0] === item[0])?.[1] || 0) + ' ocorrências' : ''; } });
    }
    updateWordCloudStats(words, totalDescriptions);
}
function updateWordCloudStats(words, totalDescriptions) {
    const wcTotal = $('wcTotalWords'), wcTop = $('wcTopWord'), wcCount = $('wcTopCount'), wcDesc = $('wcDescCount');
    if (wcTotal) wcTotal.textContent = words.length;
    if (wcDesc) wcDesc.textContent = totalDescriptions;
    if (words.length > 0) { if (wcTop) wcTop.textContent = words[0][0]; if (wcCount) wcCount.textContent = words[0][1]; }
    else { if (wcTop) wcTop.textContent = '-'; if (wcCount) wcCount.textContent = '0'; }
}
function updateWordCloud() { generateWordCloud(); }
function downloadWordCloudImage() {
    const canvas = $('wordCloudCanvas');
    if (!canvas || canvas.style.display === 'none') { showToast('Nenhuma nuvem de palavras para exportar', 'warning'); return; }
    const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d'); tempCtx.fillStyle = '#FFFFFF'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); tempCtx.drawImage(canvas, 0, 0);
    const link = document.createElement('a'); link.download = 'nuvem-palavras-' + moment().format('YYYY-MM-DD') + '.png'; link.href = tempCanvas.toDataURL('image/png'); link.click();
    showToast('Nuvem de palavras exportada!', 'success');
}

const SHEETS_API_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
function openModalInserir() {
    initAllSearchableDropdowns();
    populateModalSelects();
    document.getElementById('formInserirRegistro').reset();
    clearFormValidation();
    if(document.getElementById('insertMotivoInput'))document.getElementById('insertMotivoInput').value='';
    if(document.getElementById('insertGNInput'))document.getElementById('insertGNInput').value='';
    if(document.getElementById('insertSolicitanteInput'))document.getElementById('insertSolicitanteInput').value='';
    document.getElementById('insertDataInicio').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalInserirOverlay').classList.add('show');
    document.getElementById('modalInserirOverlay').setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
}
function closeModalInserir() {
    document.getElementById('modalInserirOverlay').classList.remove('show');
    document.getElementById('modalInserirOverlay').setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
}
function populateModalSelects() {
    if (RAW.length === 0) return;
    const unique = (key) => [...new Set(RAW.map(item => item[key]))].filter(x => (typeof x === 'string' ? x.trim() !== '' : x != null)).sort();
    const fillSelectModal = (id, list) => {
        const sel = document.getElementById(id);
        const currentVal = sel.value;
        const firstOpt = sel.querySelector('option');
        sel.innerHTML = '';
        if (firstOpt) sel.appendChild(firstOpt);
        list.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.innerText = val.length > 50 ? val.substring(0, 50) + '...' : val;
            opt.title = val;
            sel.appendChild(opt);
        });
        if (currentVal) sel.value = currentVal;
    };
    fillSelectModal('insertAnalista', unique('analista'));
    fillSelectModal('insertMotivo', unique('motivo'));
    fillSelectModal('insertSubClassificacao', unique('sub'));
}
function formatCNPJInput(input) {
    let v = input.value.replace(/\D/g, '');
    if (v.length > 14) v = v.slice(0, 14);
    if (v.length > 12) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{1,2})/, '$1.$2.$3/$4-$5');
    else if (v.length > 8) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
    else if (v.length > 5) v = v.replace(/(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
    else if (v.length > 2) v = v.replace(/(\d{2})(\d{1,3})/, '$1.$2');
    input.value = v;
}
document.addEventListener('DOMContentLoaded', function() {
    const cnpjInput = document.getElementById('insertCNPJ');
    if (cnpjInput) cnpjInput.addEventListener('input', function() { formatCNPJInput(this); });
});
function clearFormValidation() {
    document.querySelectorAll('#formInserirRegistro .invalid').forEach(el => el.classList.remove('invalid'));
    document.querySelectorAll('#formInserirRegistro .error-message').forEach(el => el.classList.remove('show'));
}
function validateForm() {
    clearFormValidation();
    let isValid = true;
    const requiredFields = [
        { id: 'insertDataInicio', type: 'date' },
        { id: 'insertCNPJ', type: 'cnpj' },
        { id: 'insertRazaoSocial', type: 'text' },
        { id: 'insertAnalista', type: 'select' },
        { id: 'insertMotivo', type: 'select' },
        { id: 'insertTipoContato', type: 'select' },
        { id: 'insertOrigemContato', type: 'select' },
        { id: 'insertDescricao', type: 'textarea' },
        { id: 'insertSolicitante', type: 'select' }
    ];
    requiredFields.forEach(field => {
        const el = document.getElementById(field.id);
        let valid = true;
        if (field.type === 'cnpj') {
            const cnpjClean = el.value.replace(/\D/g, '');
            valid = cnpjClean.length === 14;
        } else if (field.type === 'select') {
            valid = el.value !== '';
        } else {
            valid = el.value.trim() !== '';
        }
        if (!valid) {
            isValid = false;
            el.classList.add('invalid');
            const errorMsg = el.parentElement.querySelector('.error-message');
            if (errorMsg) errorMsg.classList.add('show');
        }
    });
    return isValid;
}
async function sendToSharePointAPI(data) {
    const dados = {
        status: data['Data Fim'] ? 'Concluído' : 'Em Aberto',
        dataInicio: data['Data Inicio'],
        dataFim: data['Data Fim'] || null,
        analista: data['Analista'] || '',
        motivo: data['Motivo'] || '',
        subClassificacao: data['Sub Classificação'] || 'Geral',
        cnpj: data['CNPJ'] || '',
        razaoSocial: data['Razão Social'] || '',
        tipoAtendimento: data['Tipo de contato'] || '',
        origemContato: data['Origem do contato'] || '',
        gn: data['GN'] || '',
        solicitante: data['Solicitante'] || '',
        areaResponsavelResolucao: data['Área Responsável Resolução'] || '',
        detalhes: data['Descrição'] || ''
    };
    return await enviarParaPowerAutomate('INSERT', dados, null);
}
async function submitNovoRegistro() {
    if (!validateForm()) { 
        showToast('Preencha todos os campos obrigatórios.', 'error'); 
        return; 
    }

    var btn = document.getElementById('btnSubmitRegistro');
    var originalText = btn.innerHTML;
    btn.classList.add('loading'); 
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gravando...';

    try {
        var dataFimVal = document.getElementById('insertDataFim').value;
        var dataInicioVal = document.getElementById('insertDataInicio').value;

        // PAYLOAD COM ACAO COMO PRIMEIRA PROPRIEDADE
        var payload = {
            "acao": "INSERT",
            "id_registro": null,
            "status": dataFimVal ? "Concluído" : "Em Aberto",
            "dataInicio": dataInicioVal || null,
            "dataFim": dataFimVal || null,
            "fcr": document.getElementById('insertFCR') ? document.getElementById('insertFCR').value : "Não",
            "analista": document.getElementById('insertAnalista').value || null,
            "motivo": document.getElementById('insertMotivo').value || null,
            "subClassificacao": document.getElementById('insertSubClassificacao').value || "Geral",
            "cnpj": document.getElementById('insertCNPJ').value.replace(/\D/g, '') || null,
            "razaoSocial": document.getElementById('insertRazaoSocial').value.trim() || null,
            "tipoAtendimento": document.getElementById('insertTipoContato').value || null,
            "origemContato": document.getElementById('insertOrigemContato').value || null,
            "gn": document.getElementById('insertGN') ? document.getElementById('insertGN').value : null,
            "solicitante": document.getElementById('insertSolicitante') ? document.getElementById('insertSolicitante').value : null,
            "areaResponsavelResolucao": document.getElementById('insertAreaResponsavel') ? document.getElementById('insertAreaResponsavel').value : null,
            "detalhes": document.getElementById('insertDescricao').value.trim() || null
        };

        console.log('>>> ENVIANDO INSERT:', JSON.stringify(payload, null, 2));

        var response = await fetch(POWER_AUTOMATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        console.log('>>> Response Status:', response.status);

        if (response.ok) {
            addRegistroToLocalData({
                'Data Inicio': payload.dataInicio, 
                'Data Fim': payload.dataFim, 
                'CNPJ': payload.cnpj,
                'Razão Social': payload.razaoSocial, 
                'Analista': payload.analista, 
                'Motivo': payload.motivo, 
                'Sub Classificação': payload.subClassificacao,
                'GN': payload.gn, 
                'Solicitante': payload.solicitante, 
                'Tipo de contato': payload.tipoAtendimento, 
                'Origem do contato': payload.origemContato,
                'FCR': payload.fcr, 
                'Descrição': payload.detalhes, 
                'Área Responsável Resolução': payload.areaResponsavelResolucao
            });

            showToast('Registro inserido com sucesso!', 'success');
            closeModalInserir();
            setTimeout(function() { 
                if (window.chamarApi) chamarApi();
                applyAllFilters(); 
            }, 500);
        } else {
            var erroTxt = await response.text();
            throw new Error('Erro ' + response.status + ': ' + erroTxt);
        }

    } catch (error) {
        console.error('>>> Erro no INSERT:', error);
        showToast('Erro ao inserir: ' + error.message, 'error');
    } finally {
        btn.classList.remove('loading'); 
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function addRegistroToLocalData(formData) {
    const excelDateToJS = (dateStr) => {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    };
    const dataInicioObj = excelDateToJS(formData['Data Inicio']);
    const dataFimObj = formData['Data Fim'] ? excelDateToJS(formData['Data Fim']) : null;
    let statusNorm = "Aberto";
    if (dataFimObj && !isNaN(dataFimObj.getTime())) statusNorm = "Fechado";
    let tempoResolucaoDias = null;
    let tempoResolucaoFormatado = "-";
    if (dataInicioObj && dataFimObj && statusNorm === "Fechado") {
        const diffMs = dataFimObj.getTime() - dataInicioObj.getTime();
        const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        tempoResolucaoDias = diffDias === 0 ? 1 : diffDias;
        tempoResolucaoFormatado = tempoResolucaoDias + " dia" + (tempoResolucaoDias > 1 ? "s" : "");
    }
    let cnpjFormatted = formData['CNPJ'];
    if (cnpjFormatted.length === 14) {
        cnpjFormatted = cnpjFormatted.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
    }
    const newRecord = {
        uid: RAW.length,
        status: statusNorm === "Fechado" ? "Concluído" : "Em Aberto",
        statusNorm: statusNorm,
        dtStart: dataInicioObj,
        dtEnd: dataFimObj,
        fcr: formData['FCR'] || 'Não',
        analista: formData['Analista'],
        motivo: formData['Motivo'],
        sub: formData['Sub Classificação'],
        solicitante: formData['Razão Social'],
        descricao: formData['Descrição'],
        cnpj: formData['CNPJ'],
        cnpjFormatted: cnpjFormatted,
        tipoContato: formData['Tipo de contato'],
        origemContato: formData['Origem do contato'],
        tempoResolucaoDias: tempoResolucaoDias,
        tempoResolucaoFormatado: tempoResolucaoFormatado,
        gn: formData['GN'] || '',
            areaResponsavelResolucao: formData['Área Responsável Resolução'] || '',
        created_at: formData['created_at'],
        created_by: formData['created_by'],
        source: formData['source']
    };
    RAW.push(newRecord);
    FILTERED = [...RAW];
    populateFilters();
}
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalInserirOverlay').classList.contains('show')) {
        closeModalInserir();
    }
});
document.getElementById('modalInserirOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) closeModalInserir();
});

// ===== TIMECOMPARE ENGINE =====
const TimeCompare = {
    enabled: false,
    preset: null,
    previousData: [],

    // Ativar comparação
    toggle() {
        this.enabled = !this.enabled;
        document.getElementById('compareToggle')?.classList.toggle('show', this.enabled);
        document.getElementById('btnCompare')?.classList.toggle('active', this.enabled);

        if (!this.enabled) {
            document.getElementById('compareSummary')?.classList.remove('show');
            document.querySelectorAll('.compare-preset').forEach(p => p.classList.remove('active'));
        }
    },

    disable() {
        this.enabled = false;
        this.preset = null;
        document.getElementById('compareToggle')?.classList.remove('show');
        document.getElementById('compareSummary')?.classList.remove('show');
        document.getElementById('btnCompare')?.classList.remove('active');
    },

    // Definir preset
    setPreset(preset) {
        this.preset = preset;
        document.querySelectorAll('.compare-preset').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');

        // Calcula período anterior baseado nos filtros atuais
        const startEl = document.getElementById('dateStart');
        const endEl = document.getElementById('dateEnd');
        if (!startEl?.value || !endEl?.value) {
            showToast('Selecione um período primeiro', 'warning');
            return;
        }

        const start = new Date(startEl.value);
        const end = new Date(endEl.value);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

        let offsetDays;
        switch(preset) {
            case '7d': offsetDays = 7; break;
            case '14d': offsetDays = 14; break;
            case '30d': offsetDays = 30; break;
            default: offsetDays = days; // mesmo intervalo antes
        }

        // Filtra dados do período anterior
        const prevStart = new Date(start);
        prevStart.setDate(prevStart.getDate() - offsetDays);
        const prevEnd = new Date(end);
        prevEnd.setDate(prevEnd.getDate() - offsetDays);

        this.previousData = RAW.filter(r => {
            if (!r.dtStart) return false;
            const d = new Date(r.dtStart);
            return d >= prevStart && d <= prevEnd;
        });

        // Atualiza badge
        const badge = document.getElementById('comparePeriodBadge');
        if (badge) badge.textContent = `vs ${offsetDays} dias antes`;

        this.render();
    },

    // Calcula métricas de um dataset
    calculateMetrics(data) {
        if (!data || data.length === 0) return null;

        const total = data.length;
        const open = data.filter(r => r.statusNorm === 'Aberto').length;
        const closed = data.filter(r => r.statusNorm === 'Concluído').length;

        const fcrTotal = data.filter(r => r.fcr === 'Sim' || r.fcr === 'Não').length;
        const fcrSim = data.filter(r => r.fcr === 'Sim').length;
        const fcr = fcrTotal > 0 ? (fcrSim / fcrTotal * 100) : 0;

        const completed = data.filter(r => r.statusNorm === 'Concluído' && r.tempoResolucao != null);
        const avgTime = completed.length > 0 ? completed.reduce((a, b) => a + b.tempoResolucao, 0) / completed.length : 0;

        const hoje = new Date();
        const backlog = data.filter(r => {
            if (r.statusNorm !== 'Aberto' || !r.dtStart) return false;
            return Math.floor((hoje - new Date(r.dtStart)) / (1000 * 60 * 60 * 24)) > 3;
        }).length;

        return { total, open, closed, fcr, avgTime, backlog };
    },

    // Calcula delta
    calcDelta(current, previous, inverse = false) {
        if (!previous || previous === 0) return { value: 0, pct: 0, status: 'neutral' };
        const diff = current - previous;
        const pct = (diff / previous) * 100;
        let status = 'neutral';
        if (Math.abs(pct) > 5) {
            if (inverse) status = diff < 0 ? 'positive' : 'negative';
            else status = diff > 0 ? 'positive' : 'negative';
        }
        return { value: diff, pct, status };
    },

    // Gera sparkline (últimos 7 dias de tendência)
    generateSparkline(data, field) {
        const days = {};
        data.forEach(r => {
            if (!r.dtStart) return;
            const day = new Date(r.dtStart).toDateString();
            days[day] = (days[day] || 0) + 1;
        });
        const values = Object.values(days).slice(-7);
        if (values.length === 0) return '';
        const max = Math.max(...values, 1);
        return values.map((v, i) => 
            `<div class="sparkline-bar" style="height:${Math.max(10, (v/max)*100)}%"></div>`
        ).join('');
    },

    // Renderiza comparação
    render() {
        const summary = document.getElementById('compareSummary');
        const grid = document.getElementById('compareGrid');
        const evolution = document.getElementById('evolutionScore');

        if (!summary || !FILTERED || FILTERED.length === 0) return;

        const current = this.calculateMetrics(FILTERED);
        const previous = this.calculateMetrics(this.previousData);

        if (!current) return;

        const metrics = [
            { key: 'total', label: 'Total', current: current.total, previous: previous?.total || 0, inverse: false },
            { key: 'open', label: 'Pendentes', current: current.open, previous: previous?.open || 0, inverse: true },
            { key: 'fcr', label: 'FCR', current: current.fcr, previous: previous?.fcr || 0, inverse: false, suffix: '%', decimals: 0 },
            { key: 'avgTime', label: 'Tempo Médio', current: current.avgTime, previous: previous?.avgTime || 0, inverse: true, suffix: 'd', decimals: 1 },
            { key: 'backlog', label: 'Backlog +3d', current: current.backlog, previous: previous?.backlog || 0, inverse: true }
        ];

        let improving = 0, worsening = 0;

        grid.innerHTML = metrics.map(m => {
            const delta = this.calcDelta(m.current, m.previous, m.inverse);
            if (delta.status === 'positive') improving++;
            if (delta.status === 'negative') worsening++;

            const currentVal = m.decimals ? m.current.toFixed(m.decimals) : Math.round(m.current);
            const prevVal = m.decimals ? m.previous.toFixed(m.decimals) : Math.round(m.previous);
            const deltaSign = delta.value >= 0 ? '+' : '';
            const deltaVal = m.decimals ? delta.value.toFixed(m.decimals) : Math.round(delta.value);

            return `
                <div class="compare-card">
                    <div class="compare-card-header">
                        <div class="compare-card-label">${m.label}</div>
                        <div class="compare-card-delta ${delta.status}">${deltaSign}${delta.pct.toFixed(0)}%</div>
                    </div>
                    <div class="compare-card-values">
                        <div class="compare-card-current">${currentVal}${m.suffix || ''}</div>
                        <div class="compare-card-previous">vs ${prevVal}${m.suffix || ''}</div>
                    </div>
                    <div class="sparkline-container">${this.generateSparkline(FILTERED, m.key)}</div>
                </div>
            `;
        }).join('');

        // Evolution score
        const stable = metrics.length - improving - worsening;
        evolution.innerHTML = `
            <div class="evolution-item">
                <div class="evolution-icon improving"><i class="fa-solid fa-arrow-up"></i></div>
                <span class="evolution-count">${improving}</span>
                <span class="evolution-label">Melhorando</span>
            </div>
            <div class="evolution-item">
                <div class="evolution-icon worsening"><i class="fa-solid fa-arrow-down"></i></div>
                <span class="evolution-count">${worsening}</span>
                <span class="evolution-label">Piorando</span>
            </div>
            <div class="evolution-item">
                <div class="evolution-icon stable"><i class="fa-solid fa-minus"></i></div>
                <span class="evolution-count">${stable}</span>
                <span class="evolution-label">Estável</span>
            </div>
        `;

        summary.classList.add('show');
    }
};

// ===== ALERT MANAGER =====
const AlertManager = {
    alerts: [],
    cooldowns: {},

    add(config) {
        const { id, severity, title, message } = config;
        if (this.cooldowns[id] && Date.now() - this.cooldowns[id] < 60000) return;
        const existing = this.alerts.find(a => a.id === id);
        if (existing) { existing.count = (existing.count || 1) + 1; this.render(); return; }
        this.alerts.push({ id, severity, title, message, count: 1, time: Date.now() });
        this.cooldowns[id] = Date.now();
        if (this.alerts.length > 3) this.alerts.shift();
        this.render();
    },

    dismiss(id) {
        const el = document.querySelector(`[data-alert-id="${id}"]`);
        if (el) el.classList.add('dismissing');
        setTimeout(() => { this.alerts = this.alerts.filter(a => a.id !== id); this.render(); }, 300);
    },

    render() {
        const container = document.getElementById('alertCenter');
        if (!container) return;
        container.innerHTML = this.alerts.map(a => `
            <div class="alert-item severity-${a.severity}" data-alert-id="${a.id}">
                <div class="alert-item-header">
                    <div class="alert-icon"><i class="fa-solid ${a.severity === 'critical' ? 'fa-exclamation' : 'fa-triangle-exclamation'}"></i></div>
                    <div class="alert-title">${a.title}${a.count > 1 ? ` (${a.count}x)` : ''}</div>
                    <button class="alert-close" onclick="AlertManager.dismiss('${a.id}')"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="alert-body">${a.message}</div>
            </div>
        `).join('');
    }
};

// ===== ANNOTATIONS =====
const Annotations = {
    load() { try { return JSON.parse(localStorage.getItem('consolida_annotations')) || []; } catch { return []; } },
    save(list) { localStorage.setItem('consolida_annotations', JSON.stringify(list)); },
    add(text, type) {
        const list = this.load();
        list.unshift({ id: Date.now(), text, type, date: new Date().toISOString() });
        if (list.length > 20) list.pop();
        this.save(list);
        this.render();
    },
    delete(id) { this.save(this.load().filter(a => a.id !== id)); this.render(); },
    render() {
        const container = document.getElementById('annotationsList');
        if (!container) return;
        const list = this.load();
        container.innerHTML = list.length === 0 ? '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px;">Nenhuma anotação</div>'
            : list.slice(0, 5).map(a => `<div class="annotation-item"><div class="annotation-marker ${a.type}"></div><div style="flex:1;color:var(--text-secondary);">${a.text}<div style="font-size:10px;color:var(--text-muted);margin-top:4px;">${new Date(a.date).toLocaleDateString('pt-BR')}</div></div></div>`).join('');
    }
};

function addAnnotation() {
    const text = document.getElementById('annotationText')?.value?.trim();
    const type = document.getElementById('annotationType')?.value || 'note';
    if (!text) { showToast('Digite uma anotação', 'warning'); return; }
    Annotations.add(text, type);
    document.getElementById('annotationText').value = '';
    showToast('Anotação adicionada', 'success');
}
function toggleAnnotations() { document.getElementById('annotationsPanel')?.classList.toggle('show'); Annotations.render(); }

// ===== SIMULATION =====
const Simulation = {
    baseMetrics: null,
    init(data) {
        if (!data || data.length === 0) return;
        const completed = data.filter(r => r.statusNorm === 'Concluído' && r.tempoResolucao != null);
        const fcrT = data.filter(r => r.fcr === 'Sim' || r.fcr === 'Não').length;
        const fcrS = data.filter(r => r.fcr === 'Sim').length;
        this.baseMetrics = {
            backlog: data.filter(r => r.statusNorm === 'Aberto').length,
            avgTime: completed.length > 0 ? completed.reduce((a, b) => a + b.tempoResolucao, 0) / completed.length : 0,
            fcr: fcrT > 0 ? (fcrS / fcrT * 100) : 0,
            dailyCapacity: 5
        };
    },
    update() {
        if (!this.baseMetrics) return;
        const backlogRed = parseInt(document.getElementById('simBacklog')?.value || 0);
        const fcrInc = parseInt(document.getElementById('simFCR')?.value || 0);
        const timeRed = parseInt(document.getElementById('simTime')?.value || 0);
        document.getElementById('simBacklogValue').textContent = '-' + backlogRed + '%';
        document.getElementById('simFCRValue').textContent = '+' + fcrInc + '%';
        document.getElementById('simTimeValue').textContent = '-' + timeRed + '%';
        const newBacklog = Math.round(this.baseMetrics.backlog * (1 - backlogRed/100));
        const newFCR = Math.min(100, this.baseMetrics.fcr + fcrInc);
        const newTime = this.baseMetrics.avgTime * (1 - timeRed/100);
        const days = newBacklog > 0 ? Math.ceil(newBacklog / this.baseMetrics.dailyCapacity) : 0;
        const eff = Math.round((100 - (newBacklog / Math.max(1, this.baseMetrics.backlog) * 30)) + (newFCR / 100 * 40) + ((5 - Math.min(5, newTime)) / 5 * 30));
        const elB = document.getElementById('simResBacklog'); if (elB) { elB.textContent = days + 'd'; elB.className = 'simulation-result-value' + (days < 5 ? ' improved' : ''); }
        const elF = document.getElementById('simResFCR'); if (elF) { elF.textContent = newFCR.toFixed(0) + '%'; elF.className = 'simulation-result-value' + (newFCR >= 70 ? ' improved' : ''); }
        const elT = document.getElementById('simResTime'); if (elT) { elT.textContent = newTime.toFixed(1) + 'd'; elT.className = 'simulation-result-value' + (newTime <= 2 ? ' improved' : ''); }
        const elE = document.getElementById('simResEfficiency'); if (elE) { elE.textContent = eff + '%'; elE.className = 'simulation-result-value' + (eff >= 70 ? ' improved' : ''); }
    }
};
function toggleSimulation() { document.getElementById('simulationPanel')?.classList.toggle('show'); }
function updateSimulation() { Simulation.update(); }

// ===== EFFICIENCY ENGINE =====
const EfficiencyEngine = {
    render(data) {
        const panel = document.getElementById('efficiencyPanel');
        const grid = document.getElementById('efficiencyGrid');
        if (!panel || !data || data.length === 0) { if (panel) panel.classList.remove('show'); return; }
        const completed = data.filter(r => r.statusNorm === 'Concluído' && r.tempoResolucao != null);
        const avgTime = completed.length > 0 ? completed.reduce((a, b) => a + b.tempoResolucao, 0) / completed.length : 0;
        const sameDayPct = completed.length > 0 ? (completed.filter(r => r.tempoResolucao === 0).length / completed.length * 100) : 0;
        const hoje = new Date();
        const backlog = data.filter(r => r.statusNorm === 'Aberto' && r.dtStart && Math.floor((hoje - new Date(r.dtStart))/(1000*60*60*24)) > 3).length;
        const abertos = data.filter(r => r.statusNorm === 'Aberto').length;
        const daysToClean = abertos > 0 ? Math.ceil(abertos / 5) : 0;
        const st = (v, g, b) => v <= g ? 'good' : v >= b ? 'bad' : 'warning';
        const lb = s => s === 'good' ? 'BOM' : s === 'warning' ? 'ATENÇÃO' : 'CRÍTICO';
        grid.innerHTML = `
            <div class="efficiency-card"><div class="efficiency-card-header"><div class="efficiency-card-icon speed"><i class="fa-solid fa-gauge"></i></div><span class="efficiency-card-badge ${st(avgTime,2,5)}">${lb(st(avgTime,2,5))}</span></div><div class="efficiency-card-value">${avgTime.toFixed(1)}d</div><div class="efficiency-card-label">Tempo Médio</div></div>
            <div class="efficiency-card"><div class="efficiency-card-header"><div class="efficiency-card-icon sameday"><i class="fa-solid fa-bolt"></i></div><span class="efficiency-card-badge ${st(100-sameDayPct,70,85)}">${lb(st(100-sameDayPct,70,85))}</span></div><div class="efficiency-card-value">${sameDayPct.toFixed(0)}%</div><div class="efficiency-card-label">Mesmo Dia</div></div>
            <div class="efficiency-card"><div class="efficiency-card-header"><div class="efficiency-card-icon backlog"><i class="fa-solid fa-layer-group"></i></div><span class="efficiency-card-badge ${st(backlog,0,5)}">${lb(st(backlog,0,5))}</span></div><div class="efficiency-card-value">${backlog}</div><div class="efficiency-card-label">Backlog +3d</div></div>
            <div class="efficiency-card"><div class="efficiency-card-header"><div class="efficiency-card-icon capacity"><i class="fa-solid fa-calendar-check"></i></div><span class="efficiency-card-badge ${st(daysToClean,3,10)}">${lb(st(daysToClean,3,10))}</span></div><div class="efficiency-card-value">${daysToClean > 30 ? '30+' : daysToClean}d</div><div class="efficiency-card-label">Dias p/ Zerar</div></div>
        `;
        panel.classList.add('show');
    }
};

// ===== EXPORT =====
let selectedExportType = 'excel';
function openExportModal() { document.getElementById('exportModal')?.classList.add('show'); }
function closeExportModal() { document.getElementById('exportModal')?.classList.remove('show'); }
function selectExportOption(el, type) { document.querySelectorAll('.export-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); selectedExportType = type; }
function executeExport() { closeExportModal(); if (selectedExportType === 'excel' && typeof exportToExcel === 'function') exportToExcel(); else if (selectedExportType === 'pdf') generatePDF(); }
function generatePDF() {
    const w = window.open('', '_blank');
    const s = { total: FILTERED?.length || 0, open: FILTERED?.filter(r => r.statusNorm === 'Aberto').length || 0, closed: FILTERED?.filter(r => r.statusNorm === 'Concluído').length || 0 };
    w.document.write(`<html><head><title>Relatório Executivo</title><style>body{font-family:Arial;padding:40px}h1{color:#2563eb;border-bottom:2px solid #2563eb;padding-bottom:10px}.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:30px 0}.kpi{background:#f8f9fa;padding:20px;border-radius:8px;text-align:center}.kpi-value{font-size:32px;font-weight:bold;color:#2563eb}.kpi-label{font-size:12px;color:#666;margin-top:5px}

/* ===== CORREÇÃO Z-INDEX LEGENDAS v9 - PERMITE CLICAR ===== */
/* Garante que as legendas das roscas fiquem clicáveis */
.card > div[style*="display:flex"][style*="height:300px"],
.card > div[style*="display: flex"][style*="height: 300px"] {
    position: relative;
    z-index: 1;
}

/* Container flex que envolve gráfico + legenda */
.card > div[style*="flex:1"] {
    position: relative;
    z-index: 5;
}

/* Força legendas para frente */
.legend-container {
    position: relative !important;
    z-index: 100 !important;
    pointer-events: auto !important;
}

.legend-item {
    position: relative !important;
    z-index: 101 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
}

.legend-item:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    transform: translateX(3px);
}

/* Centro do doughnut não bloqueia cliques */
.doughnut-center-info {
    pointer-events: none !important;
    z-index: 2 !important;
}

/* Canvas do gráfico */
canvas {
    position: relative;
    z-index: 10;
}

        .btn-ed,.btn-del{width:28px;height:28px;border:none;border-radius:6px;cursor:pointer;font-size:14px;transition:transform .2s;}
        .btn-ed{background:#e3f2fd;}.btn-ed:hover{transform:scale(1.2);}
        .btn-del{background:#ffebee;}.btn-del:hover{transform:scale(1.2);}
        #crudModal{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;display:none;place-items:center;}
        #crudModal.vis{display:grid;}
        #crudBox{background:#1e2235;border-radius:16px;padding:0;width:95%;max-width:550px;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.7);}
        #crudHead{padding:16px 20px;background:linear-gradient(135deg,#2a3f5f,#1e2235);border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;}
        #crudHead h3{margin:0;color:#fff;font-size:16px;}
        #crudHead button{background:#333;border:none;color:#aaa;width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;}
        #crudHead button:hover{background:#ff4757;color:#fff;}
        #crudBody{padding:20px;overflow-y:auto;max-height:60vh;}
        #crudFoot{padding:14px 20px;background:#181c2e;display:flex;justify-content:flex-end;gap:10px;}
        .cf{margin-bottom:12px;}.cf label{display:block;color:#888;font-size:11px;margin-bottom:4px;text-transform:uppercase;}
        .cf input,.cf select,.cf textarea{width:100%;padding:10px;border:1px solid #333;border-radius:8px;background:#262d45;color:#fff;font-size:13px;box-sizing:border-box;}
        .cf input:focus,.cf select:focus{outline:none;border-color:#3d8dff;}
        .cfr{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
        .cbtn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;}
        .cbtn-cancel{background:#333;color:#aaa;}.cbtn-cancel:hover{background:#444;color:#fff;}
        .cbtn-save{background:#00c9a7;color:#fff;}.cbtn-save:hover{background:#00b894;}
        .cbtn-del{background:#ff4757;color:#fff;}.cbtn-del:hover{background:#ee3b4b;}
        .cbtn:disabled{opacity:.5;cursor:wait;}
        .delbox{text-align:center;padding:20px;}.delbox .ico{font-size:50px;margin-bottom:15px;}.delbox .msg{color:#fff;font-size:16px;margin-bottom:5px;}.delbox .nm{color:#888;font-size:14px;}.delbox .idtag{display:inline-block;background:#ff475722;color:#ff4757;padding:4px 12px;border-radius:12px;margin:12px 0;font-weight:700;}.delbox .warn{background:#ff475711;color:#ff4757;padding:10px;border-radius:8px;font-size:12px;margin-top:12px;}

</style></head><body><h1>📊 Relatório Executivo - Consolidação</h1><p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p><div class="kpi-grid"><div class="kpi"><div class="kpi-value">${s.total}</div><div class="kpi-label">Total</div></div><div class="kpi"><div class="kpi-value">${s.open}</div><div class="kpi-label">Pendentes</div></div><div class="kpi"><div class="kpi-value">${s.closed}</div><div class="kpi-label">Finalizados</div></div><div class="kpi"><div class="kpi-value">${s.total>0?Math.round(s.closed/s.total*100):0}%</div><div class="kpi-label">Taxa Conclusão</div></div></div><p style="font-size:10px;color:#999;margin-top:40px;">Consolida Ultimate v8.0</p></body></html>`);
    w.document.close(); w.print();
}

// ===== CNPJ =====
async function buscarCNPJ() {
    const btn = document.getElementById('btnBuscarCNPJ');
    const result = document.getElementById('cnpjResult');
    const info = document.getElementById('cnpjResultInfo');
    const cnpj = document.getElementById('insertCNPJ').value.replace(/\D/g, '');
    if (cnpj.length !== 14) { result.className = 'cnpj-result show error'; info.innerHTML = 'CNPJ inválido'; return; }
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>';
    try {
        const res = await fetch('https://brasilapi.com.br/api/cnpj/v1/' + cnpj);
        if (res.ok) {
            const d = await res.json();
            document.getElementById('insertRazaoSocial').value = d.razao_social || '';
            result.className = 'cnpj-result show';
            info.innerHTML = '<strong>' + d.razao_social + '</strong><br><small>' + (d.municipio||'') + '/' + (d.uf||'') + '</small>';
            showToast('Empresa encontrada!', 'success');
        } else throw new Error();
    } catch { result.className = 'cnpj-result show error'; info.innerHTML = 'Não encontrado'; }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-search"></i> Buscar'; }
}

// ===== STORYTELLING =====
const StorytellingEngine = {
    run(raw, filtered) {
        if (!filtered || filtered.length === 0) return;
        document.getElementById('auditRecords').textContent = filtered.length;

        // Smart Bar
        const open = filtered.filter(r => r.statusNorm === 'Aberto').length;
        const hoje = new Date();
        const criticos = filtered.filter(r => r.statusNorm === 'Aberto' && r.dtStart && Math.floor((hoje - new Date(r.dtStart))/(1000*60*60*24)) > 3).length;
        const bar = document.getElementById('smartBar');
        if (bar && criticos > 0) {
            document.getElementById('smartBarTitle').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ' + criticos + ' atendimentos críticos (+3 dias)';
            document.getElementById('smartBarDesc').textContent = 'Priorize estes casos imediatamente';
            bar.classList.add('show');
        } else if (bar && open/filtered.length*100 >= 20) {
            document.getElementById('smartBarTitle').innerHTML = '<i class="fa-solid fa-layer-group"></i> Alta taxa pendente: ' + (open/filtered.length*100).toFixed(0) + '%';
            document.getElementById('smartBarDesc').textContent = open + ' atendimentos aguardando';
            bar.classList.add('show');
        } else if (bar) bar.classList.remove('show');

        // Alerts
        if (criticos > 0) AlertManager.add({ id: 'criticos', severity: 'critical', title: 'Casos Críticos', message: criticos + ' atendimentos parados há mais de 3 dias' });

        // Efficiency
        EfficiencyEngine.render(filtered);

        // Simulation
        Simulation.init(filtered);

        // TimeCompare
        if (TimeCompare.enabled && TimeCompare.preset) TimeCompare.render();
    }
};

function dismissSmartBar() { document.getElementById('smartBar')?.classList.remove('show'); }

// SEARCHABLE DROPDOWN FUNCTIONS
const GN_OPTIONS=["G.N. Urbano Ribeirao Preto","G.N. Rodovia Ribeirao Preto","G.N. Urbano Sp Oeste","G.N. Urbano Rio De Janeiro","G.N. Rodovia Curitiba","G.N. Urbano Florianopolis","G.N. Urbano Londrina","G.N. Urbano Campinas","G.N. Rodovia Goiania","G.N. Urbano Sp Abc","G.N. Urbano Passo Fundo","G.N. Urbano Porto Alegre","G.N. Urbano Sao Jose Rio Preto","G.N. Rodovia Rio De Janeiro","G.N. Urbano Curitiba","G.N. Urbano Uberlandia","G.N. Urbano Goiania","G.N. Urbano Belo Horizonte","G.N. Urbano Sp Leste","G.N. Urbano Campo Grande","G.N. Urbano Recife","G.N. Urbano Vitoria","G.N. Urbano Fortaleza","G.N. Urbano Sao Luis","G.N. Urbano Belem","G.N. Urbano Santa Maria","G.N. Urbano Manaus","G.N. Hipermercado"];
const SOLICITANTE_OPTIONS=["Revendedor","CT","CN","Torre","Automação"];

function initSearchableDropdown(inputId,hiddenId,listId,options){
    const input=document.getElementById(inputId),hidden=document.getElementById(hiddenId),list=document.getElementById(listId);
    if(!input||!hidden||!list)return;
    let hlIdx=-1;
    function render(filter=''){
        const items=options.filter(o=>o.toLowerCase().includes(filter.toLowerCase()));
        list.innerHTML=items.length===0?'<div class="searchable-dropdown-empty">Nenhum resultado</div>':items.map(o=>`<div class="searchable-dropdown-item${hidden.value===o?' selected':''}" data-value="${o}">${o}</div>`).join('');
        hlIdx=-1;
        list.querySelectorAll('.searchable-dropdown-item').forEach((el,i)=>{el.onclick=()=>select(el.dataset.value);el.onmouseenter=()=>{hlIdx=i;updateHL();}});
    }
    function select(v){hidden.value=v;input.value=v;list.classList.remove('show');input.classList.remove('invalid');}
    function updateHL(){list.querySelectorAll('.searchable-dropdown-item').forEach((el,i)=>el.classList.toggle('highlighted',i===hlIdx));}
    input.onfocus=()=>{render(input.value);list.classList.add('show');};
    input.oninput=()=>{render(input.value);list.classList.add('show');if(input.value==='')hidden.value='';};
    input.onkeydown=e=>{
        const items=list.querySelectorAll('.searchable-dropdown-item');
        if(e.key==='ArrowDown'){e.preventDefault();hlIdx=Math.min(hlIdx+1,items.length-1);updateHL();if(items[hlIdx])items[hlIdx].scrollIntoView({block:'nearest'});}
        else if(e.key==='ArrowUp'){e.preventDefault();hlIdx=Math.max(hlIdx-1,0);updateHL();if(items[hlIdx])items[hlIdx].scrollIntoView({block:'nearest'});}
        else if(e.key==='Enter'){e.preventDefault();if(hlIdx>=0&&items[hlIdx])select(items[hlIdx].dataset.value);}
        else if(e.key==='Escape')list.classList.remove('show');
    };
    document.addEventListener('click',e=>{if(!input.contains(e.target)&&!list.contains(e.target))list.classList.remove('show');});
    render();
}

function initMotivoSearchableDropdown(){
    const input=document.getElementById('insertMotivoInput'),hidden=document.getElementById('insertMotivo'),list=document.getElementById('motivoDropdownList');
    if(!input||!hidden||!list)return;
    const motivos=[...new Set(RAW.map(r=>r.motivo).filter(m=>m&&m!=='Outros'))].sort();
    if(motivos.length===0)motivos.push('Outros');
    let hlIdx=-1;
    function render(filter=''){
        const items=motivos.filter(o=>o.toLowerCase().includes(filter.toLowerCase()));
        list.innerHTML=items.length===0?'<div class="searchable-dropdown-empty">Nenhum motivo</div>':items.map(o=>`<div class="searchable-dropdown-item${hidden.value===o?' selected':''}" data-value="${o}">${o}</div>`).join('');
        hlIdx=-1;
        list.querySelectorAll('.searchable-dropdown-item').forEach((el,i)=>{el.onclick=()=>select(el.dataset.value);el.onmouseenter=()=>{hlIdx=i;updateHL();}});
    }
    function select(v){hidden.value=v;input.value=v;list.classList.remove('show');input.classList.remove('invalid');}
    function updateHL(){list.querySelectorAll('.searchable-dropdown-item').forEach((el,i)=>el.classList.toggle('highlighted',i===hlIdx));}
    input.onfocus=()=>{render(input.value);list.classList.add('show');};
    input.oninput=()=>{render(input.value);list.classList.add('show');if(input.value==='')hidden.value='';};
    input.onkeydown=e=>{
        const items=list.querySelectorAll('.searchable-dropdown-item');
        if(e.key==='ArrowDown'){e.preventDefault();hlIdx=Math.min(hlIdx+1,items.length-1);updateHL();if(items[hlIdx])items[hlIdx].scrollIntoView({block:'nearest'});}
        else if(e.key==='ArrowUp'){e.preventDefault();hlIdx=Math.max(hlIdx-1,0);updateHL();if(items[hlIdx])items[hlIdx].scrollIntoView({block:'nearest'});}
        else if(e.key==='Enter'){e.preventDefault();if(hlIdx>=0&&items[hlIdx])select(items[hlIdx].dataset.value);}
        else if(e.key==='Escape')list.classList.remove('show');
    };
    document.addEventListener('click',e=>{if(!input.contains(e.target)&&!list.contains(e.target))list.classList.remove('show');});
    render();
}

function initAllSearchableDropdowns(){
    initSearchableDropdown('insertGNInput','insertGN','gnDropdownList',GN_OPTIONS);
    initSearchableDropdown('insertSolicitanteInput','insertSolicitante','solicitanteDropdownList',SOLICITANTE_OPTIONS);
    initMotivoSearchableDropdown();
}



// ===== API CACHE WITH TTL =====
const APICache = {
    cache: {},

    get(key) {
        const cached = localStorage.getItem(`cache_${key}`);
        if (!cached) return null;

        try {
            const data = JSON.parse(cached);
            const now = Date.now();
            const TTL = 5 * 60 * 1000; // 5 minutes

            if (now - data.timestamp > TTL) {
                localStorage.removeItem(`cache_${key}`);
                return null;
            }
            return data.value;
        } catch (e) {
            localStorage.removeItem(`cache_${key}`);
            return null;
        }
    },

    set(key, value) {
        try {
            localStorage.setItem(`cache_${key}`, JSON.stringify({
                value: value,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.warn('Cache storage full or disabled:', e);
        }
    },

    clear(key) {
        localStorage.removeItem(`cache_${key}`);
    }
};

// ===== ANNOTATIONS MANAGEMENT =====
let annotationsData = {};

async function loadAnnotationsFromAPI() {
    const cacheKey = 'annotations_data';
    const cached = APICache.get(cacheKey);

    if (cached) {
        annotationsData = cached;
        console.log('Loaded annotations from cache');
        return cached;
    }

    try {
        // Assuming API endpoint exists - adjust as needed
        const response = await fetch('/api/observacoes');
        if (response.ok) {
            const data = await response.json();
            annotationsData = data;
            APICache.set(cacheKey, data);
            console.log('Loaded annotations from API');
            return data;
        }
    } catch (e) {
        console.log('API unavailable, using cached data:', e);
    }

    return annotationsData;
}

async function saveAnnotationToAPI(field, value) {
    try {
        const response = await fetch('/api/observacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field, value })
        });

        if (response.ok) {
            APICache.clear('annotations_data');
            await loadAnnotationsFromAPI();
            return true;
        }
    } catch (e) {
        console.warn('Failed to save annotation:', e);
    }
    return false;
}

// Load annotations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAnnotationsFromAPI().then(() => {
        console.log('Annotations loaded on page initialization');
    });
});



// Enhanced annotation persistence
function getAnnotationsText() {
    const annotationsPanel = document.getElementById('annotationsPanel');
    if (annotationsPanel) {
        const textarea = annotationsPanel.querySelector('textarea');
        return textarea ? textarea.value : '';
    }
    return '';
}

function setAnnotationsText(text) {
    const annotationsPanel = document.getElementById('annotationsPanel');
    if (annotationsPanel) {
        const textarea = annotationsPanel.querySelector('textarea');
        if (textarea) {
            textarea.value = text;
        }
    }
}

// Override or enhance the existing toggleAnnotations to persist
const originalToggleAnnotations = window.toggleAnnotations;
window.toggleAnnotations = function() {
    if (originalToggleAnnotations) {
        originalToggleAnnotations.apply(this, arguments);
    }

    // Ensure textarea has change listener for persistence
    setTimeout(() => {
        const textarea = document.querySelector('#annotationsPanel textarea');
        if (textarea && !textarea.hasAttribute('data-persistence-enabled')) {
            textarea.setAttribute('data-persistence-enabled', 'true');
            textarea.addEventListener('blur', async function() {
                const value = this.value;
                annotationsData.observacoes = value;
                await saveAnnotationToAPI('observacoes', value);
                console.log('Annotations saved');
            });
        }
    }, 100);
};

// Load saved annotations on panel open
const observeAnnotationsPanel = new MutationObserver(() => {
    const panel = document.getElementById('annotationsPanel');
    if (panel && panel.style.display !== 'none') {
        const textarea = panel.querySelector('textarea');
        if (textarea && annotationsData.observacoes) {
            textarea.value = annotationsData.observacoes;
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const main = document.querySelector('main') || document.body;
    if (main) {
        observeAnnotationsPanel.observe(main, { 
            childList: true, 
            subtree: true, 
            attributes: true, 
            attributeFilter: ['style', 'class'] 
        });
    }
});


// ======== CRUD SHAREPOINT ========
(function(){

    var currentId = null;

    // =====================================================================
    // FUNÇÃO BUSCAR - VERSÃO ROBUSTA
    // Procura por: id, ID, Id, uid - com conversão para número
    // =====================================================================
    function buscar(id) {
        console.log('>>> buscar() chamada com id:', id, 'tipo:', typeof id);

        var n = parseInt(id);
        console.log('>>> ID parseado:', n);

        if (isNaN(n)) {
            console.log('>>> ID inválido (NaN)');
            return null;
        }

        var arr = window.RAW || [];
        console.log('>>> RAW tem', arr.length, 'registros');

        // Mostrar os primeiros registros para debug
        if (arr.length > 0) {
            console.log('>>> Exemplo de registro:', JSON.stringify(arr[0]).substring(0, 200));
            console.log('>>> Campos do primeiro registro:', Object.keys(arr[0]));
        }

        // Tentar encontrar por vários campos possíveis
        for (var i = 0; i < arr.length; i++) {
            var item = arr[i];

            // Tentar campo 'id'
            if (item.id !== null && item.id !== undefined) {
                if (parseInt(item.id) === n) {
                    console.log('>>> ENCONTRADO por item.id em RAW[' + i + ']');
                    return item;
                }
            }

            // Tentar campo 'ID' (maiúsculo)
            if (item.ID !== null && item.ID !== undefined) {
                if (parseInt(item.ID) === n) {
                    console.log('>>> ENCONTRADO por item.ID em RAW[' + i + ']');
                    return item;
                }
            }

            // Tentar campo 'Id'
            if (item.Id !== null && item.Id !== undefined) {
                if (parseInt(item.Id) === n) {
                    console.log('>>> ENCONTRADO por item.Id em RAW[' + i + ']');
                    return item;
                }
            }

            // Tentar campo 'uid'
            if (item.uid !== null && item.uid !== undefined) {
                if (parseInt(item.uid) === n) {
                    console.log('>>> ENCONTRADO por item.uid em RAW[' + i + ']');
                    return item;
                }
            }
        }

        // Tentar em FILTERED também
        arr = window.FILTERED || [];
        console.log('>>> FILTERED tem', arr.length, 'registros');

        for (var i = 0; i < arr.length; i++) {
            var item = arr[i];

            if (item.id !== null && item.id !== undefined && parseInt(item.id) === n) {
                console.log('>>> ENCONTRADO por item.id em FILTERED[' + i + ']');
                return item;
            }
            if (item.ID !== null && item.ID !== undefined && parseInt(item.ID) === n) {
                console.log('>>> ENCONTRADO por item.ID em FILTERED[' + i + ']');
                return item;
            }
            if (item.Id !== null && item.Id !== undefined && parseInt(item.Id) === n) {
                console.log('>>> ENCONTRADO por item.Id em FILTERED[' + i + ']');
                return item;
            }
            if (item.uid !== null && item.uid !== undefined && parseInt(item.uid) === n) {
                console.log('>>> ENCONTRADO por item.uid em FILTERED[' + i + ']');
                return item;
            }
        }

        console.log('>>> NÃO ENCONTRADO em nenhum array');
        return null;
    }

    function fmtDt(d) {
        if (!d) return '';
        try { return new Date(d).toISOString().split('T')[0]; } catch(e) { return ''; }
    }

    function abrir() {
        document.getElementById('crudModal').classList.add('vis');
        document.body.style.overflow = 'hidden';
    }

    window.fecharCrud = function() {
        document.getElementById('crudModal').classList.remove('vis');
        document.body.style.overflow = '';
        currentId = null;
    };

    // =====================================================================
    // EDITAR REGISTRO
    // =====================================================================
    window.editarReg = function(id, evt) {
        if (evt) { evt.preventDefault(); evt.stopPropagation(); }

        console.log('========================================');
        console.log('EDITAR clicado, ID recebido:', id, 'tipo:', typeof id);
        console.log('========================================');

        currentId = parseInt(id);
        console.log('currentId após parseInt:', currentId);

        if (isNaN(currentId)) { 
            alert('ID inválido: ' + id); 
            return; 
        }

        var item = buscar(currentId);

        if (!item) { 
            // Tentar buscar pelo índice da tabela (pode ser que o ID na tabela seja o índice)
            console.log('>>> Tentando buscar por índice direto...');
            var arr = window.FILTERED || window.RAW || [];
            if (arr[currentId]) {
                item = arr[currentId];
                console.log('>>> ENCONTRADO por índice direto');
            }
        }

        if (!item) { 
            alert('Registro não encontrado para ID: ' + id + '\n\nVerifique o console (F12) para mais detalhes.');
            console.log('>>> RAW:', window.RAW ? window.RAW.length : 0, 'registros');
            console.log('>>> FILTERED:', window.FILTERED ? window.FILTERED.length : 0, 'registros');
            return; 
        }

        console.log('>>> Item encontrado:', item);

        var motivos = '';
        try {
            var ms = [...new Set((window.RAW||[]).map(function(r){return r.motivo}).filter(Boolean))].sort();
            ms.forEach(function(m){ motivos += '<option '+(m===item.motivo?'selected':'')+'>'+m+'</option>'; });
        } catch(e){ console.log('Erro ao carregar motivos:', e); }

        document.getElementById('crudTitle').textContent = 'Editar #' + currentId;
        document.getElementById('crudBody').innerHTML = 
            '<div class="cfr"><div class="cf"><label>ID</label><input value="'+currentId+'" disabled></div>'+
            '<div class="cf"><label>Status</label><select id="xStatus"><option '+(item.statusNorm!=='Fechado'?'selected':'')+'>Em Aberto</option><option '+(item.statusNorm==='Fechado'?'selected':'')+'>Concluído</option></select></div></div>'+
            '<div class="cfr"><div class="cf"><label>Analista</label><select id="xAnalista"><option value="">-</option><option '+(item.analista==='André'?'selected':'')+'>André</option><option '+(item.analista==='Fabiana'?'selected':'')+'>Fabiana</option><option '+(item.analista==='Larissa'?'selected':'')+'>Larissa</option><option '+(item.analista==='Ricardo'?'selected':'')+'>Ricardo</option><option '+(item.analista==='Roberta'?'selected':'')+'>Roberta</option><option '+(item.analista==='Thiago'?'selected':'')+'>Thiago</option></select></div>'+
            '<div class="cf"><label>FCR</label><select id="xFCR"><option '+(item.fcr==='Sim'?'selected':'')+'>Sim</option><option '+(item.fcr!=='Sim'?'selected':'')+'>Não</option></select></div></div>'+
            '<div class="cf"><label>Motivo</label><select id="xMotivo"><option value="">-</option>'+motivos+'</select></div>'+
            '<div class="cf"><label>Sub Classificação</label><input id="xSub" value="'+(item.sub||'').replace(/"/g,'')+'"></div>'+
            '<div class="cf"><label>Solicitante</label><input id="xSolic" value="'+(item.solicitante||'').replace(/"/g,'')+'"></div>'+
            '<div class="cfr"><div class="cf"><label>Data Início</label><input type="date" id="xDtI" value="'+fmtDt(item.dtStart)+'"></div>'+
            '<div class="cf"><label>Data Fim</label><input type="date" id="xDtF" value="'+fmtDt(item.dtEnd)+'"></div></div>'+
            '<div class="cf"><label>Descrição</label><textarea id="xDesc" rows="2">'+(item.descricao||'')+'</textarea></div>';
        document.getElementById('crudFoot').innerHTML = 
            '<button class="cbtn cbtn-cancel" onclick="fecharCrud()">Cancelar</button>'+
            '<button class="cbtn cbtn-save" id="xSave" onclick="window.salvarReg()">Salvar</button>';
        abrir();
    };

    // =====================================================================
    // SALVAR (UPDATE)
    // =====================================================================
    window.salvarReg = async function() {
        var btn = document.getElementById('xSave');
        btn.disabled = true; 
        btn.textContent = 'Salvando...';

        try {
            var statusVal = document.getElementById('xStatus').value;
            var dataFimVal = document.getElementById('xDtF').value;
            if (statusVal === 'Concluído' && !dataFimVal) {
                dataFimVal = new Date().toISOString().split('T')[0];
            }

            var payload = {
                "acao": "UPDATE",
                "id_registro": parseInt(currentId, 10),
                "status": statusVal === 'Concluído' ? 'Concluído' : 'Em Aberto',
                "dataInicio": document.getElementById('xDtI').value || null,
                "dataFim": dataFimVal || null,
                "fcr": document.getElementById('xFCR') ? document.getElementById('xFCR').value : null,
                "analista": document.getElementById('xAnalista').value || null,
                "motivo": document.getElementById('xMotivo').value || null,
                "subClassificacao": document.getElementById('xSub').value || null,
                "cnpj": null,
                "razaoSocial": null,
                "tipoAtendimento": null,
                "origemContato": null,
                "gn": null,
                "solicitante": document.getElementById('xSolic').value || null,
                "areaResponsavelResolucao": null,
                "detalhes": document.getElementById('xDesc').value || null
            };

            console.log('>>> ENVIANDO UPDATE:', JSON.stringify(payload, null, 2));

            var response = await fetch(POWER_AUTOMATE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('>>> Response Status:', response.status);

            if (response.ok) {
                showToast('Registro atualizado com sucesso!', 'success');
                fecharCrud();
                setTimeout(function() { 
                    if (window.chamarApi) chamarApi(); 
                    applyAllFilters(); 
                }, 500);
            } else {
                var erroTxt = await response.text();
                throw new Error('Erro ' + response.status + ': ' + erroTxt);
            }

        } catch (error) {
            console.error('>>> Erro ao salvar:', error);
            showToast('Erro ao salvar: ' + error.message, 'error');
        } finally {
            btn.disabled = false; 
            btn.textContent = 'Salvar';
        }
    };

    // =====================================================================
    // EXCLUIR
    // =====================================================================
    window.excluirReg = function(id, evt) {
        if (evt) { evt.preventDefault(); evt.stopPropagation(); }
        console.log('EXCLUIR clicado, ID:', id);
        currentId = parseInt(id);
        if (isNaN(currentId)) { alert('ID inválido'); return; }

        var tr = evt ? evt.target.closest('tr') : null;
        var solicitante = '-';
        if (tr) {
            var cells = tr.querySelectorAll('td');
            if (cells.length > 8) solicitante = cells[8].textContent || '-';
        }

        document.getElementById('crudTitle').textContent = 'Excluir Registro';
        document.getElementById('crudBody').innerHTML = 
            '<p style="text-align:center;color:#FF4757;font-size:16px;">'+
            '<i class="fa-solid fa-triangle-exclamation" style="font-size:48px;margin-bottom:15px;display:block;"></i>'+
            'Tem certeza que deseja excluir o registro <strong>#'+currentId+'</strong>?<br>'+
            '<small style="color:#666;">'+solicitante+'</small></p>';
        document.getElementById('crudFoot').innerHTML = 
            '<button class="cbtn cbtn-cancel" onclick="fecharCrud()">Cancelar</button>'+
            '<button class="cbtn cbtn-del" id="xDel" onclick="window.confirmarDel()">Excluir</button>';
        abrir();
    };

    // =====================================================================
    // CONFIRMAR EXCLUSÃO (DELETE)
    // =====================================================================
    window.confirmarDel = async function() {
        var btn = document.getElementById('xDel');
        btn.disabled = true; 
        btn.textContent = 'Excluindo...';

        try {
            var payload = {
                "acao": "DELETE",
                "id_registro": parseInt(currentId, 10)
            };

            console.log('>>> ENVIANDO DELETE:', JSON.stringify(payload, null, 2));

            var response = await fetch(POWER_AUTOMATE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('>>> Response Status:', response.status);

            if (response.ok) {
                if (window.RAW) {
                    window.RAW = window.RAW.filter(function(r) { 
                        return parseInt(r.id || r.ID || r.Id || r.uid) !== currentId;
                    });
                }
                if (window.FILTERED) {
                    window.FILTERED = window.FILTERED.filter(function(r) { 
                        return parseInt(r.id || r.ID || r.Id || r.uid) !== currentId;
                    });
                }
                showToast('Registro excluído com sucesso!', 'success');
                fecharCrud();
                if (window.applyAllFilters) applyAllFilters();
                setTimeout(function() { 
                    if (window.chamarApi) chamarApi(); 
                }, 800);
            } else {
                var erroTxt = await response.text();
                throw new Error('Erro ' + response.status + ': ' + erroTxt);
            }

        } catch (error) {
            console.error('>>> Erro ao excluir:', error);
            showToast('Erro ao excluir: ' + error.message, 'error');
        } finally {
            btn.disabled = false; 
            btn.textContent = 'Excluir';
        }
    };

    // Fechar com ESC e clique fora
    document.addEventListener('keydown', function(e){ if(e.key==='Escape') fecharCrud(); });
    if (document.getElementById('crudModal')) {
        document.getElementById('crudModal').addEventListener('click', function(e){ if(e.target===this) fecharCrud(); });
    }
    console.log('✅ CRUD SharePoint carregado!');

})();




</script>

<div class="modal-inserir-overlay" id="modalInserirOverlay" role="dialog" aria-label="Inserir novo registro" aria-hidden="true">
    <div class="modal-inserir">
        <div class="modal-inserir-header">
            <div class="modal-inserir-title">
                <i class="fa-solid fa-file-circle-plus"></i>
                Inserir Novo Registro
            </div>
            <button class="modal-inserir-close" onclick="closeModalInserir()" aria-label="Fechar">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="modal-inserir-body">
            <form id="formInserirRegistro" onsubmit="return false;">
                <div class="form-inserir-grid">
                    <div class="form-group">
                        <label>Data Início <span class="required">*</span></label>
                        <input type="date" id="insertDataInicio" required>
                        <span class="error-message">Campo obrigatório</span>
                    </div>
                    <div class="form-group">
                        <label>Data Fim</label>
                        <input type="date" id="insertDataFim">
                    </div>
                    <div class="form-group full-width">
                        <label>CNPJ <span class="required">*</span></label>
                        <div class="cnpj-input-wrapper">
                            <input type="text" id="insertCNPJ" placeholder="00.000.000/0000-00" maxlength="18" required>
                            <button type="button" class="btn-buscar-cnpj" onclick="buscarCNPJ()" id="btnBuscarCNPJ"><i class="fa-solid fa-search"></i> Buscar</button>
                        </div>
                        <span class="error-message">CNPJ inválido</span>
                        <div class="cnpj-result" id="cnpjResult"><div id="cnpjResultInfo"></div></div>
                    </div>
                    <div class="form-group">
                        <label>Razão Social <span class="required">*</span></label>
                        <input type="text" id="insertRazaoSocial" placeholder="Automático" required>
                        <span class="error-message">Campo obrigatório</span>
                    </div>
                    <div class="form-group">
                        <label>Analista <span class="required">*</span></label>
                        <select id="insertAnalista" required>
                            <option value="">Selecione...</option>
                            <option value="André">André</option>
                            <option value="Fabiana">Fabiana</option>
                            <option value="Larissa">Larissa</option>
                            <option value="Ricardo">Ricardo</option>
                            <option value="Roberta">Roberta</option>
                            <option value="Thiago">Thiago</option>
                        </select>
                        <span class="error-message">Selecione</span>
                    </div>
                    <div class="form-group">
                        <label>Motivo <span class="required">*</span></label>
                        <div class="searchable-dropdown" id="motivoDropdownContainer">
                            <input type="text" class="searchable-dropdown-input" id="insertMotivoInput" placeholder="Digite para buscar motivo..." autocomplete="off">
                            <input type="hidden" id="insertMotivo">
                            <div class="searchable-dropdown-list" id="motivoDropdownList"></div>
                        </div>
                        <span class="error-message">Selecione um motivo</span>
                    </div>
                    <div class="form-group">
                        <label>Sub Classificação</label>
                        <select id="insertSubClassificacao">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>GN</label>
                        <div class="searchable-dropdown" id="gnDropdownContainer">
                            <input type="text" class="searchable-dropdown-input" id="insertGNInput" placeholder="Digite para buscar GN..." autocomplete="off">
                            <input type="hidden" id="insertGN">
                            <div class="searchable-dropdown-list" id="gnDropdownList"><div class="searchable-dropdown-item" data-value="Gerência_Negócio">Gerência_Negócio</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Ribeirao Preto">G.N. Urbano Ribeirao Preto</div>
<div class="searchable-dropdown-item" data-value="G.N. Rodovia Ribeirao Preto">G.N. Rodovia Ribeirao Preto</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Sp Oeste">G.N. Urbano Sp Oeste</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Rio De Janeiro">G.N. Urbano Rio De Janeiro</div>
<div class="searchable-dropdown-item" data-value="G.N. Rodovia Curitiba">G.N. Rodovia Curitiba</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Florianopolis">G.N. Urbano Florianopolis</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Londrina">G.N. Urbano Londrina</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Campinas">G.N. Urbano Campinas</div>
<div class="searchable-dropdown-item" data-value="G.N. Rodovia Goiania">G.N. Rodovia Goiania</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Sp Abc">G.N. Urbano Sp Abc</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Passo Fundo">G.N. Urbano Passo Fundo</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Porto Alegre">G.N. Urbano Porto Alegre</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Sao Jose Rio Preto">G.N. Urbano Sao Jose Rio Preto</div>
<div class="searchable-dropdown-item" data-value="G.N. Rodovia Rio De Janeiro">G.N. Rodovia Rio De Janeiro</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Curitiba">G.N. Urbano Curitiba</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Uberlandia">G.N. Urbano Uberlandia</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Goiania">G.N. Urbano Goiania</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Belo Horizonte">G.N. Urbano Belo Horizonte</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Sp Leste">G.N. Urbano Sp Leste</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Campo Grande">G.N. Urbano Campo Grande</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Recife">G.N. Urbano Recife</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Vitoria">G.N. Urbano Vitoria</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Fortaleza">G.N. Urbano Fortaleza</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Sao Luis">G.N. Urbano Sao Luis</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Belem">G.N. Urbano Belem</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Santa Maria">G.N. Urbano Santa Maria</div>
<div class="searchable-dropdown-item" data-value="G.N. Urbano Manaus">G.N. Urbano Manaus</div>
<div class="searchable-dropdown-item" data-value="G.N. Hipermercado">G.N. Hipermercado</div></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Solicitante <span class="required">*</span></label>
                        <div class="searchable-dropdown" id="solicitanteDropdownContainer">
                            <input type="text" class="searchable-dropdown-input" id="insertSolicitanteInput" placeholder="Digite para buscar solicitante..." autocomplete="off">
                            <input type="hidden" id="insertSolicitante">
                            <div class="searchable-dropdown-list" id="solicitanteDropdownList"><div class="searchable-dropdown-item" data-value="Solicitante">Solicitante</div>
<div class="searchable-dropdown-item" data-value="Revendedor">Revendedor</div>
<div class="searchable-dropdown-item" data-value="CT">CT</div>
<div class="searchable-dropdown-item" data-value="CN">CN</div>
<div class="searchable-dropdown-item" data-value="Torre">Torre</div>
<div class="searchable-dropdown-item" data-value="Automação">Automação</div></div>
                        </div>
                        <span class="error-message">Selecione o solicitante</span>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Contato <span class="required">*</span></label>
                        <select id="insertTipoContato" required>
                            <option value="">Selecione...</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Receptivo">Receptivo</option>
                        </select>
                        <span class="error-message">Selecione o tipo</span>
                    </div>
                    <div class="form-group">
                        <label>Origem do Contato <span class="required">*</span></label>
                        <select id="insertOrigemContato" required>
                            <option value="">Selecione...</option>
                            <option value="Telefone">Telefone</option>
                            <option value="E-mail">E-mail</option>
                            <option value="WhatsApp">WhatsApp</option>
                            <option value="Chat">Chat</option>
                            <option value="Presencial">Presencial</option>
                            <option value="Portal">Portal</option>
                            <option value="Outro">Outro</option>
                        </select>
                        <span class="error-message">Selecione a origem</span>
                    </div>
                    <div class="form-group">
                        <label>Área Responsável pela Resolução</label>
                        <select id="insertAreaResponsavel">
                            <option value="Torre de Expansão">Torre de Expansão</option>
                            <option value="Coord Produtos Digitais B2B">Coord Produtos Digitais B2B</option>
                            <option value="Coord. De Controladoria">Coord. De Controladoria</option>
                            <option value="Coord Incentivo Rede">Coord Incentivo Rede</option>
                            <option value="Parceiros Conecta">Parceiros Conecta</option>
                            <option value="KMV Pista">KMV Pista</option>
                            <option value="Engenharia TI">Engenharia TI</option>
                            <option value="Prevenção Fraudes">Prevenção Fraudes</option>
                            <option value="Revenda">Revenda</option>
                            <option value="Trade Marketing">Trade Marketing</option>
                            <option value="Consultor de Negócios">Consultor de Negócios</option>
                            <option value="KMV Caminhoneiro">KMV Caminhoneiro</option>
                            <option value="Central Pró-Frotas">Central Pró-Frotas</option>
                            <option value="Escola de Varejo">Escola de Varejo</option>
                            <option value="Jet Oil">Jet Oil</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>FCR (Resolução 1ª Chamada)</label>
                        <select id="insertFCR">
                            <option value="Não">Não</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Descrição <span class="required">*</span></label>
                        <textarea id="insertDescricao" placeholder="Descreva o atendimento realizado..." required></textarea>
                        <span class="error-message">Campo obrigatório</span>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-inserir-footer">
            <button type="button" class="btn-inserir-cancel" onclick="closeModalInserir()">
                <i class="fa-solid fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn-inserir-submit" id="btnSubmitRegistro" onclick="submitNovoRegistro()">
                <span class="spinner"></span>
                <span class="btn-text"><i class="fa-solid fa-paper-plane"></i> Enviar Registro</span>
            </button>
        </div>
    </div>
</div>

<!-- ALERT CENTER -->
<div class="alert-center" id="alertCenter"></div>

<!-- EXPORT MODAL -->
<div class="export-modal-overlay" id="exportModal" onclick="if(event.target===this)closeExportModal()">
    <div class="export-modal">
        <div class="export-modal-header">
            <div class="export-modal-title"><i class="fa-solid fa-file-export"></i> Exportar Relatório</div>
            <button onclick="closeExportModal()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="export-modal-body">
            <div class="export-options">
                <div class="export-option selected" onclick="selectExportOption(this,'excel')">
                    <div class="export-option-icon excel"><i class="fa-solid fa-file-excel"></i></div>
                    <div class="export-option-text"><h4>Excel com Filtros</h4><p>Exporta visão atual filtrada</p></div>
                </div>
                <div class="export-option" onclick="selectExportOption(this,'pdf')">
                    <div class="export-option-icon pdf"><i class="fa-solid fa-file-pdf"></i></div>
                    <div class="export-option-text"><h4>PDF Executivo</h4><p>Relatório com KPIs principais</p></div>
                </div>
            </div>
        </div>
        <div class="export-modal-footer">
            <button onclick="closeExportModal()" style="background:rgba(255,255,255,0.1);border:none;color:var(--text-secondary);padding:10px 20px;border-radius:8px;cursor:pointer;">Cancelar</button>
            <button onclick="executeExport()" style="background:var(--brand-blue);border:none;color:white;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;"><i class="fa-solid fa-download"></i> Exportar</button>
        </div>
    </div>
</div>



</body>
</html>